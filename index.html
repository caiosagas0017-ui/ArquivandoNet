<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logística Central - Controle de Caixas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- Animações e Estilos Globais --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-zoom-in { animation: zoomIn 0.2s ease-out; }
        
        @keyframes slideUpFade {
            0% { opacity: 0; transform: translate(-50%, 10px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -10px); }
        }
        .toast-msg { 
            animation: slideUpFade 3s ease-in-out forwards; 
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); z-index: 9999;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Sidebar e Drag & Drop */
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        .dragging { opacity: 0.5; transform: scale(0.98); }
        .drop-target { border-color: #3b82f6; background-color: #eff6ff; transform: scale(1.02); }

        /* Timeline */
        .timeline-line { position: absolute; left: 23px; top: 36px; bottom: -20px; width: 2px; background-color: #e2e8f0; z-index: 0; }
        .timeline-item:last-child .timeline-line { display: none; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 h-screen overflow-hidden selection:bg-blue-200">

    <!-- Login -->
    <div id="login-container" class="hidden h-full w-full bg-blue-50 flex items-center justify-center z-50 absolute top-0 left-0"></div>

    <!-- App Layout -->
    <div id="app-layout" class="flex h-screen w-full overflow-hidden hidden opacity-0 transition-opacity duration-300">
        
        <!-- SIDEBAR -->
        <aside id="main-sidebar" class="hidden md:flex flex-col bg-white border-r border-blue-100 h-full shadow-sm z-20 shrink-0 sidebar-transition w-64">
            <div class="p-4 border-b border-blue-50 flex items-center justify-between h-20">
                <div id="sidebar-logo-content" class="flex items-center gap-3 overflow-hidden whitespace-nowrap transition-opacity duration-200">
                    <div class="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-200 shrink-0">
                        <i data-lucide="package" class="text-white w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold tracking-tight text-blue-900 leading-tight">Logística</h1>
                        <p class="text-[10px] text-blue-500 font-medium uppercase tracking-wider">Painel</p>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="p-2 rounded-lg text-slate-400 hover:text-blue-600 hover:bg-blue-50 transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
            <nav class="flex-1 overflow-y-auto p-3 space-y-1 overflow-x-hidden" id="sidebar-nav"></nav>
            <div class="p-4 border-t border-blue-50 bg-slate-50/50" id="sidebar-footer"></div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50">
            <!-- Mobile Header -->
            <header class="md:hidden bg-white border-b border-blue-100 flex-shrink-0 z-30">
                <div class="px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <div class="bg-blue-600 p-1.5 rounded-lg"><i data-lucide="package" class="text-white w-5 h-5"></i></div>
                        <span class="font-bold text-blue-900">Logística</span>
                    </div>
                    <button onclick="logout()" class="text-slate-400 hover:text-red-600"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
                <div class="px-2 pb-2 overflow-x-auto no-scrollbar flex gap-2" id="mobile-nav"></div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" id="app-content"></main>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script>
        // --- 1. Utilitários ---
        function escapeHtml(text) {
            if (text === null || text === undefined) return "";
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function getLocalDateString(isoString) {
            if (!isoString) return '';
            try { return new Date(new Date(isoString).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0]; } catch (e) { return ''; }
        }

        function safeParse(key, fallbackValue) {
            try { return JSON.parse(localStorage.getItem(key)) || fallbackValue; } catch { return fallbackValue; }
        }

        function showToast(message, type = 'success') {
            const styles = type === 'success' ? 'bg-emerald-600 text-white shadow-emerald-200' : 'bg-rose-600 text-white shadow-rose-200';
            const icon = type === 'success' ? 'check' : 'alert-circle';
            const toast = document.createElement('div');
            toast.className = `toast-msg ${styles} text-sm font-medium py-2.5 px-4 rounded-full shadow-lg flex items-center gap-2 pointer-events-none`;
            toast.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i> ${message}`;
            document.body.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { if(toast.parentNode) toast.parentNode.removeChild(toast); }, 3000);
        }

        // --- 2. Estado ---
        const DEFAULT_DESTINOS = [
            { name: "Clínica Mult 1", street: "Av. Principal", number: "100", neighborhood: "Centro" },
            { name: "Clínica Mult 2", street: "Rua das Flores", number: "250", neighborhood: "Jardins" },
            { name: "Laboratório Novo", street: "Av. Industrial", number: "900", neighborhood: "Distrito" },
            { name: "CAMU", street: "Praça Central", number: "1", neighborhood: "Centro" }
        ];
        const DEFAULT_DRIVERS = [{ name: "João Silva", phone: "" }, { name: "Maria Oliveira", phone: "" }, { name: "Carlos Santos", phone: "" }];
        
        const DEFAULT_CATALOG = [
            "AÇUCAR SACHET UNIÃO", "AÇUCAR UNIÃO REFINADO", "ADOÇANTE ZERO CAL 100ML", "AGENDA DIARIA ESPIRAL", 
            "AGUA SANITARIA 2L", "ALCOOL 1L", "ALCOOL GEL 70% 800ML", "ALMOFADAP/CARIMBO Nº3 AZUL", 
            "ALMOFADAP/CARIMBO Nº3 PRETA", "ALMOFADAP/CARIMBO Nº3 VERMELHA", "APONTADOR COM LIXEIRA", "BOBINA SENHA ATENDIMENTO PAPEL TERMICO 80 MM", 
            "BOM AR 500ML", "BORRACHA TK PLASTICA PEQUENA", "CADERNO 1/4 BROC. C/DURA 96F", "CADERNO 1/4 BROC. INDICE A/Z 96F", 
            "CADERNO 1/4 BROC. PROTOCOLO 96F", "CADERNO UNIVERSITARIO 1X1 96F", "CAIXA ARQUIVO MORTO PAPELÃO", "CALCULADORA", 
            "CANETA BIC CRISTAL 1.6MM", "CANETA ESFEROGRAFICA AZUL", "CANETA ESFEROGRAFICA PILOT", "CANETA ESFEROGRAFICA PRETA", 
            "CANETA ESFEROGRAFICA VERMELHA", "CANETA MARCA TEXTO AMARELO", "CANETA MARCA TEXTO AZUL", "CANETA PARA QUADRO BRANCO AZUL", 
            "CANETA PARA QUADRO BRANCO PRETA", "CANETA PARA QUADRO BRANCO VERMELHA", "CANETA RETROPROJETOR 2.0 MM AZUL", "CANETA RETROPROJETOR 2.0 MM PRETA", 
            "CANETA RETROPROJETOR 2.0 MM VERMELHA", "CAPA P/ ENCADERNAÇÃO A4 PRETA", "CAPA P/ ENCADERNAÇÃO TRANSPARENTE", "CARTÃO PONTO MENSAL", 
            "CERA BRILHO FÁCIL 750 ML", "CHÁ MATTE", "CLIPS Nº 3", "CLIPS Nº 4", "CLIPS Nº8", "COLA BASTÃO 10G", "COLA TENAZ LIQ 40G", 
            "COPO DESCARTÁVEL 180 ML", "COPO DESCARTAVEL 50ML", "CORRETIVO FITA", "CORRETIVO PINCEL", "CORRETIVO TIPO CANETA", 
            "DECLARAÇÃO ATENDENTE CAMU BL 50F", "DECLARAÇÃO SESSÃO TERAPIA - ENDEREÇO MULTI", "DESINFETANTE 2L", "DETERGENTE LIQUIDO 500ML", 
            "ELASTICO SUPER RESISTENTE 1KG", "ENVELOPE A4 26X36", "ENVELOPE COMERCIAL JANELA 22X15,7CM PAPEL OFFSET", "ENVELOPE OFICIO C/JANELA", 
            "ENVELOPE OFICIO S/JANELA", "ENVELOPE PARDO 18,5X25", "ENVELOPE PARDO 31X41", "ESPONJA MAGICA", "ESPONJA SCOTH BRITE", 
            "EXTRATOR DE GRAMPOS", "FIBRA LIMPEZA LEVE", "FIBRA LIMPEZA USO GERAL", "FICHA C/PAUTA 5X8 100 FLS", "FILTRO DE PAPEL N°103", 
            "FILTRO REFIL ECO IBBL SPECIALE", "FITA ADESIVA PEQUENA", "FITA CREPE BRANCA", "FITA DUPLA FACE", "FITA LARGA TRANSPARENTE", 
            "FITA P/ MAQUINA DE CALCULAR", "FLANELA", "FLANELA BRANCA 38X58 GRANDE", "FOSFORO EXTRA LONGO", "GRAFITE 2B 0.5", 
            "GRAFITE 2B 0.7", "GRAMPEADOR MÉDIO", "GRAMPO 106/6 CX 5000UN", "GRAMPO 26/6 GALVANIZADO CX 5000 UM", "GRAMPO TRUNFO Nº2 CX COM 50 UM", 
            "GUIA DE COMPROVANTE PRESENCIAL", "INSETICIDA AEROSOL 300ML", "LAPIS PRETO FABER", "LAPISEIRA 0.5", "LAPISEIRA 0.7", 
            "LEITE SEMI DESNATADO", "LIMPADOR MULTIUSO DESTAC", "LIMPADOR SAPOLIO 300ML", "LIMPADOR VEJA MULTI USO 500ML", "LIVRO ATA 100 FLS", 
            "LIXEIRA DE ESCRITORIO", "LUSTRA MOVEIS 500ML", "LUVA LIMPEZA SANRO TOP M", "MARGARINA 500G", "MEXEDOR PARA CAFÉ 500UN", 
            "OLEO DE PEROBA 100ML", "PANO DE CHÃO SACO ALVEJADO", "PANO PERFEX", "PAPEL CARBONO FILME PRETO", "PAPEL HIGIÊNICO 300MT", 
            "PAPEL HIGIÊNICO 4ROLOS", "PAPEL INTERFOLHAS C/700", "PAPEL OPALINE 180G PCT 50 UM", "PAPEL SULFITE A4 BRANCO 500 FLS", 
            "PASTA A/Z LOMBO ESTREITO", "PASTA A/Z LOMBO LARGO", "PASTA A4 PLÁSTICA C/PRESILHA TRANSPARENTE", "PASTA CATÁLOGO C/100 PLASTICO", 
            "PASTA GRANDE COM ABA E ELASTICO TRANSPARENTE", "PASTA L A4 TRANSPARENTE", "PASTA POLIONDAS LOMBADA VERDE", "PASTA SANF. PLASTICA OFICIO 31DIV", 
            "PASTA SUSPENSA PLAST. MARM. COMPL", "PERCEVEJO C/100", "PILHA AAA", "PILHA GRANDE D", "PILHA PEQUENA AA", "PLASTICO RESISTENTE PASTA 04 FUROS", 
            "PO DE CAFÉ", "POST IT 100 FLS", "PROTOCOLO DE ENTREGA DE GUIAS", "RECIBO COMERCIAL BLOCO 50 FLS", "REFRESCO TANG", 
            "REGUA ACRILICA 30 CM", "RELATÓRIO TERAPEUTICO - LOGO UNIMED - SEM ENDEREÇO", "REMOVEDOR DE CERA 1L", "RODO COM CABO", "SABÃO EM PÓ", 
            "SABÃO EM PEDRA 5UN", "SABONETE LIQUIDO ERVA DOCE 800ML", "SACO DE LIXO 100L", "SACO DE LIXO 200L", "SACO DE LIXO 20L", "SACO DE LIXO 40L", 
            "SADT BLOCO 100 FOLHAS", "TELEFONE COM FIO PRETO", "TESOURA ESCOLAR 20CM", "TINTA P/CARIMBO AZUL", "TINTA P/CARIMBO PRETA", 
            "TINTA P/CARIMBO VERMELHA", "TOALHA DE PAPEL snog", "TONER 83A", "TONER 85A", "VASSOURA"
        ].sort();

        const INITIAL_BOXES = [1,2,3,4].map(id => ({ id, name: `Caixa ${id}`, status: 'available', items: [], destination: null, driver: null }));

        // Lógica de Inicialização: Se o catálogo estiver vazio no localStorage, usa o DEFAULT_CATALOG
        const storedCatalog = safeParse('logistica_catalog', []);
        const initialCatalog = (storedCatalog.length > 0) ? storedCatalog : DEFAULT_CATALOG;

        let state = {
            isLoggedIn: localStorage.getItem('logistica_auth') === 'true',
            boxes: safeParse('logistica_boxes', INITIAL_BOXES),
            history: safeParse('logistica_history', []),
            missingItems: safeParse('logistica_missing', []),
            destinations: safeParse('logistica_destinations', DEFAULT_DESTINOS),
            drivers: safeParse('logistica_drivers', DEFAULT_DRIVERS),
            catalog: initialCatalog,
            activeTab: localStorage.getItem('logistica_activeTab') || 'dashboard',
            currentUser: localStorage.getItem('logistica_currentUser') || "Logistica",
            modal: { type: null, boxId: null, data: null },
            historyFilter: { search: '', date: '' },
            historyView: 'today',
            expandedDate: null,
            sidebarCollapsed: safeParse('logistica_sidebar_collapsed', false),
            dragSourceIndex: null,
            missingTab: 'pending',
            missingDateFilter: '' // Novo filtro de data para faltas
        };

        // --- 3. Autenticação & Persistência ---
        function handleLogin(e) {
            e.preventDefault();
            if (e.target.password.value === '1234') {
                state.isLoggedIn = true; localStorage.setItem('logistica_auth', 'true'); renderApp();
            } else { showToast("Senha Incorreta", "error"); }
        }
        function logout() { state.isLoggedIn = false; localStorage.removeItem('logistica_auth'); renderApp(); }
        
        function saveData(skipRender = false) {
            localStorage.setItem('logistica_boxes', JSON.stringify(state.boxes));
            localStorage.setItem('logistica_history', JSON.stringify(state.history));
            localStorage.setItem('logistica_missing', JSON.stringify(state.missingItems));
            localStorage.setItem('logistica_destinations', JSON.stringify(state.destinations));
            localStorage.setItem('logistica_drivers', JSON.stringify(state.drivers));
            localStorage.setItem('logistica_catalog', JSON.stringify(state.catalog));
            localStorage.setItem('logistica_activeTab', state.activeTab);
            localStorage.setItem('logistica_sidebar_collapsed', JSON.stringify(state.sidebarCollapsed));
            if (!skipRender) renderApp();
        }

        function addHistoryLog(action, details, boxName) {
            state.history.unshift({ id: Date.now(), timestamp: new Date().toISOString(), action, details, boxName, user: state.currentUser });
        }

        // --- 4. Ações de Backup ---
        function handleExportBackup() {
            const dataStr = JSON.stringify(state);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            showToast("Backup gerado!", "success");
        }
        
        function handleImportBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    state.pendingImport = data; 
                    openModal('confirmImport');
                } catch { showToast("Arquivo inválido", "error"); }
            };
            reader.readAsText(file);
        }

        function executeImport() {
            if (state.pendingImport) {
                state = { ...state, ...state.pendingImport, isLoggedIn: true };
                state.pendingImport = null;
                saveData(); 
                closeModal();
                showToast("Dados restaurados com sucesso!", "success");
            }
        }

        // --- 5. Drag & Drop ---
        function enableDrag(e, idx) { document.getElementById(`card-${idx}`).setAttribute('draggable', 'true'); }
        function disableDrag(e, idx) { document.getElementById(`card-${idx}`).setAttribute('draggable', 'false'); }
        function handleDragStart(e, idx) { state.dragSourceIndex = idx; e.target.classList.add('dragging'); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target')); }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnter(e) { 
            const card = e.target.closest('.group\\/card-container');
            if (card && parseInt(card.dataset.index) !== state.dragSourceIndex) card.classList.add('drop-target');
        }
        function handleDragLeave(e) {
            const card = e.target.closest('.group\\/card-container');
            if (card) card.classList.remove('drop-target');
        }
        function handleDrop(e, targetIndex) {
            e.preventDefault();
            if (state.dragSourceIndex !== null && state.dragSourceIndex !== targetIndex) {
                const item = state.boxes.splice(state.dragSourceIndex, 1)[0];
                state.boxes.splice(targetIndex, 0, item);
                saveData();
                showToast("Ordem das caixas atualizada!", "success");
            }
        }

        // --- 6. Handlers de Negócio (Caixas e Itens) ---
        
        function handleInputSearch(input) {
            const val = input.value.toLowerCase();
            const list = document.getElementById('suggestions-list');
            if (!list) return;
            
            if (!val) {
                list.classList.add('hidden');
                return;
            }

            const matches = state.catalog.filter(item => item.toLowerCase().includes(val));
            
            if (matches.length === 0) {
                list.classList.add('hidden');
                return;
            }
            
            list.innerHTML = matches.map(item => `
                <li onclick="selectItem('${escapeHtml(item)}')" class="px-4 py-2.5 hover:bg-blue-50 cursor-pointer text-sm text-slate-700 transition-colors flex items-center gap-2 border-b border-slate-50 last:border-0">
                    <i data-lucide="package" class="w-3.5 h-3.5 text-blue-300"></i> ${escapeHtml(item)}
                </li>
            `).join('');
            
            list.classList.remove('hidden');
            lucide.createIcons();
        }

        function selectItem(val) {
            const input = document.querySelector('input[name="itemName"]');
            if(input) {
                input.value = val;
                document.getElementById('suggestions-list').classList.add('hidden');
                input.focus();
            }
        }

        function handleAddItem(e) {
            e.preventDefault();
            const form = e.target;
            const itemName = form.itemName.value.trim();
            const quantity = parseInt(form.quantity.value);
            const unitType = form.unitType.value;
            const isExternal = form.isExternal.checked;
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            
            if (!itemName) { showToast("Digite o nome do item.", "error"); return; }

            // VALIDAÇÃO DE CATÁLOGO: Impede criação de novos itens aqui
            const itemExistsInCatalog = state.catalog.some(c => c.toLowerCase() === itemName.toLowerCase());
            if (!itemExistsInCatalog) {
                showToast("Item não encontrado no catálogo. Cadastre-o primeiro na aba Catálogo.", "error");
                return;
            }

            if (quantity < 1) { showToast("Quantidade inválida.", "error"); return; }

            if (box) {
                const existing = box.items.find(i => i.name.toLowerCase() === itemName.toLowerCase() && i.isExternal === isExternal && i.unitType === unitType);
                if (existing) existing.quantity += quantity;
                else box.items.push({ name: itemName, quantity, isExternal, unitType });
                
                addHistoryLog('Adição', `Adicionado ${quantity} ${unitType} de ${itemName}`, box.name);
                showToast("Item adicionado com sucesso!", "success");
                
                // Salvar dados e atualizar dashboard no fundo
                saveData(); 
                
                // Limpar campos para próxima inserção em vez de fechar
                form.itemName.value = '';
                form.quantity.value = '1';
                form.isExternal.checked = false;
                form.itemName.focus(); // Focar novamente no nome para agilidade
                const suggestions = document.getElementById('suggestions-list');
                if (suggestions) suggestions.classList.add('hidden');
            }
        }

        // --- NOVO: Handler para Atualizar Item ---
        function handleUpdateItem(e) {
            e.preventDefault();
            const form = e.target;
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            const itemIndex = state.modal.data;
            const item = box.items[itemIndex];

            if (!box || !item) return;

            const newName = form.itemName.value.trim();
            const newQuantity = parseInt(form.quantity.value);
            const newUnit = form.unitType.value;
            const newIsExternal = form.isExternal.checked;

            if (!newName) { showToast("Nome inválido.", "error"); return; }
            if (newQuantity < 1) { showToast("Quantidade inválida.", "error"); return; }

            // Atualiza o item
            item.name = newName;
            item.quantity = newQuantity;
            item.unitType = newUnit;
            item.isExternal = newIsExternal;

            addHistoryLog('Alteração', `Item editado: ${newName} (${newQuantity}${newUnit})`, box.name);
            saveData();
            closeModal();
            showToast("Item atualizado com sucesso!", "success");
        }

        function handleDelivery(e) {
            e.preventDefault();
            const form = e.target;
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            let dest = form.destination.value;
            
            if (form.customName && form.customName.value) {
                dest = form.customName.value;
                state.destinations.push({ name: dest, street: form.customStreet.value, number: form.customNumber.value, neighborhood: form.customNeighborhood.value });
            }

            if (!dest) { showToast("Selecione um destino.", "error"); return; }
            if (!form.driver.value) { showToast("Selecione um motorista.", "error"); return; }

            if (box) {
                box.status = 'in_delivery'; box.destination = dest; box.driver = form.driver.value;
                const itemsStr = box.items.map(i => `${i.quantity}${i.unitType} ${i.name}`).join(', ');
                addHistoryLog('Saída', `Saiu para entrega em: ${dest} (Mot: ${box.driver})\nConteúdo: ${itemsStr}`, box.name);
                showToast("Saída registrada com sucesso!", "success"); closeModal(); saveData();
            }
        }

        function handleCompleteDelivery() {
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            if(box) { 
                box.status = 'delivered'; 
                addHistoryLog('Entrega', `Entregue em: ${box.destination}`, box.name); 
                saveData(); closeModal(); 
                showToast("Entrega confirmada com sucesso!", "success");
            }
        }

        function handleResetBox() {
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            if(box) { 
                box.status = 'available'; box.items = []; box.destination = null; box.driver = null; 
                addHistoryLog('Status', 'Caixa esvaziada', box.name); 
                saveData(); closeModal(); 
                showToast("Caixa esvaziada e disponível!", "success");
            }
        }

        function handleAddBox(e) {
            e.preventDefault();
            const name = e.target.boxName.value.trim();
            if (!name) { showToast("Digite o nome da caixa.", "error"); return; }
            state.boxes.push({ id: Date.now(), name, status: 'available', items: [] });
            addHistoryLog('Criação', `Nova caixa: ${name}`, 'Sistema');
            saveData(); closeModal();
            showToast("Nova caixa criada!", "success");
        }
        
        function handleEditBox(e) {
            e.preventDefault();
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            const newName = e.target.boxName.value.trim();
            if (box && newName) { 
                box.name = newName; 
                saveData(); closeModal(); 
                showToast("Nome da caixa atualizado!", "success");
            }
        }

        function confirmDeleteBox() {
            const idx = state.boxes.findIndex(b => b.id === state.modal.boxId);
            if (idx > -1) { 
                state.boxes.splice(idx, 1); 
                saveData(); closeModal(); 
                showToast("Caixa removida com sucesso!", "success");
            }
        }
        
        function confirmDeleteItem() {
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            if (box) { 
                box.items.splice(state.modal.data, 1); 
                saveData(); closeModal(); 
                showToast("Item removido!", "success");
            }
        }

        function handleReportMissing(e) {
            e.preventDefault();
            const form = e.target;
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            const itemName = form.itemName.value.trim();

            // VALIDAÇÃO DE CATÁLOGO: Impede registro de itens fora do catálogo
            const itemExistsInCatalog = state.catalog.some(c => c.toLowerCase() === itemName.toLowerCase());
            if (!itemExistsInCatalog) {
                showToast("Item não encontrado no catálogo. Selecione um item válido.", "error");
                return;
            }

            state.missingItems.unshift({ 
                id: Date.now(), boxId: box.id, boxName: box.name, destination: box.destination || "N/A", 
                itemName: itemName, quantity: form.quantity.value, 
                reason: form.reason.value, status: 'pending', date: new Date().toISOString() 
            });
            if (box.status === 'delivered') box.status = 'issue';
            addHistoryLog('Falta', `Falta: ${itemName}`, box.name);
            
            // Salvar sem fechar o modal
            saveData(); 
            
            showToast("Falta registrada com sucesso!", "success");

            // Limpar campos para próxima inserção
            form.itemName.value = '';
            form.quantity.value = '';
            form.reason.value = '';
            form.itemName.focus(); // Focar novamente no nome
            
            // Esconder lista de sugestões se estiver aberta
            const suggestions = document.getElementById('suggestions-list');
            if (suggestions) suggestions.classList.add('hidden');
        }

        // --- 7. Handlers Adicionais (Gestão de Dados) ---
        
        function handleChangeDestination(e) {
            e.preventDefault();
            const form = e.target;
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            let dest = form.destination.value;
            if (form.customName && form.customName.value) {
                dest = form.customName.value;
                state.destinations.push({ name: dest, street: form.customStreet.value, number: form.customNumber.value, neighborhood: form.customNeighborhood.value });
            }
            if (box && dest) {
                box.destination = dest;
                addHistoryLog('Alteração', `Destino atualizado para: ${dest}`, box.name);
                saveData(); closeModal(); showToast("Destino atualizado!", "success");
            }
        }

        function handleChangeDriver(e) {
            e.preventDefault();
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            if (box) {
                box.driver = e.target.newDriver.value || null;
                addHistoryLog('Alteração', `Motorista alterado`, box.name);
                saveData(); closeModal(); showToast("Motorista atualizado!", "success");
            }
        }

        function handleAddDestination(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.newName.value.trim();
            if(!name) return;
            state.destinations.push({ name, street: form.newStreet.value, number: form.newNumber.value, neighborhood: form.newNeighborhood.value });
            saveData(); showToast("Endereço cadastrado!", "success");
            form.reset();
        }

        function handleAddDriver(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.newDriverName.value.trim();
            if(!name) return;
            state.drivers.push({ name, phone: form.newDriverPhone.value });
            saveData(); showToast("Motorista cadastrado!", "success");
            form.reset();
        }

        // --- Handlers para Catálogo ---
        function handleAddCatalogItem(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.newItemName.value.trim();
            if (!name) return;
            if (state.catalog.some(i => i.toLowerCase() === name.toLowerCase())) {
                showToast("Este item já existe no catálogo.", "error");
                return;
            }
            state.catalog.push(name);
            state.catalog.sort((a, b) => a.localeCompare(b));
            saveData(); showToast("Item adicionado ao catálogo!", "success");
            form.reset();
            renderCatalogPanel(); // Re-render to show new item
        }

        function confirmDeleteCatalogItem() {
            state.catalog.splice(state.modal.data, 1);
            saveData(); closeModal(); showToast("Item removido do catálogo!", "success");
        }

        function handleEditDestination(e) {
            e.preventDefault();
            const idx = state.modal.data;
            const form = e.target;
            state.destinations[idx] = { name: form.editName.value, street: form.editStreet.value, number: form.editNumber.value, neighborhood: form.editNeighborhood.value };
            saveData(); closeModal(); showToast("Endereço atualizado!", "success");
        }

        function handleEditDriver(e) {
            e.preventDefault();
            const idx = state.modal.data;
            state.drivers[idx] = { name: e.target.editDriverName.value, phone: e.target.editDriverPhone.value };
            saveData(); closeModal(); showToast("Motorista atualizado!", "success");
        }

        function confirmDeleteLocation() {
            state.destinations.splice(state.modal.data, 1);
            saveData(); closeModal(); showToast("Endereço removido!", "success");
        }

        function confirmDeleteDriver() {
            state.drivers.splice(state.modal.data, 1);
            saveData(); closeModal(); showToast("Motorista removido!", "success");
        }

        function handleEditMissing(e) {
            e.preventDefault();
            const idx = state.modal.data;
            const form = e.target;
            state.missingItems[idx].itemName = form.editItemName.value;
            state.missingItems[idx].quantity = form.editQuantity.value;
            state.missingItems[idx].reason = form.editReason.value;
            saveData(); closeModal(); showToast("Registro de falta atualizado!", "success");
        }

        function confirmDeleteMissing() {
            state.missingItems.splice(state.modal.data, 1);
            saveData(); closeModal(); showToast("Registro removido!", "success");
        }

        function resolveMissingItem(id) {
            const item = state.missingItems.find(i => i.id === id);
            if(item) { 
                item.status = 'resolved'; 
                saveData(); 
                showToast("Item resolvido e arquivado!", "success"); 
            }
        }
        
        function setMissingTab(tab) {
            state.missingTab = tab;
            state.missingDateFilter = ''; // Limpar filtro ao mudar de aba
            renderApp();
        }

        function setMissingDateFilter(date) {
            state.missingDateFilter = date;
            renderApp();
        }

        function printSingleBoxMissing(boxId) {
             const items = state.missingItems.filter(m => m.boxId === boxId);
             if (!items.length) {
                 showToast("Não há faltas para esta caixa.", "error");
                 return;
             }

             const boxName = items[0].boxName;
             const destination = items[0].destination;
             
             const rows = items.map(m => `
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; color: #334155;">${new Date(m.date).toLocaleDateString('pt-BR')}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: bold; color: #c0392b;">${m.quantity}x ${escapeHtml(m.itemName)}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-style: italic; color: #64748b;">${escapeHtml(m.reason || '-')}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 11px;">${m.status === 'resolved' ? '<span style="color:green">Resolvido</span>' : '<span style="color:red">Pendente</span>'}</td>
                </tr>
             `).join('');

             const contentHtml = `
                <div style="border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden;">
                    <div style="background-color: #f1f5f9; padding: 15px; border-bottom: 1px solid #cbd5e1;">
                        <h2 style="margin:0; font-size: 18px; color: #0f172a;">${escapeHtml(boxName)}</h2>
                        <p style="margin:5px 0 0 0; font-size: 14px; color: #475569;">Destino: <strong>${escapeHtml(destination)}</strong></p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background-color: #ffffff; text-align: left; border-bottom: 1px solid #e2e8f0;">
                                <th style="padding: 10px; width: 90px; color: #64748b;">Data</th>
                                <th style="padding: 10px; color: #64748b;">Item Faltante</th>
                                <th style="padding: 10px; color: #64748b;">Motivo/Obs</th>
                                <th style="padding: 10px; width: 80px; color: #64748b;">Status</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;

             const html = `<html><head><title>Faltas - ${escapeHtml(boxName)}</title><style>body{font-family:sans-serif;padding:30px;color:#1e293b;} @media print{.no-print{display:none}}</style></head><body><h1>Relatório de Faltas - Caixa Individual</h1>${contentHtml}<script>window.onload=()=>{window.print()}<\/script></body></html>`;
             
             const win = window.open('', '_blank');
             if(win) { win.document.write(html); win.document.close(); }
             else { showToast("Pop-up bloqueado.", "error"); }
        }

        // --- 8. Renderização (Views & Components) ---

        function renderModal() {
            const container = document.getElementById('modal-container');
            const { type, boxId, data } = state.modal;
            
            if (!type) { container.innerHTML = ''; return; }

            const box = state.boxes.find(b => b.id === boxId);
            let content = '';
            
            if (type === 'add') {
                content = `
                    <h3 class="text-lg font-bold mb-4">Adicionar Item em ${box.name}</h3>
                    <form onsubmit="handleAddItem(event)" class="space-y-5">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-slate-700">Nome do Item</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="search" class="h-4 w-4 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                                </div>
                                <input 
                                    name="itemName" 
                                    type="text" 
                                    class="pl-10 block w-full rounded-lg border-slate-300 border focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm p-2.5 transition-all outline-none" 
                                    placeholder="Buscar no catálogo..." 
                                    autocomplete="off"
                                    oninput="handleInputSearch(this)"
                                    onfocus="handleInputSearch(this)"
                                    autofocus required
                                >
                                <ul id="suggestions-list" class="absolute z-50 w-full bg-white border border-slate-100 rounded-lg shadow-xl mt-1 max-h-48 overflow-y-auto hidden divide-y divide-slate-50"></ul>
                            </div>
                            <p class="text-[10px] text-slate-400">Obrigatório selecionar um item existente no catálogo.</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Quantidade</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="hash" class="h-4 w-4 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                                    </div>
                                    <input type="number" name="quantity" value="1" min="1" class="pl-10 block w-full rounded-lg border-slate-300 border focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm p-2.5 transition-all outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Unidade</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="scale" class="h-4 w-4 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                                    </div>
                                    <select name="unitType" class="pl-10 block w-full rounded-lg border-slate-300 border focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm p-2.5 transition-all outline-none bg-white">
                                        <option value="un">Unidade</option>
                                        <option value="fd">Fardo</option>
                                        <option value="cx">Caixa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <input type="checkbox" name="isExternal" id="isExt" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="isExt" class="text-sm font-medium text-slate-700 cursor-pointer flex items-center gap-2">
                                <i data-lucide="package-open" class="w-4 h-4 text-slate-400"></i>
                                Item fora da caixa (Externo)
                            </label>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-bold shadow-md shadow-blue-100 transition-all active:scale-95 flex items-center justify-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> Adicionar Item
                        </button>
                    </form>`;
            } else if (type === 'editItem') {
                const itemToEdit = box.items[data];
                content = `
                    <h3 class="text-lg font-bold mb-4">Editar Item</h3>
                    <form onsubmit="handleUpdateItem(event)" class="space-y-5">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-slate-700">Nome do Item</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="pencil" class="h-4 w-4 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                                </div>
                                <input 
                                    name="itemName" 
                                    type="text" 
                                    value="${escapeHtml(itemToEdit.name)}"
                                    class="pl-10 block w-full rounded-lg border-slate-300 border focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm p-2.5 transition-all outline-none" 
                                    required
                                >
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Quantidade</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="hash" class="h-4 w-4 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                                    </div>
                                    <input type="number" name="quantity" value="${itemToEdit.quantity}" min="1" class="pl-10 block w-full rounded-lg border-slate-300 border focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm p-2.5 transition-all outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Unidade</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="scale" class="h-4 w-4 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                                    </div>
                                    <select name="unitType" class="pl-10 block w-full rounded-lg border-slate-300 border focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm p-2.5 transition-all outline-none bg-white">
                                        <option value="un" ${itemToEdit.unitType === 'un' ? 'selected' : ''}>Unidade</option>
                                        <option value="fd" ${itemToEdit.unitType === 'fd' ? 'selected' : ''}>Fardo</option>
                                        <option value="cx" ${itemToEdit.unitType === 'cx' ? 'selected' : ''}>Caixa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <input type="checkbox" name="isExternal" id="isExtEdit" ${itemToEdit.isExternal ? 'checked' : ''} class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="isExtEdit" class="text-sm font-medium text-slate-700 cursor-pointer flex items-center gap-2">
                                <i data-lucide="package-open" class="w-4 h-4 text-slate-400"></i>
                                Item fora da caixa (Externo)
                            </label>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-bold shadow-md shadow-blue-100 transition-all active:scale-95 flex items-center justify-center gap-2">
                            <i data-lucide="save" class="w-5 h-5"></i> Salvar Alterações
                        </button>
                    </form>`;
            } else if (type === 'deliver') {
                content = `
                    <h3 class="text-lg font-bold mb-4">Registrar Saída: ${box.name}</h3>
                    <form onsubmit="handleDelivery(event)" class="space-y-4">
                        <div id="dest-input-group">
                            <label class="block text-sm mb-1">Destino</label>
                            <select name="destination" class="w-full border p-2 rounded mb-2" onchange="document.getElementById('customDestGroup').classList.toggle('hidden', this.value !== '')">
                                <option value="" disabled selected>Selecione...</option>
                                ${state.destinations.map(d => `<option value="${d.name}">${d.name}</option>`).join('')}
                                <option value="">Outro (Digitar)</option>
                            </select>
                            <div id="customDestGroup" class="hidden space-y-2">
                                <input name="customName" placeholder="Nome do local" class="w-full border p-2 rounded bg-yellow-50">
                                <input name="customStreet" placeholder="Rua" class="w-full border p-2 rounded text-xs">
                                <div class="flex gap-2">
                                    <input name="customNumber" placeholder="Nº" class="w-1/3 border p-2 rounded text-xs">
                                    <input name="customNeighborhood" placeholder="Bairro" class="w-2/3 border p-2 rounded text-xs">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Motorista</label>
                            <select name="driver" class="w-full border p-2 rounded" required>
                                <option value="">Selecione...</option>
                                ${state.drivers.map(d => `<option value="${d.name}">${d.name}</option>`).join('')}
                            </select>
                        </div>
                        <div><label class="block text-sm mb-1">Data</label><input type="date" name="deliveryDate" value="${new Date().toISOString().split('T')[0]}" class="w-full border p-2 rounded"></div>
                        <button type="submit" class="w-full bg-green-600 text-white p-2 rounded">Confirmar Saída</button>
                    </form>`;
            } else if (type === 'complete') {
                content = `<h3 class="text-lg font-bold mb-4">Confirmar Entrega/Retorno</h3><p>Marcar ${box.name} como entregue?</p><div class="mt-4 flex gap-2"><button onclick="handleCompleteDelivery()" class="flex-1 bg-green-600 text-white p-2 rounded">Sim, Recebido</button><button onclick="closeModal()" class="flex-1 border p-2 rounded">Cancelar</button></div>`;
            } else if (type === 'reset') {
                content = `<h3 class="text-lg font-bold mb-4 text-red-600">Esvaziar Caixa</h3><p>Deseja esvaziar a <b>${box.name}</b> e torná-la disponível?</p><div class="mt-4 flex gap-2"><button onclick="handleResetBox()" class="flex-1 bg-red-600 text-white p-2 rounded">Sim, Resetar</button><button onclick="closeModal()" class="flex-1 border p-2 rounded">Cancelar</button></div>`;
            } else if (type === 'addBox') {
                content = `<h3 class="text-lg font-bold mb-4">Nova Caixa</h3><form onsubmit="handleAddBox(event)"><input name="boxName" placeholder="Nome da Caixa (Ex: Caixa 05)" class="w-full border p-2 rounded mb-4" required><button type="submit" class="w-full bg-blue-600 text-white p-2 rounded">Criar</button></form>`;
            } else if (type === 'deleteItem') {
                content = `<h3 class="font-bold mb-2">Remover Item</h3><p>Tem certeza?</p><div class="flex gap-2 mt-4"><button onclick="confirmDeleteItem()" class="bg-red-500 text-white px-4 py-2 rounded">Excluir</button><button onclick="closeModal()" class="border px-4 py-2 rounded">Cancelar</button></div>`;
            } else if (type === 'missing') {
                content = `
                    <div class="mb-6 text-center">
                        <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3 text-orange-600">
                            <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800">Reportar Falta</h3>
                        <p class="text-sm text-slate-500">Registre itens ausentes ou avariados na caixa <b>${escapeHtml(box.name)}</b>.</p>
                    </div>

                    <form onsubmit="handleReportMissing(event)" class="space-y-5">
                        <!-- Item Name with Autocomplete -->
                        <div class="space-y-1">
                            <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-1">Item Faltante</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="search" class="h-4 w-4 text-slate-400 group-focus-within:text-orange-500 transition-colors"></i>
                                </div>
                                <input 
                                    name="itemName" 
                                    type="text" 
                                    class="pl-10 block w-full rounded-lg border-slate-200 border bg-slate-50 focus:bg-white focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 text-sm p-3 transition-all outline-none font-medium text-slate-700" 
                                    placeholder="Buscar item no catálogo..." 
                                    autocomplete="off"
                                    oninput="handleInputSearch(this)"
                                    onfocus="handleInputSearch(this)"
                                    required
                                >
                                <ul id="suggestions-list" class="absolute z-50 w-full bg-white border border-slate-100 rounded-lg shadow-xl mt-1 max-h-48 overflow-y-auto hidden divide-y divide-slate-50"></ul>
                            </div>
                            <p class="text-[10px] text-slate-400">Obrigatório selecionar um item existente no catálogo.</p>
                        </div>

                        <!-- Quantity -->
                        <div class="space-y-1">
                            <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-1">Quantidade</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="hash" class="h-4 w-4 text-slate-400 group-focus-within:text-orange-500 transition-colors"></i>
                                </div>
                                <input 
                                    type="number" 
                                    name="quantity" 
                                    placeholder="Qtd" 
                                    class="pl-10 block w-full rounded-lg border-slate-200 border bg-slate-50 focus:bg-white focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 text-sm p-3 transition-all outline-none font-medium text-slate-700" 
                                    required
                                >
                            </div>
                        </div>

                        <!-- Reason -->
                        <div class="space-y-1">
                            <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-1">Motivo / Observação</label>
                            <div class="relative">
                                <textarea 
                                    name="reason" 
                                    rows="3" 
                                    class="block w-full rounded-lg border-slate-200 border bg-slate-50 focus:bg-white focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 text-sm p-3 transition-all outline-none font-medium text-slate-700 resize-none" 
                                    placeholder="Ex: Item quebrado, não veio no lote, caixa violada..."
                                ></textarea>
                                <div class="absolute top-3 right-3 pointer-events-none">
                                    <i data-lucide="message-square" class="h-4 w-4 text-slate-400"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Action Button -->
                        <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-orange-200 hover:shadow-orange-300 transition-all active:scale-95 flex items-center justify-center gap-2 mt-2">
                            <i data-lucide="alert-circle" class="w-5 h-5"></i> Registrar Pendência
                        </button>
                    </form>
                `;
            } else if (type === 'editBox') {
                content = `<h3 class="font-bold mb-2">Editar ${box.name}</h3><form onsubmit="handleEditBox(event)"><input name="boxName" value="${box.name}" class="w-full border p-2 rounded mb-4"><button class="w-full bg-blue-600 text-white p-2 rounded">Salvar</button></form>`;
            } else if (type === 'deleteBox') {
                content = `<h3 class="font-bold mb-2 text-red-600">Excluir Caixa</h3><p>Esta ação não pode ser desfeita.</p><div class="flex gap-2 mt-4"><button onclick="confirmDeleteBox()" class="bg-red-500 text-white px-4 py-2 rounded">Excluir</button><button onclick="closeModal()" class="border px-4 py-2 rounded">Cancelar</button></div>`;
            } else if (type === 'editLocation' || type === 'deleteLocation') {
                const loc = state.destinations[data];
                if (type === 'editLocation') {
                    content = `<h3 class="font-bold mb-4">Editar Local</h3><form onsubmit="handleEditDestination(event)" class="space-y-2"><input name="editName" value="${loc.name}" class="w-full border p-2 rounded"><input name="editStreet" value="${loc.street||''}" placeholder="Rua" class="w-full border p-2 rounded"><input name="editNumber" value="${loc.number||''}" placeholder="Nº" class="w-full border p-2 rounded"><input name="editNeighborhood" value="${loc.neighborhood||''}" placeholder="Bairro" class="w-full border p-2 rounded"><button class="w-full bg-blue-600 text-white p-2 rounded mt-2">Salvar</button></form>`;
                } else {
                    content = `<h3 class="font-bold text-red-600">Excluir Local</h3><p>${loc.name}</p><div class="flex gap-2 mt-4"><button onclick="confirmDeleteLocation()" class="bg-red-500 text-white px-4 py-2 rounded">Confirmar</button><button onclick="closeModal()" class="border px-4 py-2 rounded">Cancelar</button></div>`;
                }
            } else if (type === 'editDriver' || type === 'deleteDriver') {
                const drv = state.drivers[data];
                if (type === 'editDriver') {
                    content = `<h3 class="font-bold mb-4">Editar Motorista</h3><form onsubmit="handleEditDriver(event)" class="space-y-2"><input name="editDriverName" value="${drv.name}" class="w-full border p-2 rounded"><input name="editDriverPhone" value="${drv.phone||''}" placeholder="Telefone" class="w-full border p-2 rounded"><button class="w-full bg-blue-600 text-white p-2 rounded mt-2">Salvar</button></form>`;
                } else {
                    content = `<h3 class="font-bold text-red-600">Excluir Motorista</h3><p>${drv.name}</p><div class="flex gap-2 mt-4"><button onclick="confirmDeleteDriver()" class="bg-red-500 text-white px-4 py-2 rounded">Confirmar</button><button onclick="closeModal()" class="border px-4 py-2 rounded">Cancelar</button></div>`;
                }
            } else if (type === 'editCatalogItem') {
                const item = state.catalog[data];
                content = `<h3 class="font-bold mb-4">Editar Item do Catálogo</h3><form onsubmit="handleEditCatalogItem(event)" class="space-y-3"><input name="newItemName" value="${escapeHtml(item)}" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500" required><button class="w-full bg-blue-600 text-white p-2 rounded mt-2 hover:bg-blue-700">Salvar</button></form>`;
            } else if (type === 'deleteCatalogItem') {
                const item = state.catalog[data];
                content = `<h3 class="font-bold text-red-600">Excluir Item do Catálogo</h3><p>${item}</p><div class="flex gap-2 mt-4"><button onclick="confirmDeleteCatalogItem()" class="bg-red-500 text-white px-4 py-2 rounded">Confirmar</button><button onclick="closeModal()" class="border px-4 py-2 rounded">Cancelar</button></div>`;
            } else if (type === 'changeDestination') {
                content = `<h3 class="font-bold mb-4">Alterar Destino</h3><form onsubmit="handleChangeDestination(event)"><div id="dest-input-group"><select name="destination" class="w-full border p-2 rounded mb-2" onchange="document.getElementById('customDestGroup2').classList.toggle('hidden', this.value !== '')"><option value="" disabled selected>Selecione...</option>${state.destinations.map(d => `<option value="${d.name}">${d.name}</option>`).join('')}<option value="">Outro (Digitar)</option></select><div id="customDestGroup2" class="hidden space-y-2"><input name="customName" placeholder="Nome do local" class="w-full border p-2 rounded bg-yellow-50"><input name="customStreet" placeholder="Rua" class="w-full border p-2 rounded text-xs"><div class="flex gap-2"><input name="customNumber" placeholder="Nº" class="w-1/3 border p-2 rounded text-xs"><input name="customNeighborhood" placeholder="Bairro" class="w-2/3 border p-2 rounded text-xs"></div></div></div><button class="w-full bg-blue-600 text-white p-2 rounded mt-2">Salvar</button></form>`;
            } else if (type === 'changeDriver') {
                content = `<h3 class="font-bold mb-4">Alterar Motorista</h3><form onsubmit="handleChangeDriver(event)"><select name="newDriver" class="w-full border p-2 rounded mb-4"><option value="">Sem motorista</option>${state.drivers.map(d => `<option value="${d.name}">${d.name}</option>`).join('')}</select><button class="w-full bg-blue-600 text-white p-2 rounded">Salvar</button></form>`;
            } else if (type === 'editMissing' || type === 'deleteMissing') {
                 const mItem = state.missingItems[data];
                 if (type === 'editMissing') {
                     content = `<h3 class="font-bold mb-4">Editar Falta</h3><form onsubmit="handleEditMissing(event)" class="space-y-2"><input name="editItemName" value="${mItem.itemName}" class="w-full border p-2 rounded"><input name="editQuantity" type="number" value="${mItem.quantity}" class="w-full border p-2 rounded"><textarea name="editReason" class="w-full border p-2 rounded">${mItem.reason}</textarea><button class="w-full bg-blue-600 text-white p-2 rounded">Salvar</button></form>`;
                 } else {
                     content = `<h3 class="font-bold text-red-600">Excluir Registro</h3><p>${mItem.itemName}</p><div class="flex gap-2 mt-4"><button onclick="confirmDeleteMissing()" class="bg-red-500 text-white px-4 py-2 rounded">Confirmar</button><button onclick="closeModal()" class="border px-4 py-2 rounded">Cancelar</button></div>`;
                 }
            } else if (type === 'confirmImport') {
                 content = `<h3 class="font-bold text-lg mb-2 text-orange-600">Restaurar Backup?</h3><p class="text-sm text-slate-600 mb-4">Isso substituirá todos os dados atuais pelos do arquivo. Tem certeza?</p><div class="flex gap-2"><button onclick="executeImport()" class="flex-1 bg-orange-600 text-white p-2 rounded">Sim, Restaurar</button><button onclick="closeModal()" class="flex-1 border p-2 rounded">Cancelar</button></div>`;
            }

            container.innerHTML = `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md animate-zoom-in relative">
                        <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                        ${content}
                    </div>
                </div>`;
            lucide.createIcons();
        }

        // --- Render Catalog Panel (Novo) ---
        function renderCatalogPanel() {
            const container = document.getElementById('app-content');
            container.innerHTML = `
                <div class="max-w-2xl mx-auto space-y-6 pb-10">
                    <div class="bg-white rounded-xl shadow-sm border border-blue-100 p-6">
                        <h2 class="text-xl font-bold text-blue-900 flex items-center gap-2 mb-6">
                            <i data-lucide="list" class="text-blue-500"></i> Cadastrar Item no Catálogo
                        </h2>
                        <form onsubmit="handleAddCatalogItem(event)" class="space-y-3">
                            <div class="flex gap-3 items-stretch">
                                <div class="relative flex-grow group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="package-plus" class="h-5 w-5 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                                    </div>
                                    <input name="newItemName" type="text" required placeholder="Digite o nome do novo item..." class="pl-10 block w-full rounded-lg border-slate-200 bg-slate-50 border focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm p-3 transition-all outline-none shadow-sm" autocomplete="off">
                                </div>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium shadow-md shadow-blue-200 transition-all active:scale-95 flex items-center gap-2 whitespace-nowrap">
                                    <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden sm:inline">Cadastrar</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-blue-100 overflow-hidden">
                        <div class="p-4 border-b border-blue-50 bg-blue-50/50 font-semibold text-blue-800 flex flex-col sm:flex-row justify-between items-center gap-3">
                            <div class="flex items-center gap-2 w-full sm:w-auto">
                                <span>Itens Disponíveis (${state.catalog.length})</span>
                                <span class="text-xs font-normal text-blue-400 bg-white px-2 py-1 rounded border border-blue-100">Ordenado A-Z</span>
                            </div>
                            
                            <!-- Search Input -->
                            <div class="relative w-full sm:w-64">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="search" class="h-4 w-4 text-slate-400"></i>
                                </div>
                                <input type="text" id="catalog-search" oninput="filterCatalog()" placeholder="Pesquisar no catálogo..." class="pl-9 block w-full rounded-lg border-slate-200 bg-white border focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-xs p-2 transition-all outline-none">
                            </div>
                        </div>

                        <div id="catalog-list-container" class="divide-y divide-blue-50 max-h-[60vh] overflow-y-auto">
                            ${state.catalog.length ? state.catalog.map((item, i) => `
                                <div class="catalog-item p-4 flex justify-between items-center group hover:bg-blue-50/30 transition-colors" data-name="${escapeHtml(item)}">
                                    <div class="flex gap-3 items-center">
                                        <div class="bg-slate-100 p-2 rounded-full text-slate-500">
                                            <i data-lucide="tag" class="w-4 h-4"></i>
                                        </div>
                                        <div class="font-medium text-slate-700 item-name-text">${escapeHtml(item)}</div>
                                    </div>
                                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="openModal('editCatalogItem', null, ${i})" class="text-blue-300 hover:text-blue-600 p-2 rounded hover:bg-blue-50 transition-colors" title="Editar">
                                            <i data-lucide="pencil" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="openModal('deleteCatalogItem', null, ${i})" class="text-slate-300 hover:text-red-500 p-2 rounded hover:bg-red-50 transition-colors" title="Remover">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('') : '<p class="p-8 text-center text-slate-400 italic">O catálogo está vazio.</p>'}
                            
                            <!-- No results message (hidden by default) -->
                            <div id="no-results-msg" class="hidden p-8 text-center text-slate-400 italic">Nenhum item encontrado.</div>
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        // Add filter function logic
        function filterCatalog() {
            const input = document.getElementById('catalog-search');
            const filter = input.value.toLowerCase();
            const items = document.querySelectorAll('.catalog-item');
            let hasVisible = false;

            items.forEach(item => {
                const name = item.getAttribute('data-name').toLowerCase();
                if (name.includes(filter)) {
                    item.classList.remove('hidden');
                    item.classList.add('flex');
                    hasVisible = true;
                } else {
                    item.classList.add('hidden');
                    item.classList.remove('flex');
                }
            });

            const noResults = document.getElementById('no-results-msg');
            if(noResults) {
                if(!hasVisible && items.length > 0) noResults.classList.remove('hidden');
                else noResults.classList.add('hidden');
            }
        }

        // --- 9. Renderização Geral e Dashboards ---
        
        function renderLogin() {
            const container = document.getElementById('login-container');
            const appLayout = document.getElementById('app-layout');
            container.classList.remove('hidden');
            appLayout.classList.add('hidden');
            appLayout.classList.remove('opacity-100');
            container.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-lg border border-blue-200 w-full max-w-sm animate-zoom-in"><div class="text-center mb-8"><div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-200"><i data-lucide="lock" class="w-8 h-8 text-blue-600"></i></div><h2 class="text-2xl font-bold text-blue-900">Acesso Restrito</h2><p class="text-blue-500 text-sm mt-1">Identifique-se para continuar</p></div><form onsubmit="handleLogin(event)" class="space-y-5"><div><input type="password" name="password" placeholder="Senha de Acesso" class="w-full border border-blue-200 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 text-center tracking-widest text-lg transition-all" autofocus></div><button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-sm flex items-center justify-center gap-2"><span>Entrar no Sistema</span><i data-lucide="arrow-right" class="w-4 h-4"></i></button></form></div>`;
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function getStatusBadge(status) {
            const styles = { available: "text-blue-700 bg-blue-50 ring-1 ring-blue-600/20", in_delivery: "text-yellow-700 bg-yellow-50 ring-1 ring-yellow-600/20", delivered: "text-slate-700 bg-slate-100 ring-1 ring-slate-600/20", issue: "text-red-700 bg-red-50 ring-1 ring-red-600/20" };
            const labels = { available: "Disponível", in_delivery: "Em Trânsito", delivered: "Entregue", issue: "Pendência" };
            return `<span class="px-2.5 py-0.5 rounded-full text-xs font-semibold ${styles[status]}">${labels[status]}</span>`;
        }

        // --- Funções de Controle de Interface (Restauradas) ---
        function setHistoryView(view) { state.historyView = view; renderApp(); }
        
        function handleHistoryFilter(key, value) { state.historyFilter[key] = value; renderHistory(); lucide.createIcons(); }
        
        function clearHistoryFilters() { state.historyFilter = { search: '', date: '' }; renderHistory(); lucide.createIcons(); }
        
        function toggleSidebar() { state.sidebarCollapsed = !state.sidebarCollapsed; saveData(true); renderApp(); }

        function toggleDateAccordion(date) { 
            state.expandedDate = state.expandedDate === date ? null : date; 
            renderApp(); 
        }

        function renderDashboard() {
            const container = document.getElementById('app-content');
            const totalMissing = state.missingItems.filter(m => m.status === 'pending').length;
            const available = state.boxes.filter(b => b.status === 'available').length;
            const delivering = state.boxes.filter(b => b.status === 'in_delivery').length;
            
            let html = `
            <div class="space-y-8 pb-10">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex flex-col items-center justify-center border-b-4 border-b-blue-900"><span class="text-3xl font-bold text-blue-900 tracking-tight">${state.boxes.length}</span><span class="text-[10px] text-blue-400 uppercase tracking-widest font-semibold mt-1">Total Caixas</span></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex flex-col items-center justify-center border-b-4 border-b-blue-500"><span class="text-3xl font-bold text-blue-600 tracking-tight">${available}</span><span class="text-[10px] text-blue-600/70 uppercase tracking-widest font-semibold mt-1">Disponíveis</span></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex flex-col items-center justify-center border-b-4 border-b-yellow-500"><span class="text-3xl font-bold text-yellow-600 tracking-tight">${delivering}</span><span class="text-[10px] text-yellow-600/70 uppercase tracking-widest font-semibold mt-1">Em Trânsito</span></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex flex-col items-center justify-center border-b-4 border-b-red-500 relative overflow-hidden"><span class="text-3xl font-bold text-red-600 tracking-tight z-10">${totalMissing}</span><span class="text-[10px] text-red-600/70 uppercase tracking-widest font-semibold mt-1 z-10">Pendências</span>${totalMissing > 0 ? '<div class="absolute -right-3 -top-3 w-12 h-12 bg-red-100 rounded-full animate-pulse opacity-50"></div>' : ''}</div>
                </div>
                <div class="flex justify-end"><button onclick="openModal('addBox')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl font-medium shadow-md shadow-blue-200 flex items-center justify-center gap-2 transition-all"><i data-lucide="plus-square" class="w-5 h-5"></i><span>Nova Caixa</span></button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4 gap-6">`;
            
            state.boxes.forEach((box, index) => {
                const hasIssue = state.missingItems.some(m => m.boxId === box.id && m.status === 'pending');
                const status = (hasIssue && box.status === 'delivered') ? 'issue' : box.status;
                const borderColors = { available: "border-t-blue-500", in_delivery: "border-t-yellow-500", delivered: "border-t-slate-500", issue: "border-t-red-500" };
                const mappedItems = box.items.map((item, index) => ({...item, originalIndex: index}));
                const internalItems = mappedItems.filter(i => !i.isExternal);
                const externalItems = mappedItems.filter(i => i.isExternal);
                const renderList = (items, title, isExt) => items.length ? `
                    <div class="mb-4">
                        <p class="text-[10px] font-bold uppercase tracking-wider text-blue-400 mb-2 flex items-center gap-1.5 border-b border-blue-50 pb-1">
                            <i data-lucide="${isExt?'package-open':'box'}" class="w-3 h-3"></i> ${title}
                        </p>
                        ${items.map((it) => `
                            <div class="flex justify-between items-center text-sm py-1.5 group hover:bg-blue-50 rounded px-1 -mx-1 transition-colors">
                                <div class="truncate pr-2 flex-grow flex items-center">
                                    <span class="font-bold text-slate-700 mr-1.5 min-w-[1.5rem] text-right">${it.quantity}</span>
                                    <span class="text-[9px] font-bold bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded uppercase tracking-wide mr-2.5 shadow-sm border border-slate-300">${it.unitType==='fd'?'FD':it.unitType==='cx'?'CX':'UN'}</span>
                                    <span class="text-slate-700 truncate ${isExt?'italic text-slate-500':''}">${escapeHtml(it.name)}</span>
                                </div>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openModal('editItem', ${box.id}, ${it.originalIndex})" class="text-slate-300 hover:text-blue-500 p-0.5" title="Editar">
                                        <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                                    </button>
                                    <button onclick="openModal('deleteItem', ${box.id}, ${it.originalIndex})" class="text-slate-300 hover:text-red-500 p-0.5" title="Excluir">
                                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>` : '';
                let mainAction = '';
                if (box.status === 'available') mainAction = `<button onclick="openModal('deliver',${box.id})" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-colors shadow-sm"><i data-lucide="truck" class="w-4 h-4"></i> Entregar</button>`;
                else if (box.status === 'in_delivery') mainAction = `<button onclick="openModal('complete',${box.id})" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-colors shadow-sm"><i data-lucide="check-circle" class="w-4 h-4"></i> Receber</button>`;
                else mainAction = `<button onclick="openModal('reset',${box.id})" class="w-full bg-white border border-blue-200 hover:bg-blue-50 text-blue-600 py-2 rounded-md text-sm font-medium transition-colors">Disponibilizar</button>`;

                html += `
                <div 
                    id="card-${index}"
                    draggable="false"
                    data-index="${index}"
                    ondragstart="handleDragStart(event, ${index})"
                    ondragend="handleDragEnd(event)"
                    ondragover="handleDragOver(event)"
                    ondragenter="handleDragEnter(event)"
                    ondragleave="handleDragLeave(event)"
                    ondrop="handleDrop(event, ${index})"
                    class="group/card-container bg-white rounded-xl shadow-sm border border-blue-100 overflow-hidden flex flex-col h-full hover:shadow-md transition-all duration-200 border-t-4 ${borderColors[status]} cursor-default transform transition-transform"
                >
                    <div class="w-full flex justify-center -mt-2.5 mb-0 relative z-10">
                         <div 
                            class="drag-handle bg-white border border-t-0 border-blue-100 rounded-b-lg px-4 py-0.5 cursor-grab hover:bg-blue-50 text-slate-300 hover:text-blue-500 shadow-sm transition-colors select-none" 
                            title="Segure para arrastar"
                            onmousedown="enableDrag(event, ${index})"
                            onmouseup="disableDrag(event, ${index})"
                         >
                            <i data-lucide="grip-horizontal" class="w-4 h-4 pointer-events-none"></i>
                         </div>
                    </div>
                    <div class="p-4 pt-1 border-b border-blue-50 flex justify-between items-start group/card-header">
                        <div class="pr-2 flex-grow"><h3 class="font-bold text-lg text-blue-900 leading-tight">${escapeHtml(box.name)}</h3><div class="mt-1">${getStatusBadge(status)}</div></div>
                        <div class="flex items-center gap-1 opacity-80 group-hover/card-header:opacity-100 transition-opacity">
                            <button onclick="openModal('editBox', ${box.id})" class="p-1.5 text-blue-300 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="openModal('deleteBox', ${box.id})" class="p-1.5 text-blue-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            <div class="w-px h-4 bg-blue-100 mx-1"></div>
                            <button onclick="printBox(${box.id})" class="p-1.5 text-blue-300 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"><i data-lucide="printer" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="p-4 flex-grow flex flex-col">
                        <div class="mb-5 bg-blue-50/50 rounded-lg p-3 border border-blue-50">
                            <p class="text-[10px] text-blue-400 uppercase tracking-wide font-bold mb-1">Destino Atual</p>
                            <div class="flex items-center gap-2 text-slate-700 font-medium truncate group relative">
                                <i data-lucide="map-pin" class="w-4 h-4 text-blue-500 shrink-0"></i>
                                <span class="truncate flex-grow">${escapeHtml(box.destination) || '<span class="text-blue-300 font-normal italic">Não definido</span>'}</span>
                                ${ box.status !== 'available' ? `<button onclick="openModal('changeDestination', ${box.id})" class="text-blue-300 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-blue-100 shrink-0" title="Alterar Destino"><i data-lucide="pencil" class="w-3 h-3"></i></button>` : '' }
                            </div>
                            <div class="flex items-center gap-2 text-slate-700 font-medium truncate mt-1 group">
                                <i data-lucide="user" class="w-4 h-4 text-blue-500 shrink-0"></i>
                                <span class="truncate text-xs flex-grow">${escapeHtml(box.driver) || '<span class="text-blue-300 font-normal italic">Sem motorista</span>'}</span>
                                <button onclick="openModal('changeDriver', ${box.id})" class="text-blue-300 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-blue-100"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                        <div class="flex-grow">${box.items.length ? `<div class="space-y-1 max-h-60 overflow-y-auto pr-1 scrollbar-thin">${renderList(internalItems, "Interno", false)}${renderList(externalItems, "Externos", true)}</div>` : `<div class="h-32 flex flex-col items-center justify-center text-blue-200 italic text-sm border-2 border-dashed border-blue-100 rounded-lg"><i data-lucide="box" class="w-8 h-8 mb-2 opacity-50"></i> Caixa vazia</div>`}</div>
                    </div>
                    <div class="p-4 bg-blue-50/30 border-t border-blue-50 flex flex-col gap-2 mt-auto">
                        <div class="grid grid-cols-2 gap-2"><button onclick="openModal('add',${box.id})" class="flex items-center justify-center gap-1.5 bg-white border border-blue-200 text-blue-600 py-1.5 rounded hover:bg-blue-50 text-xs font-medium transition-colors"><i data-lucide="plus" class="w-3 h-3"></i> Item</button><button onclick="openModal('missing',${box.id})" class="flex items-center justify-center gap-1.5 bg-white border border-orange-200 text-orange-600 py-1.5 rounded hover:bg-orange-50 text-xs font-medium transition-colors"><i data-lucide="alert-triangle" class="w-3 h-3"></i> Falta</button></div>
                        ${mainAction}
                    </div>
                </div>`;
            });
            container.innerHTML = html + '</div></div>';
            lucide.createIcons();
        }

        function printBox(boxId) {
            const box = state.boxes.find(b => b.id === boxId);
            if (!box) return;
            const dest = state.destinations.find(d => d.name.trim().toLowerCase() === (box.destination || '').trim().toLowerCase());
            let addressStr = `<div style="font-size:16px;font-weight:600;color:#1e3a8a;">${escapeHtml(box.destination || 'N/A')}</div>`;
            if (dest && (dest.street || dest.neighborhood)) {
                const street = dest.street ? escapeHtml(dest.street) : '';
                const num = dest.number ? `, ${escapeHtml(dest.number)}` : '';
                const hood = dest.neighborhood ? ` - ${escapeHtml(dest.neighborhood)}` : '';
                addressStr += `<div style="font-size:12px;font-weight:normal;color:#555;margin-top:4px;">${street}${num}${hood}</div>`;
            }

            const internal = box.items.filter(i => !i.isExternal);
            const external = box.items.filter(i => i.isExternal);

            const renderList = (items) => items.map(i => 
                `<li style="padding:8px 0;border-bottom:1px solid #e0f2fe;display:flex;align-items:center;font-size:14px;">
                    <span style="display:inline-block;width:16px;height:16px;border:1px solid #1e40af;margin-right:12px;border-radius:2px;"></span>
                    <span style="font-weight:bold;margin-right:6px;background-color:#eff6ff;padding:2px 6px;border-radius:4px;border:1px solid #bfdbfe;">${i.quantity}${i.unitType==='fd'?' Fd':i.unitType==='cx'?' Cx':' Un'}</span> ${escapeHtml(i.name)}
                 </li>`
            ).join('');

            const driverObj = state.drivers.find(d => d.name === box.driver);
            const driverPhone = driverObj ? driverObj.phone : '';
            const driverDisplay = box.driver ? (driverPhone ? `${escapeHtml(box.driver)}<br><span style="font-size:11px;font-weight:normal;">${escapeHtml(driverPhone)}</span>` : escapeHtml(box.driver)) : '-';

            const html = `
            <html><head><title>Manifesto ${escapeHtml(box.name)}</title>
            <style>
                body { font-family: sans-serif; padding: 20px; color: #1e3a8a; }
                .header { border-bottom: 2px solid #1e3a8a; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; background: #eff6ff; padding: 20px; border-radius: 8px; border: 1px solid #bfdbfe; }
                .label { font-size: 11px; text-transform: uppercase; font-weight: bold; color: #60a5fa; margin-bottom: 2px; }
                .value { font-size: 16px; font-weight: 600; color: #1e3a8a; }
                h2 { font-size: 18px; border-bottom: 2px solid #bfdbfe; padding-bottom: 5px; margin-top: 25px; color: #1e40af; }
                ul { list-style: none; padding: 0; }
                .sign-line { border-top: 1px solid #1e3a8a; flex: 1; padding-top: 5px; text-align: center; margin-top: 50px; font-size: 12px; color: #1e3a8a; }
                @media print { .info-grid { background: none; border: 1px solid #bfdbfe; } h2 { border-bottom: 2px solid #bfdbfe; } body { -webkit-print-color-adjust: exact; } }
            </style></head><body>
                <div class="header">
                    <div><h1 style="margin:0;color:#1e3a8a;font-size:28px;">${escapeHtml(box.destination || "Logística Central")}</h1><div style="color:#3b82f6;">Controle de Entrega</div></div>
                    <div style="text-align:right;"><div class="value" style="font-size:24px;">${escapeHtml(box.name)}</div></div>
                </div>
                <div class="info-grid">
                    <div><div class="label">Destino</div>${addressStr}</div>
                    <div><div class="label">Data</div><div class="value">${new Date().toLocaleDateString('pt-BR')}</div></div>
                    <div><div class="label">Status</div><div class="value">${box.status==='in_delivery'?'Em Entrega':box.status==='delivered'?'Entregue':'Disponível'}</div></div>
                    <div><div class="label">Motorista</div><div class="value">${driverDisplay}</div></div>
                </div>
                ${internal.length > 0 ? `<h2>Conteúdo (${internal.reduce((a,i)=>a+(i.quantity||1),0)})</h2><ul>${renderList(internal)}</ul>` : ''}
                ${external.length > 0 ? `<h2>Itens Fora da Caixa (${external.reduce((a,i)=>a+(i.quantity||1),0)})</h2><ul>${renderList(external)}</ul>` : ''}
                ${internal.length===0 && external.length===0 ? '<p style="text-align:center;color:#93c5fd;margin-top:20px;">Vazio</p>' : ''}
                <div style="display:flex;gap:40px;margin-top:60px;">
                    <div class="sign-line">Assinatura Expedição</div><div class="sign-line">Assinatura Recebimento</div>
                </div>
                <script>window.onload=function(){window.print();} <\/script>
            </body></html>`;
            const win = window.open('', '_blank');
            if(win) { win.document.write(html); win.document.close(); }
            else { showToast("Pop-up bloqueado.", 'error'); }
        }

        function printMissingItems() {
            if (!state.missingItems.length) {
                showToast("Não há faltas para imprimir.", "error");
                return;
            }

            // Agrupar itens por (boxName + destination) para criar seções no relatório
            const grouped = {};
            state.missingItems.forEach(item => {
                // Cria uma chave única para agrupar
                const key = `${item.boxName}-${item.destination}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        boxName: item.boxName,
                        destination: item.destination,
                        items: []
                    };
                }
                grouped[key].items.push(item);
            });

            let contentHtml = '';

            // Gerar HTML para cada grupo
            Object.values(grouped).forEach(group => {
                const rows = group.items.map(m => `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; color: #334155;">${new Date(m.date).toLocaleDateString('pt-BR')}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: bold; color: #c0392b;">${m.quantity}x ${escapeHtml(m.itemName)}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-style: italic; color: #64748b;">${escapeHtml(m.reason || '-')}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 11px;">${m.status === 'resolved' ? '<span style="color:green">Resolvido</span>' : '<span style="color:red">Pendente</span>'}</td>
                    </tr>
                `).join('');

                contentHtml += `
                    <div style="margin-bottom: 25px; border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden; page-break-inside: avoid; page-break-after: always;">
                        <div style="background-color: #f1f5f9; padding: 10px 15px; border-bottom: 1px solid #cbd5e1;">
                            <div style="font-size: 16px; font-weight: bold; color: #0f172a;">${escapeHtml(group.boxName)}</div>
                            <div style="font-size: 12px; color: #475569; margin-top: 2px;">
                                Destino: <strong style="color: #1e40af;">${escapeHtml(group.destination)}</strong>
                            </div>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #ffffff; text-align: left; border-bottom: 1px solid #e2e8f0;">
                                    <th style="padding: 8px; width: 80px; color: #64748b;">Data</th>
                                    <th style="padding: 8px; color: #64748b;">Item Faltante</th>
                                    <th style="padding: 8px; color: #64748b;">Motivo/Obs</th>
                                    <th style="padding: 8px; width: 60px; color: #64748b;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            });

            const html = `
                <html>
                <head>
                    <title>Relatório de Faltas por Caixa</title>
                    <style>
                        body { font-family: sans-serif; padding: 30px; color: #1e293b; max-width: 900px; margin: 0 auto; }
                        h1 { color: #1e3a8a; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; margin-bottom: 5px; font-size: 22px; }
                        .subtitle { font-size: 12px; color: #64748b; margin-bottom: 30px; }
                        @media print { 
                            body { padding: 0; } 
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Relatório de Faltas e Pendências</h1>
                    <div class="subtitle">Gerado em: ${new Date().toLocaleString('pt-BR')}</div>
                    ${contentHtml}
                    <script>window.onload=function(){window.print();} <\/script>
                </body>
                </html>`;
                
            const win = window.open('', '_blank');
            if(win) { win.document.write(html); win.document.close(); }
            else { showToast("Pop-up bloqueado.", 'error'); }
        }

        function printHistoryManifest(logId) {
            const log = state.history.find(l => l.id === logId);
            if (!log) return;
            let destinationName = "Desconhecido";
            let driverName = "Desconhecido";
            let itemsText = "";
            const destMatch = log.details.match(/Saiu para entrega em: (.*?) \(Mot:/);
            if (destMatch) destinationName = destMatch[1];
            const driverMatch = log.details.match(/\(Mot: (.*?)\)/);
            if (driverMatch) driverName = driverMatch[1];
            if (log.details.includes("Conteúdo: ")) { itemsText = log.details.split("Conteúdo: ")[1]; }
            const destObj = state.destinations.find(d => d.name.trim().toLowerCase() === destinationName.trim().toLowerCase());
            const driverObj = state.drivers.find(d => d.name.trim().toLowerCase() === driverName.trim().toLowerCase());
            let addressStr = `<div style="font-size:16px;font-weight:600;color:#1e3a8a;">${escapeHtml(destinationName)}</div>`;
            if (destObj) {
                const street = destObj.street ? escapeHtml(destObj.street) : '';
                const num = destObj.number ? `, ${escapeHtml(destObj.number)}` : '';
                const hood = destObj.neighborhood ? ` - ${escapeHtml(destObj.neighborhood)}` : '';
                if(street || hood) { addressStr += `<div style="font-size:12px;font-weight:normal;color:#555;margin-top:4px;">${street}${num}${hood}</div>`; }
            }
            let driverDisplay = escapeHtml(driverName);
            if (driverObj && driverObj.phone) { driverDisplay += `<br><span style="font-size:11px;font-weight:normal;">${escapeHtml(driverObj.phone)}</span>`; }
            let itemsHtml = '<li style="padding:10px;text-align:center;color:#999;">Sem detalhes de itens no histórico</li>';
            if (itemsText) {
                itemsHtml = itemsText.split(', ').map(itemStr => {
                    const match = itemStr.match(/^(\d+)([a-z]+)\s+(.*)$/);
                    if (match) {
                        const qtd = match[1];
                        const unit = match[2] === 'fd' ? ' Fd' : (match[2] === 'cx' ? ' Cx' : ' Un');
                        const name = match[3];
                        return `<li style="padding:8px 0;border-bottom:1px solid #e0f2fe;display:flex;align-items:center;font-size:14px;"><span style="display:inline-block;width:16px;height:16px;border:1px solid #1e40af;margin-right:12px;border-radius:2px;"></span><span style="font-weight:bold;margin-right:6px;background-color:#eff6ff;padding:2px 6px;border-radius:4px;border:1px solid #bfdbfe;">${qtd}${unit}</span> ${escapeHtml(name)}</li>`;
                    } else { return `<li style="padding:8px 0;border-bottom:1px solid #e0f2fe;display:flex;align-items:center;font-size:14px;"><span style="display:inline-block;width:16px;height:16px;border:1px solid #1e40af;margin-right:12px;border-radius:2px;"></span>${escapeHtml(itemStr)}</li>`; }
                }).join('');
            }
            const html = `<html><head><title>Cópia de Manifesto</title><style>body { font-family: sans-serif; padding: 20px; color: #1e3a8a; } .header { border-bottom: 2px solid #1e3a8a; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; } .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; background: #eff6ff; padding: 20px; border-radius: 8px; border: 1px solid #bfdbfe; } .label { font-size: 11px; text-transform: uppercase; font-weight: bold; color: #60a5fa; margin-bottom: 2px; } .value { font-size: 16px; font-weight: 600; color: #1e3a8a; } h2 { font-size: 18px; border-bottom: 2px solid #bfdbfe; padding-bottom: 5px; margin-top: 25px; color: #1e40af; } ul { list-style: none; padding: 0; } .sign-line { border-top: 1px solid #1e3a8a; flex: 1; padding-top: 5px; text-align: center; margin-top: 50px; font-size: 12px; color: #1e3a8a; } .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 100px; color: rgba(30, 58, 138, 0.05); pointer-events: none; z-index: -1; border: 5px solid rgba(30, 58, 138, 0.05); padding: 20px; border-radius: 20px; text-transform: uppercase; } @media print { .info-grid { background: none; border: 1px solid #bfdbfe; } h2 { border-bottom: 2px solid #bfdbfe; } body { -webkit-print-color-adjust: exact; } }</style></head><body><div class="watermark">CÓPIA</div><div class="header"><div><h1 style="margin:0;color:#1e3a8a;font-size:28px;">${escapeHtml(destinationName)}</h1><div style="color:#3b82f6;">Controle de Entrega (Histórico)</div></div><div style="text-align:right;"><div class="value" style="font-size:24px;">${escapeHtml(log.boxName)}</div><div style="font-size:12px;color:#666;">ID Log: ${log.id}</div></div></div><div class="info-grid"><div><div class="label">Destino</div>${addressStr}</div><div><div class="label">Data Original</div><div class="value">${new Date(log.timestamp).toLocaleDateString('pt-BR')} ${new Date(log.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div><div><div class="label">Status no Registro</div><div class="value">Enviado</div></div><div><div class="label">Motorista</div><div class="value">${driverDisplay}</div></div></div><h2>Conteúdo Registrado</h2><ul>${itemsHtml}</ul><div style="display:flex;gap:40px;margin-top:60px;"><div class="sign-line">Responsável Expedição</div><div class="sign-line">Conferência Recebimento</div></div><script>window.onload=function(){window.print();} <\/script></body></html>`;
            const win = window.open('', '_blank');
            if(win) { win.document.write(html); win.document.close(); }
            else { showToast("Pop-up bloqueado.", 'error'); }
        }

        function renderHistory() {
            const container = document.getElementById('app-content');
            const search = state.historyFilter.search.toLowerCase();
            const dateFilter = state.historyFilter.date;
            
            const filtered = state.history.filter(l => {
                const txt = (l.action + l.details + l.boxName + l.user).toLowerCase();
                const logDate = getLocalDateString(l.timestamp);
                return (!search || txt.includes(search)) && (!dateFilter || logDate === dateFilter);
            });
            
            const todayPT = getLocalDateString(new Date().toISOString());
            const renderTimelineItem = (l) => {
                let icon='circle', color='bg-slate-100 text-slate-500 border-slate-200';
                if(l.action === 'Saída') { icon='truck'; color='bg-yellow-50 text-yellow-600 border-yellow-200'; }
                else if(l.action === 'Entrega') { icon='check'; color='bg-green-50 text-green-600 border-green-200'; }
                else if(l.action === 'Falta') { icon='alert-triangle'; color='bg-red-50 text-red-600 border-red-200'; }
                else if(l.action === 'Adição') { icon='plus'; color='bg-blue-50 text-blue-600 border-blue-200'; }
                else if(l.action === 'Exclusão') { icon='trash-2'; color='bg-red-50 text-red-600 border-red-200'; }
                else if(l.action === 'Alteração') { icon='pencil'; color='bg-indigo-50 text-indigo-600 border-indigo-200'; }
                let printBtn = l.action === 'Saída' ? `<button onclick="printHistoryManifest(${l.id})" class="ml-auto text-xs flex items-center gap-1 text-slate-400 hover:text-blue-600 bg-white border border-slate-200 hover:border-blue-300 px-2 py-1 rounded-md transition-colors"><i data-lucide="printer" class="w-3 h-3"></i> Imprimir</button>` : '';
                const time = new Date(l.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                return `<div class="timeline-item relative pl-14 py-2 group"><div class="timeline-line group-last:hidden"></div><div class="absolute left-0 top-2 w-12 h-12 flex items-center justify-center z-10"><div class="w-10 h-10 rounded-full border-2 ${color} flex items-center justify-center shadow-sm bg-white"><i data-lucide="${icon}" class="w-5 h-5"></i></div></div><div class="bg-white border border-slate-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-all hover:border-blue-100"><div class="flex justify-between items-start mb-1"><div class="flex flex-col"><span class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-0.5">${time} • ${escapeHtml(l.user)}</span><h4 class="text-base font-bold text-slate-800 flex items-center gap-2">${escapeHtml(l.action)} <span class="font-normal text-slate-500">em</span> <span class="text-blue-700 bg-blue-50 px-1.5 py-0.5 rounded text-sm">${escapeHtml(l.boxName)}</span></h4></div>${printBtn}</div><div class="text-sm text-slate-600 mt-2 p-3 bg-slate-50/50 rounded-lg border border-slate-50 whitespace-pre-wrap leading-relaxed">${escapeHtml(l.details)}</div></div></div>`;
            };

            let contentHtml = '';
            if (state.historyView === 'today') {
                const todaysLogs = filtered.filter(l => getLocalDateString(l.timestamp) === todayPT);
                contentHtml = `<div class="flex-grow overflow-hidden flex flex-col bg-white rounded-xl shadow-sm border border-blue-100"><div class="p-4 border-b border-blue-50 bg-blue-50/30 flex justify-between items-center"><span class="font-bold text-blue-900 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> Hoje (${new Date().toLocaleDateString()})</span><span class="text-xs font-medium bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${todaysLogs.length} Registos</span></div><div class="overflow-y-auto flex-grow p-6 bg-slate-50/30 scroll-smooth"><div class="max-w-3xl mx-auto space-y-1">${todaysLogs.length ? todaysLogs.map(renderTimelineItem).join('') : `<div class="flex flex-col items-center justify-center h-64 text-slate-400"><div class="bg-slate-100 p-4 rounded-full mb-3"><i data-lucide="clock" class="w-8 h-8 opacity-50"></i></div><p>Nenhuma atividade registada hoje.</p></div>`}</div></div></div>`;
            } else {
                const archiveLogs = filtered.filter(l => getLocalDateString(l.timestamp) !== todayPT);
                const grouped = {};
                archiveLogs.forEach(l => {
                    const d = new Date(l.timestamp).toLocaleDateString('pt-BR');
                    if(!grouped[d]) grouped[d] = [];
                    grouped[d].push(l);
                });
                const dates = Object.keys(grouped).sort((a,b) => {
                    const [da, ma, ya] = a.split('/'); const [db, mb, yb] = b.split('/');
                    return new Date(yb, mb-1, db) - new Date(ya, ma-1, da);
                });
                
                const listHtml = dates.map(date => {
                    const isExpanded = state.expandedDate === date;
                    const chevron = isExpanded ? 'chevron-up' : 'chevron-down';
                    let expandedContent = '';
                    if (isExpanded) {
                        expandedContent = `<div class="border-t border-slate-100 bg-slate-50/50 p-6"><div class="max-w-3xl mx-auto">${grouped[date].map(renderTimelineItem).join('')}</div></div>`;
                    }
                          
                    return `<div class="bg-white border border-blue-100 rounded-xl overflow-hidden shadow-sm transition-all hover:shadow-md"><button onclick="toggleDateAccordion('${date}')" class="w-full px-5 py-4 flex justify-between items-center bg-white hover:bg-slate-50 transition-colors group"><div class="flex items-center gap-3"><div class="bg-blue-100 text-blue-600 p-2 rounded-lg group-hover:bg-blue-600 group-hover:text-white transition-colors"><i data-lucide="calendar-days" class="w-5 h-5"></i></div><span class="font-bold text-slate-700 text-lg">${date}</span></div><div class="flex items-center gap-3"><span class="text-xs font-bold bg-slate-100 text-slate-500 px-2.5 py-1 rounded-full">${grouped[date].length} eventos</span><i data-lucide="${chevron}" class="w-5 h-5 text-slate-400"></i></div></button>${expandedContent}</div>`;
                }).join('');

                const emptyState = !dates.length ? 
                    `<div class="flex flex-col items-center justify-center h-64 text-slate-400">
                        <i data-lucide="archive-restore" class="w-12 h-12 mb-3 opacity-20"></i>
                        <p>Nenhum registo anterior encontrado.</p>
                     </div>` : '';

                contentHtml = `
                <div class="flex-grow overflow-hidden flex flex-col bg-white rounded-xl shadow-sm border border-blue-100">
                    <div class="p-4 border-b border-blue-50 bg-blue-50/30 font-bold text-blue-900 flex items-center gap-2">
                        <i data-lucide="archive" class="w-4 h-4"></i> Arquivo Histórico
                    </div>
                    <div class="overflow-y-auto flex-grow p-4 space-y-4 bg-slate-50">
                        ${listHtml}
                        ${emptyState}
                    </div>
                </div>`;
            }

            container.innerHTML = `<div class="flex flex-col h-full overflow-hidden pb-4"><div class="flex flex-col md:flex-row gap-4 mb-6 shrink-0 justify-between items-center"><div class="bg-slate-200/50 p-1 rounded-xl flex gap-1 w-full md:w-auto"><button onclick="setHistoryView('today')" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-2 rounded-lg text-sm font-bold transition-all ${state.historyView==='today'?'bg-white text-blue-700 shadow-sm ring-1 ring-black/5':'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'}"><i data-lucide="sun" class="w-4 h-4"></i> Hoje</button><button onclick="setHistoryView('archive')" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-2 rounded-lg text-sm font-bold transition-all ${state.historyView==='archive'?'bg-white text-blue-700 shadow-sm ring-1 ring-black/5':'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'}"><i data-lucide="history" class="w-4 h-4"></i> Arquivo</button></div><div class="flex gap-2 w-full md:w-auto bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm"><div class="relative flex-grow md:w-64"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i><input type="text" placeholder="Filtrar eventos..." value="${escapeHtml(state.historyFilter.search)}" oninput="handleHistoryFilter('search', this.value)" class="w-full pl-9 pr-3 py-2 text-sm bg-transparent outline-none text-slate-700 placeholder:text-slate-400"></div><div class="w-px bg-slate-200 my-1"></div><input type="date" value="${state.historyFilter.date}" onchange="handleHistoryFilter('date', this.value)" class="bg-transparent text-sm text-slate-600 px-2 outline-none font-medium cursor-pointer hover:text-blue-600">${(state.historyFilter.search || state.historyFilter.date) ? `<button onclick="clearHistoryFilters()" class="text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg text-xs font-bold uppercase transition-colors border border-transparent hover:border-red-100 flex items-center gap-1"><i data-lucide="x" class="w-3 h-3"></i></button>` : ''}</div></div>${contentHtml}</div>`;
            lucide.createIcons();
        }

        function renderLocationsPanel() {
            const container = document.getElementById('app-content');
            container.innerHTML = `<div class="max-w-2xl mx-auto space-y-6 pb-10"><div class="bg-white rounded-xl shadow-sm border border-blue-100 p-6"><h2 class="text-xl font-bold text-blue-900 flex items-center gap-2"><i data-lucide="map-pin" class="text-blue-500"></i> Cadastrar Endereço</h2><form onsubmit="handleAddDestination(event)" class="space-y-3"><input name="newName" type="text" required placeholder="Nome do Local" class="w-full border border-blue-200 rounded px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"><div class="grid grid-cols-3 gap-3"><div class="col-span-2"><input name="newStreet" type="text" placeholder="Rua" class="w-full border border-blue-200 rounded px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"></div><div><input name="newNumber" type="text" placeholder="Nº" class="w-full border border-blue-200 rounded px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"></div></div><input name="newNeighborhood" type="text" placeholder="Bairro" class="w-full border border-blue-200 rounded px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"><button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex justify-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Cadastrar</button></form></div><div class="bg-white rounded-xl shadow-sm border border-blue-100 overflow-hidden"><div class="p-4 border-b border-blue-50 bg-blue-50/50 font-semibold text-blue-800">Locais Cadastrados (${state.destinations.length})</div><div class="divide-y divide-blue-50">${state.destinations.length ? state.destinations.map((d, i) => `<div class="p-4 flex justify-between items-start group hover:bg-blue-50/30"><div class="flex gap-3"><div class="bg-blue-100 p-2 rounded-full text-blue-600 mt-1"><i data-lucide="building-2" class="w-4 h-4"></i></div><div><div class="font-medium text-slate-700">${escapeHtml(d.name)}</div><div class="text-xs text-blue-400">${escapeHtml(d.street)||''} ${escapeHtml(d.number)||''} ${escapeHtml(d.neighborhood)||''}</div></div></div><div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openModal('editLocation',null,${i})" class="text-blue-300 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="openModal('deleteLocation',null,${i})" class="text-blue-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`).join('') : '<p class="p-6 text-center text-blue-300">Nenhum local cadastrado.</p>'}</div></div></div>`;
            lucide.createIcons();
        }

        function renderDriversPanel() {
            const container = document.getElementById('app-content');
            container.innerHTML = `<div class="max-w-2xl mx-auto space-y-6 pb-10"><div class="bg-white rounded-xl shadow-sm border border-blue-100 p-6"><h2 class="text-xl font-bold text-blue-900 flex items-center gap-2"><i data-lucide="users" class="text-blue-500"></i> Cadastrar Motorista</h2><form onsubmit="handleAddDriver(event)" class="space-y-3"><div class="flex flex-col gap-2"><input name="newDriverName" type="text" required placeholder="Nome do Motorista" class="w-full border border-blue-200 rounded px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"><div class="flex gap-2"><input name="newDriverPhone" type="text" placeholder="Telefone" class="flex-1 border border-blue-200 rounded px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Cadastrar</button></div></div></form></div><div class="bg-white rounded-xl shadow-sm border border-blue-100 overflow-hidden"><div class="p-4 border-b border-blue-50 bg-blue-50/50 font-semibold text-blue-800">Motoristas Cadastrados (${state.drivers.length})</div><div class="divide-y divide-blue-50">${state.drivers.length ? state.drivers.map((d, i) => `<div class="p-4 flex justify-between items-center group hover:bg-blue-50/30"><div class="flex gap-3 items-center"><div class="bg-blue-100 p-2 rounded-full text-blue-600"><i data-lucide="user" class="w-4 h-4"></i></div><div><div class="font-medium text-slate-700">${escapeHtml(d.name)}</div><div class="text-xs text-blue-400">${escapeHtml(d.phone) || 'Sem telefone'}</div></div></div><div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openModal('editDriver',null,${i})" class="text-blue-300 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="openModal('deleteDriver',null,${i})" class="text-blue-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`).join('') : '<p class="p-6 text-center text-blue-300">Nenhum motorista cadastrado.</p>'}</div></div></div>`;
            lucide.createIcons();
        }

        function renderMissingPanel() {
            const container = document.getElementById('app-content');
            
            // Estatísticas
            const total = state.missingItems.length;
            const pendingList = state.missingItems.filter(i => i.status === 'pending');
            const resolvedList = state.missingItems.filter(i => i.status === 'resolved');
            const pendingCount = pendingList.length;
            const resolvedCount = resolvedList.length;

            // Determinar qual lista mostrar com base na aba ativa
            let activeList = state.missingTab === 'resolved' ? resolvedList : pendingList;
            const isPendingTab = state.missingTab !== 'resolved';

            // Filtrar por data se estiver no arquivo e houver data selecionada
            if (!isPendingTab && state.missingDateFilter) {
                activeList = activeList.filter(item => getLocalDateString(item.date) === state.missingDateFilter);
            }

            // Agrupar itens por boxId
            const grouped = {};
            activeList.forEach((item, index) => {
                // Encontrar o índice real na lista original para edição/exclusão corretas
                const realIndex = state.missingItems.findIndex(i => i === item);
                
                if (!grouped[item.boxId]) {
                    grouped[item.boxId] = {
                        boxName: item.boxName,
                        destination: item.destination,
                        items: []
                    };
                }
                grouped[item.boxId].items.push({ ...item, originalIndex: realIndex });
            });

            // Converter objeto em array para renderizar
            let contentHtml = '';
            
            if (activeList.length === 0) {
                const emptyMessage = !isPendingTab && state.missingDateFilter 
                    ? `Nenhum registo encontrado para a data ${state.missingDateFilter.split('-').reverse().join('/')}.`
                    : (isPendingTab ? 'Nenhuma pendência registrada.' : 'Nenhum item resolvido ainda.');

                contentHtml = `
                    <div class="flex flex-col items-center justify-center h-64 text-slate-400 animate-fade-in bg-white rounded-xl border border-slate-100 mt-6">
                        <div class="bg-slate-50 p-4 rounded-full mb-3 ring-1 ring-slate-100">
                            <i data-lucide="${isPendingTab ? 'check-circle' : 'archive'}" class="w-10 h-10 ${isPendingTab ? 'text-emerald-400' : 'text-slate-300'}"></i>
                        </div>
                        <h3 class="text-base font-bold text-slate-700">${isPendingTab ? 'Tudo em Ordem!' : 'Arquivo Vazio'}</h3>
                        <p class="text-sm">${emptyMessage}</p>
                        ${!isPendingTab && state.missingDateFilter ? `<button onclick="setMissingDateFilter('')" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-medium">Limpar Filtro</button>` : ''}
                    </div>`;
            } else {
                contentHtml = Object.values(grouped).map(group => {
                    const groupItemsHtml = group.items.map(m => {
                        const isResolved = m.status === 'resolved';
                        const statusColor = isResolved ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700';
                        const statusLabel = isResolved ? 'Resolvido' : 'Pendente';

                        return `
                            <div class="p-4 flex flex-col sm:flex-row gap-4 items-start sm:items-center hover:bg-slate-50 transition-colors border-l-4 ${isResolved ? 'border-l-emerald-400' : 'border-l-rose-400'}">
                                <div class="flex-grow">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">${new Date(m.date).toLocaleDateString()}</span>
                                        <span class="font-bold text-slate-700">${m.quantity}x ${escapeHtml(m.itemName)}</span>
                                    </div>
                                    ${m.reason ? `<p class="text-sm text-slate-500 italic flex items-start gap-1"><i data-lucide="message-square" class="w-3 h-3 mt-1 shrink-0 opacity-50"></i> ${escapeHtml(m.reason)}</p>` : ''}
                                </div>
                                
                                <div class="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-end">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-bold ${statusColor}">
                                        ${statusLabel}
                                    </span>

                                    <div class="flex items-center gap-1">
                                        ${!isResolved ? `
                                            <button onclick="resolveMissingItem(${m.id})" class="p-1.5 text-emerald-500 hover:text-emerald-700 hover:bg-emerald-50 rounded-lg transition-all active:scale-95" title="Resolver">
                                                <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                                            </button>
                                        ` : ''}
                                        <button onclick="openModal('editMissing', null, ${m.originalIndex})" class="p-1.5 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Editar">
                                            <i data-lucide="pencil" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="openModal('deleteMissing', null, ${m.originalIndex})" class="p-1.5 text-rose-300 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors" title="Excluir">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    return `
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6 animate-fade-in">
                            <div class="bg-slate-50/80 border-b border-slate-200 p-4 flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="bg-white p-2 rounded-lg border border-slate-200 shadow-sm text-blue-600">
                                        <i data-lucide="package" class="w-5 h-5"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-slate-800 text-lg leading-tight">${escapeHtml(group.boxName)}</h3>
                                        <p class="text-xs text-slate-500 flex items-center gap-1">
                                            <i data-lucide="map-pin" class="w-3 h-3"></i> ${escapeHtml(group.destination)}
                                        </p>
                                    </div>
                                </div>
                                <button onclick="printSingleBoxMissing(${group.items[0].boxId})" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors border border-transparent hover:border-blue-200" title="Imprimir esta caixa">
                                    <i data-lucide="printer" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="divide-y divide-slate-100">
                                ${groupItemsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            container.innerHTML = `
                <div class="max-w-4xl mx-auto pb-10 space-y-6 animate-fade-in">
                    <!-- Cards de Estatísticas e Filtros -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4 relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-24 h-full bg-gradient-to-l from-blue-50 to-transparent opacity-50"></div>
                            <div class="p-3 bg-blue-100 text-blue-600 rounded-xl"><i data-lucide="list" class="w-6 h-6"></i></div>
                            <div><div class="text-3xl font-bold text-slate-800 tracking-tight">${total}</div><div class="text-xs text-slate-500 font-bold uppercase tracking-wider">Total Registros</div></div>
                        </div>
                        <button onclick="setMissingTab('pending')" class="text-left bg-white p-5 rounded-2xl border ${isPendingTab ? 'border-rose-300 ring-2 ring-rose-100' : 'border-slate-100'} shadow-sm flex items-center gap-4 relative overflow-hidden transition-all hover:shadow-md group">
                            <div class="absolute right-0 top-0 w-24 h-full bg-gradient-to-l from-rose-50 to-transparent opacity-50"></div>
                            <div class="p-3 ${isPendingTab ? 'bg-rose-100 text-rose-600' : 'bg-slate-100 text-slate-400 group-hover:bg-rose-50 group-hover:text-rose-500'} rounded-xl transition-colors"><i data-lucide="alert-octagon" class="w-6 h-6"></i></div>
                            <div><div class="text-3xl font-bold ${isPendingTab ? 'text-rose-600' : 'text-slate-600'} tracking-tight">${pendingCount}</div><div class="text-xs ${isPendingTab ? 'text-rose-500' : 'text-slate-400'} font-bold uppercase tracking-wider">Pendentes (Ativos)</div></div>
                        </button>
                        <button onclick="setMissingTab('resolved')" class="text-left bg-white p-5 rounded-2xl border ${!isPendingTab ? 'border-emerald-300 ring-2 ring-emerald-100' : 'border-slate-100'} shadow-sm flex items-center gap-4 relative overflow-hidden transition-all hover:shadow-md group">
                            <div class="absolute right-0 top-0 w-24 h-full bg-gradient-to-l from-emerald-50 to-transparent opacity-50"></div>
                            <div class="p-3 ${!isPendingTab ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400 group-hover:bg-emerald-50 group-hover:text-emerald-500'} rounded-xl transition-colors"><i data-lucide="archive" class="w-6 h-6"></i></div>
                            <div><div class="text-3xl font-bold ${!isPendingTab ? 'text-emerald-600' : 'text-slate-600'} tracking-tight">${resolvedCount}</div><div class="text-xs ${!isPendingTab ? 'text-emerald-500' : 'text-slate-400'} font-bold uppercase tracking-wider">Resolvidos (Arquivo)</div></div>
                        </button>
                    </div>

                    <!-- Toolbar -->
                    <div class="flex flex-col sm:flex-row justify-between items-center bg-white p-2 rounded-xl border border-slate-200 shadow-sm gap-4 sticky top-0 z-20">
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <div class="flex gap-1 bg-slate-100 p-1 rounded-lg w-full sm:w-auto">
                                <button onclick="setMissingTab('pending')" class="flex-1 sm:flex-none px-4 py-2 rounded-md text-sm font-bold transition-all ${isPendingTab ? 'bg-white text-rose-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">Pendências</button>
                                <button onclick="setMissingTab('resolved')" class="flex-1 sm:flex-none px-4 py-2 rounded-md text-sm font-bold transition-all ${!isPendingTab ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">Arquivo</button>
                            </div>

                            <!-- Filtro de Data (Apenas no Arquivo) -->
                            ${!isPendingTab ? `
                                <div class="relative flex items-center group">
                                    <div class="absolute left-3 pointer-events-none text-slate-400"><i data-lucide="calendar" class="w-4 h-4"></i></div>
                                    <input type="date" value="${state.missingDateFilter}" onchange="setMissingDateFilter(this.value)" class="pl-9 pr-3 py-2 rounded-lg border border-slate-200 text-sm text-slate-600 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all cursor-pointer hover:border-emerald-300" title="Filtrar por data">
                                    ${state.missingDateFilter ? `<button onclick="setMissingDateFilter('')" class="ml-2 text-slate-400 hover:text-red-500" title="Limpar filtro"><i data-lucide="x" class="w-4 h-4"></i></button>` : ''}
                                </div>
                            ` : ''}
                        </div>

                        <button onclick="printMissingItems()" class="w-full sm:w-auto flex items-center justify-center gap-2 text-sm font-bold text-slate-600 hover:text-blue-700 bg-white hover:bg-blue-50 px-4 py-2 rounded-lg transition-all border border-transparent hover:border-blue-200">
                            <i data-lucide="printer" class="w-4 h-4"></i> Imprimir Relatório
                        </button>
                    </div>

                    <!-- Lista de Itens Agrupada -->
                    <div class="space-y-6">
                        ${contentHtml}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderNav() {
            const pending = state.missingItems.filter(m => m.status === 'pending').length;
            const navItems = [
                { id: 'dashboard', label: 'Caixas', icon: 'box' }, 
                { id: 'catalog', label: 'Catálogo', icon: 'list' },
                { id: 'locations', label: 'Endereços', icon: 'map-pin' }, 
                { id: 'drivers', label: 'Motoristas', icon: 'users' }, 
                { id: 'missing', label: 'Faltas', icon: 'alert-triangle', badge: pending }, 
                { id: 'history', label: 'Histórico', icon: 'clock' }, 
                { id: 'settings', label: 'Configurações', icon: 'settings' }
            ];
            
            const sidebarHtml = navItems.map(item => {
                const isActive = state.activeTab === item.id;
                const collapsed = state.sidebarCollapsed;
                const baseClass = `w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all group ${isActive ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900'} ${collapsed ? 'justify-center px-0' : ''}`;
                const iconClass = isActive ? 'text-blue-600' : 'text-slate-400 group-hover:text-slate-600';
                return `<button onclick="switchTab('${item.id}')" class="${baseClass}" title="${collapsed ? item.label : ''}"><div class="relative"><i data-lucide="${item.icon}" class="w-5 h-5 ${iconClass}"></i>${collapsed && item.badge > 0 ? `<span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border border-white"></span>` : ''}</div>${!collapsed ? `<span class="flex-grow text-left truncate">${item.label}</span>${item.badge > 0 ? `<span class="bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-md">${item.badge}</span>` : ''}${isActive ? `<div class="w-1.5 h-1.5 rounded-full bg-blue-600 shrink-0"></div>` : ''}` : ''}</button>`;
            }).join('');
            
            document.getElementById('sidebar-nav').innerHTML = sidebarHtml;
            
            const userFooter = document.getElementById('sidebar-footer');
            if (userFooter) {
                if (state.sidebarCollapsed) { 
                    userFooter.innerHTML = `<button onclick="logout()" class="w-full flex items-center justify-center text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors" title="Sair"><i data-lucide="log-out" class="w-5 h-5"></i></button>`; 
                } else { 
                    userFooter.innerHTML = `<div class="flex items-center gap-3 mb-3 px-2"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold border border-blue-200 shrink-0"><i data-lucide="user" class="w-4 h-4"></i></div><div class="overflow-hidden"><p class="text-sm font-bold text-slate-700 truncate">${state.currentUser}</p><p class="text-xs text-slate-400 truncate">Operador Logístico</p></div></div><button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-sm text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors border border-transparent hover:border-red-100"><i data-lucide="log-out" class="w-4 h-4"></i> Sair do Sistema</button>`; 
                }
            }
            
            const mobileHtml = navItems.map(item => {
                const isActive = state.activeTab === item.id;
                const baseClass = `flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors flex-shrink-0 ${isActive ? 'bg-blue-600 text-white shadow-sm' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`;
                return `<button onclick="switchTab('${item.id}')" class="${baseClass}">${item.label}${item.badge > 0 ? `<span class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">${item.badge}</span>` : ''}</button>`;
            }).join('');
            
            document.getElementById('mobile-nav').innerHTML = mobileHtml;
        }

        function renderSettingsPanel() {
            const container = document.getElementById('app-content');
            container.innerHTML = `
            <div class="max-w-4xl mx-auto space-y-8 animate-fade-in pb-10">
                <div class="text-center space-y-2 mb-8">
                    <h2 class="text-2xl font-bold text-slate-800">Backup e Restauração</h2>
                    <p class="text-slate-500 max-w-lg mx-auto">Gerencie seus dados com segurança.</p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-blue-100 p-8 flex flex-col items-center text-center hover:shadow-md transition-shadow relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
                        <div class="bg-blue-50 p-5 rounded-full mb-6 group-hover:scale-110 transition-transform duration-300">
                            <i data-lucide="download-cloud" class="w-10 h-10 text-blue-600"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Exportar Dados</h3>
                        <p class="text-sm text-slate-500 mb-8 flex-grow leading-relaxed">Cria um arquivo de segurança (JSON).</p>
                        <button onclick="handleExportBackup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm transition-all active:scale-95 shadow-blue-200">
                            <i data-lucide="download" class="w-5 h-5"></i> Baixar Backup
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-orange-100 p-8 flex flex-col items-center text-center hover:shadow-md transition-shadow relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-full h-1 bg-orange-500"></div>
                        <div class="bg-orange-50 p-5 rounded-full mb-6 group-hover:scale-110 transition-transform duration-300">
                            <i data-lucide="upload-cloud" class="w-10 h-10 text-orange-600"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Restaurar Dados</h3>
                        <p class="text-sm text-slate-500 mb-4 flex-grow leading-relaxed">Recupere o sistema a partir de um arquivo salvo.</p>
                        <label class="w-full bg-white border-2 border-dashed border-slate-300 hover:border-orange-400 hover:bg-orange-50/30 text-slate-600 hover:text-orange-700 py-3.5 rounded-lg font-medium flex items-center justify-center gap-2 cursor-pointer transition-all active:scale-95 group/btn">
                            <i data-lucide="file-up" class="w-5 h-5 text-slate-400 group-hover/btn:text-orange-500 transition-colors"></i>
                            <span>Selecionar Arquivo</span>
                            <input type="file" id="import-file" accept=".json" style="display:none;" onchange="handleImportBackup(event)">
                        </label>
                    </div>
                </div>
            </div>`;
            lucide.createIcons();
        }

        // --- Inicialização ---

        function switchTab(tab) { state.activeTab = tab; saveData(); }
        function openModal(type, boxId, data = null) { state.modal = { type, boxId, data }; renderModal(); }
        function closeModal() { state.modal = { type: null, boxId: null, data: null }; document.getElementById('modal-container').innerHTML = ''; renderApp(); }

        function renderApp() {
            if (!state.isLoggedIn) { renderLogin(); return; }
            document.getElementById('login-container').classList.add('hidden');
            const appLayout = document.getElementById('app-layout');
            appLayout.classList.remove('hidden');
            setTimeout(() => appLayout.classList.add('opacity-100'), 50);

            const sidebar = document.getElementById('main-sidebar');
            const logoContent = document.getElementById('sidebar-logo-content');
            if (sidebar) {
                if (state.sidebarCollapsed) { sidebar.classList.remove('w-64'); sidebar.classList.add('w-20'); if(logoContent) logoContent.classList.add('opacity-0', 'w-0'); } 
                else { sidebar.classList.remove('w-20'); sidebar.classList.add('w-64'); if(logoContent) logoContent.classList.remove('opacity-0', 'w-0'); }
            }

            renderNav();
            if (state.activeTab === 'dashboard') renderDashboard();
            else if (state.activeTab === 'catalog') renderCatalogPanel(); // Nova View
            else if (state.activeTab === 'locations') renderLocationsPanel();
            else if (state.activeTab === 'drivers') renderDriversPanel();
            else if (state.activeTab === 'missing') renderMissingPanel();
            else if (state.activeTab === 'history') renderHistory();
            else if (state.activeTab === 'settings') renderSettingsPanel();
            lucide.createIcons();
        }

        // Close suggestions on click outside
        window.addEventListener('click', (e) => {
            const list = document.getElementById('suggestions-list');
            const input = document.querySelector('input[name="itemName"]');
            if (list && input && !list.contains(e.target) && e.target !== input) {
                list.classList.add('hidden');
            }
        });

        window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && state.modal.type) closeModal(); });
        window.addEventListener('load', () => { if(typeof lucide !== 'undefined') renderApp(); else { const interval = setInterval(() => { if(typeof lucide !== 'undefined') { clearInterval(interval); renderApp(); } }, 100); } });
    </script>
</body>
</html>
