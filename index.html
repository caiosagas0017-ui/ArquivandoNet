<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logística Central - Controle de Caixas</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b' } 
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.06)'
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Animações e Estilos Globais --- */
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; background-color: #f8fafc; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { transform: scale(0.98); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-zoom-in { animation: zoomIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes slideUpFade {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        .toast-msg { 
            animation: slideUpFade 3s ease-in-out forwards; 
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); z-index: 9999;
        }
        
        /* Scrollbar Refinada */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; } 
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Drag & Drop */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        .dragging { opacity: 0.6; transform: scale(0.99); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .drop-target { border-color: #6366f1; background-color: #eef2ff; } /* Indigo-500 */

        /* Timeline */
        .timeline-line { position: absolute; left: 23px; top: 36px; bottom: -20px; width: 2px; background-color: #e2e8f0; z-index: 0; }
        .timeline-item:last-child .timeline-line { display: none; }

        /* Glass effect for modals */
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.8); }
    </style>
</head>
<body class="text-slate-900 h-screen overflow-hidden selection:bg-indigo-100 selection:text-indigo-900">

    <!-- Loading Fallback -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-50 z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
    </div>

    <!-- Login -->
    <div id="login-container" class="hidden h-full w-full bg-slate-50 flex items-center justify-center z-50 absolute top-0 left-0"></div>

    <!-- App Layout -->
    <div id="app-layout" class="flex h-screen w-full overflow-hidden hidden opacity-0 transition-opacity duration-300">
        
        <!-- SIDEBAR -->
        <aside id="main-sidebar" class="hidden md:flex flex-col bg-white border-r border-slate-200 h-full z-20 shrink-0 sidebar-transition w-64 shadow-soft">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between h-16">
                <div id="sidebar-logo-content" class="flex items-center gap-3 overflow-hidden whitespace-nowrap transition-opacity duration-200">
                    <div class="bg-indigo-600 p-1.5 rounded-lg text-white shrink-0 shadow-md shadow-indigo-200">
                        <i data-lucide="package" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-sm font-bold tracking-tight text-slate-900 leading-none">Logística</h1>
                        <p class="text-[10px] text-indigo-600 font-bold uppercase tracking-wider mt-0.5">Painel Central</p>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="p-1.5 rounded-md text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto overflow-x-hidden py-4 px-3">
                <p id="nav-label" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-3 mb-3">Navegação</p>
                <nav class="space-y-1" id="sidebar-nav"></nav>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50/50" id="sidebar-footer"></div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden relative bg-[#f8fafc]">
            <!-- Mobile Header -->
            <header class="md:hidden bg-white border-b border-slate-200 flex-shrink-0 z-30 shadow-sm">
                <div class="px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <div class="bg-indigo-600 p-1.5 rounded-lg text-white"><i data-lucide="package" class="w-5 h-5"></i></div>
                        <span class="font-bold text-slate-900">Logística</span>
                    </div>
                    <button onclick="logout()" class="text-slate-400 hover:text-red-600"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
                <div class="px-2 pb-2 overflow-x-auto no-scrollbar flex gap-2" id="mobile-nav"></div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" id="app-content"></main>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script>
        // --- 1. Utilitários ---
        function escapeHtml(text) {
            if (text === null || text === undefined) return "";
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function getLocalDateString(isoString) {
            if (!isoString) return '';
            try { return new Date(new Date(isoString).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0]; } catch (e) { return ''; }
        }

        function safeParse(key, fallbackValue) {
            try { return JSON.parse(localStorage.getItem(key)) || fallbackValue; } catch { return fallbackValue; }
        }

        function showToast(message, type = 'success') {
            const styles = type === 'success' ? 'bg-indigo-900 text-white' : 'bg-red-600 text-white';
            const icon = type === 'success' ? 'check' : 'alert-circle';
            const toast = document.createElement('div');
            toast.className = `toast-msg ${styles} text-sm font-medium py-3 px-5 rounded-lg shadow-lg flex items-center gap-3 pointer-events-none transform transition-all border border-white/10`;
            toast.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i> ${message}`;
            document.body.appendChild(toast);
            if (typeof lucide !== 'undefined') lucide.createIcons();
            setTimeout(() => { if(toast.parentNode) toast.parentNode.removeChild(toast); }, 3000);
        }

        // --- 2. Estado ---
        const DEFAULT_DESTINOS = [
            { name: "Clínica Mult 1", street: "Av. Principal", number: "100", neighborhood: "Centro" },
            { name: "Clínica Mult 2", street: "Rua das Flores", number: "250", neighborhood: "Jardins" },
            { name: "Laboratório Novo", street: "Av. Industrial", number: "900", neighborhood: "Distrito" },
            { name: "CAMU", street: "Praça Central", number: "1", neighborhood: "Centro" }
        ];
        const DEFAULT_DRIVERS = [{ name: "João Silva", phone: "" }, { name: "Maria Oliveira", phone: "" }, { name: "Carlos Santos", phone: "" }];
        
        const DEFAULT_CATALOG = [
            "AÇUCAR SACHET UNIÃO", "AÇUCAR UNIÃO REFINADO", "ADOÇANTE ZERO CAL 100ML", "AGENDA DIARIA ESPIRAL", 
            "AGUA SANITARIA 2L", "ALCOOL 1L", "ALCOOL GEL 70% 800ML", "ALMOFADAP/CARIMBO Nº3 AZUL", 
            "ALMOFADAP/CARIMBO Nº3 PRETA", "ALMOFADAP/CARIMBO Nº3 VERMELHA", "APONTADOR COM LIXEIRA", "BOBINA SENHA ATENDIMENTO PAPEL TERMICO 80 MM", 
            "BOM AR 500ML", "BORRACHA TK PLASTICA PEQUENA", "CADERNO 1/4 BROC. C/DURA 96F", "CADERNO 1/4 BROC. INDICE A/Z 96F", 
            "CADERNO 1/4 BROC. PROTOCOLO 96F", "CADERNO UNIVERSITARIO 1X1 96F", "CAIXA ARQUIVO MORTO PAPELÃO", "CALCULADORA", 
            "CANETA BIC CRISTAL 1.6MM", "CANETA ESFEROGRAFICA AZUL", "CANETA ESFEROGRAFICA PILOT", "CANETA ESFEROGRAFICA PRETA", 
            "CANETA ESFEROGRAFICA VERMELHA", "CANETA MARCA TEXTO AMARELO", "CANETA MARCA TEXTO AZUL", "CANETA PARA QUADRO BRANCO AZUL", 
            "CANETA PARA QUADRO BRANCO PRETA", "CANETA PARA QUADRO BRANCO VERMELHA", "CANETA RETROPROJETOR 2.0 MM AZUL", "CANETA RETROPROJETOR 2.0 MM PRETA", 
            "CANETA RETROPROJETOR 2.0 MM VERMELHA", "CAPA P/ ENCADERNAÇÃO A4 PRETA", "CAPA P/ ENCADERNAÇÃO TRANSPARENTE", "CARTÃO PONTO MENSAL", 
            "CERA BRILHO FÁCIL 750 ML", "CHÁ MATTE", "CLIPS Nº 3", "CLIPS Nº 4", "CLIPS Nº8", "COLA BASTÃO 10G", "COLA TENAZ LIQ 40G", 
            "COPO DESCARTÁVEL 180 ML", "COPO DESCARTAVEL 50ML", "CORRETIVO FITA", "CORRETIVO PINCEL", "CORRETIVO TIPO CANETA", 
            "DECLARAÇÃO ATENDENTE CAMU BL 50F", "DECLARAÇÃO SESSÃO TERAPIA - ENDEREÇO MULTI", "DESINFETANTE 2L", "DETERGENTE LIQUIDO 500ML", 
            "ELASTICO SUPER RESISTENTE 1KG", "ENVELOPE A4 26X36", "ENVELOPE COMERCIAL JANELA 22X15,7CM PAPEL OFFSET", "ENVELOPE OFICIO C/JANELA", 
            "ENVELOPE OFICIO S/JANELA", "ENVELOPE PARDO 18,5X25", "ENVELOPE PARDO 31X41", "ESPONJA MAGICA", "ESPONJA SCOTH BRITE", 
            "EXTRATOR DE GRAMPOS", "FIBRA LIMPEZA LEVE", "FIBRA LIMPEZA USO GERAL", "FICHA C/PAUTA 5X8 100 FLS", "FILTRO DE PAPEL N°103", 
            "FILTRO REFIL ECO IBBL SPECIALE", "FITA ADESIVA PEQUENA", "FITA CREPE BRANCA", "FITA DUPLA FACE", "FITA LARGA TRANSPARENTE", 
            "FITA P/ MAQUINA DE CALCULAR", "FLANELA", "FLANELA BRANCA 38X58 GRANDE", "FOSFORO EXTRA LONGO", "GRAFITE 2B 0.5", 
            "GRAFITE 2B 0.7", "GRAMPEADOR MÉDIO", "GRAMPO 106/6 CX 5000UN", "GRAMPO 26/6 GALVANIZADO CX 5000 UM", "GRAMPO TRUNFO Nº2 CX COM 50 UM", 
            "GUIA DE COMPROVANTE PRESENCIAL", "INSETICIDA AEROSOL 300ML", "LAPIS PRETO FABER", "LAPISEIRA 0.5", "LAPISEIRA 0.7", 
            "LEITE SEMI DESNATADO", "LIMPADOR MULTIUSO DESTAC", "LIMPADOR SAPOLIO 300ML", "LIMPADOR VEJA MULTI USO 500ML", "LIVRO ATA 100 FLS", 
            "LIXEIRA DE ESCRITORIO", "LUSTRA MOVEIS 500ML", "LUVA LIMPEZA SANRO TOP M", "MARGARINA 500G", "MEXEDOR PARA CAFÉ 500UN", 
            "OLEO DE PEROBA 100ML", "PANO DE CHÃO SACO ALVEJADO", "PANO PERFEX", "PAPEL CARBONO FILME PRETO", "PAPEL HIGIÊNICO 300MT", 
            "PAPEL HIGIÊNICO 4ROLOS", "PAPEL INTERFOLHAS C/700", "PAPEL OPALINE 180G PCT 50 UM", "PAPEL SULFITE A4 BRANCO 500 FLS", 
            "PASTA A/Z LOMBO ESTREITO", "PASTA A/Z LOMBO LARGO", "PASTA A4 PLÁSTICA C/PRESILHA TRANSPARENTE", "PASTA CATÁLOGO C/100 PLASTICO", 
            "PASTA GRANDE COM ABA E ELASTICO TRANSPARENTE", "PASTA L A4 TRANSPARENTE", "PASTA POLIONDAS LOMBADA VERDE", "PASTA SANF. PLASTICA OFICIO 31DIV", 
            "PASTA SUSPENSA PLAST. MARM. COMPL", "PERCEVEJO C/100", "PILHA AAA", "PILHA GRANDE D", "PILHA PEQUENA AA", "PLASTICO RESISTENTE PASTA 04 FUROS", 
            "PO DE CAFÉ", "POST IT 100 FLS", "PROTOCOLO DE ENTREGA DE GUIAS", "RECIBO COMERCIAL BLOCO 50 FLS", "REFRESCO TANG", 
            "REGUA ACRILICA 30 CM", "RELATÓRIO TERAPEUTICO - LOGO UNIMED - SEM ENDEREÇO", "REMOVEDOR DE CERA 1L", "RODO COM CABO", "SABÃO EM PÓ", 
            "SABÃO EM PEDRA 5UN", "SABONETE LIQUIDO ERVA DOCE 800ML", "SACO DE LIXO 100L", "SACO DE LIXO 200L", "SACO DE LIXO 20L", "SACO DE LIXO 40L", 
            "SADT BLOCO 100 FOLHAS", "TELEFONE COM FIO PRETO", "TESOURA ESCOLAR 20CM", "TINTA P/CARIMBO AZUL", "TINTA P/CARIMBO PRETA", 
            "TINTA P/CARIMBO VERMELHA", "TOALHA DE PAPEL snog", "TONER 83A", "TONER 85A", "VASSOURA"
        ].sort();

        const INITIAL_BOXES = [1,2,3,4].map(id => ({ id, name: `Caixa ${id}`, status: 'available', items: [], destination: null, driver: null }));

        const storedCatalog = safeParse('logistica_catalog', []);
        const initialCatalog = (storedCatalog.length > 0) ? storedCatalog : DEFAULT_CATALOG;

        let state = {
            isLoggedIn: localStorage.getItem('logistica_auth') === 'true',
            boxes: safeParse('logistica_boxes', INITIAL_BOXES),
            history: safeParse('logistica_history', []),
            missingItems: safeParse('logistica_missing', []),
            destinations: safeParse('logistica_destinations', DEFAULT_DESTINOS),
            drivers: safeParse('logistica_drivers', DEFAULT_DRIVERS),
            catalog: initialCatalog,
            activeTab: localStorage.getItem('logistica_activeTab') || 'dashboard',
            currentUser: localStorage.getItem('logistica_currentUser') || "Logistica",
            modal: { type: null, boxId: null, data: null },
            historyFilter: { search: '', date: '' },
            historyView: 'today',
            expandedDate: null,
            sidebarCollapsed: safeParse('logistica_sidebar_collapsed', false),
            dragSourceIndex: null,
            missingTab: 'pending',
            missingDateFilter: ''
        };

        // --- 3. Autenticação & Persistência ---
        function handleLogin(e) {
            e.preventDefault();
            if (e.target.password.value === '1234') {
                state.isLoggedIn = true; localStorage.setItem('logistica_auth', 'true'); renderApp();
            } else { showToast("Senha Incorreta", "error"); }
        }
        function logout() { state.isLoggedIn = false; localStorage.removeItem('logistica_auth'); renderApp(); }
        
        function saveData(skipRender = false) {
            localStorage.setItem('logistica_boxes', JSON.stringify(state.boxes));
            localStorage.setItem('logistica_history', JSON.stringify(state.history));
            localStorage.setItem('logistica_missing', JSON.stringify(state.missingItems));
            localStorage.setItem('logistica_destinations', JSON.stringify(state.destinations));
            localStorage.setItem('logistica_drivers', JSON.stringify(state.drivers));
            localStorage.setItem('logistica_catalog', JSON.stringify(state.catalog));
            localStorage.setItem('logistica_activeTab', state.activeTab);
            localStorage.setItem('logistica_sidebar_collapsed', JSON.stringify(state.sidebarCollapsed));
            if (!skipRender) renderApp();
        }

        function addHistoryLog(action, details, boxName) {
            state.history.unshift({ id: Date.now(), timestamp: new Date().toISOString(), action, details, boxName, user: state.currentUser });
        }

        // --- 4. Ações de Backup ---
        function handleExportBackup() {
            const dataStr = JSON.stringify(state);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            showToast("Backup gerado!", "success");
        }
        
        function handleImportBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    state.pendingImport = data; 
                    openModal('confirmImport');
                } catch { showToast("Arquivo inválido", "error"); }
            };
            reader.readAsText(file);
        }

        function toggleMenu(e, id) {
            e.stopPropagation();
            const menu = document.getElementById(`menu-${id}`);
            document.querySelectorAll('[id^="menu-"]').forEach(el => {
                if (el.id !== `menu-${id}`) el.classList.add('hidden');
            });
            if (menu) menu.classList.toggle('hidden');
        }

        function executeImport() {
            if (state.pendingImport) {
                state = { ...state, ...state.pendingImport, isLoggedIn: true };
                state.pendingImport = null;
                saveData(); 
                closeModal();
                showToast("Dados restaurados com sucesso!", "success");
            }
        }

        // --- 5. Drag & Drop ---
        function enableDrag(e, idx) { document.getElementById(`card-${idx}`).setAttribute('draggable', 'true'); }
        function disableDrag(e, idx) { document.getElementById(`card-${idx}`).setAttribute('draggable', 'false'); }
        function handleDragStart(e, idx) { state.dragSourceIndex = idx; e.target.classList.add('dragging'); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target')); }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnter(e) { 
            const card = e.target.closest('.group\\/card-container');
            if (card && parseInt(card.dataset.index) !== state.dragSourceIndex) card.classList.add('drop-target');
        }
        function handleDragLeave(e) {
            const card = e.target.closest('.group\\/card-container');
            if (card) card.classList.remove('drop-target');
        }
        function handleDrop(e, targetIndex) {
            e.preventDefault();
            if (state.dragSourceIndex !== null && state.dragSourceIndex !== targetIndex) {
                const item = state.boxes.splice(state.dragSourceIndex, 1)[0];
                state.boxes.splice(targetIndex, 0, item);
                saveData();
                showToast("Ordem das caixas atualizada!", "success");
            }
        }

        // --- 6. Handlers de Negócio (Caixas e Itens) ---
        
        function handleInputSearch(input) {
            const val = input.value.toLowerCase();
            const list = document.getElementById('suggestions-list');
            if (!list) return;
            if (!val) { list.classList.add('hidden'); return; }
            const matches = state.catalog.filter(item => item.toLowerCase().includes(val));
            if (matches.length === 0) { list.classList.add('hidden'); return; }
            list.innerHTML = matches.map(item => `<li onclick="selectItem('${escapeHtml(item)}')" class="px-4 py-2.5 hover:bg-indigo-50 cursor-pointer text-sm text-slate-700 transition-colors flex items-center gap-2 border-b border-indigo-50 last:border-0"><i data-lucide="package" class="w-3.5 h-3.5 text-indigo-400"></i> ${escapeHtml(item)}</li>`).join('');
            list.classList.remove('hidden');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function selectItem(val) {
            const input = document.querySelector('input[name="itemName"]');
            if(input) {
                input.value = val;
                document.getElementById('suggestions-list').classList.add('hidden');
                input.focus();
            }
        }

        function handleAddItem(e) {
            e.preventDefault();
            const form = e.target;
            const itemName = form.itemName.value.trim();
            const quantity = parseInt(form.quantity.value);
            const unitType = form.unitType.value;
            const isExternal = form.isExternal.checked;
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            if (!itemName) { showToast("Digite o nome do item.", "error"); return; }
            const itemExistsInCatalog = state.catalog.some(c => c.toLowerCase() === itemName.toLowerCase());
            if (!itemExistsInCatalog) { showToast("Item não encontrado no catálogo.", "error"); return; }
            if (quantity < 1) { showToast("Quantidade inválida.", "error"); return; }
            if (box) {
                const existing = box.items.find(i => i.name.toLowerCase() === itemName.toLowerCase() && i.isExternal === isExternal && i.unitType === unitType);
                if (existing) existing.quantity += quantity;
                else box.items.push({ name: itemName, quantity, isExternal, unitType });
                addHistoryLog('Adição', `Adicionado ${quantity} ${unitType} de ${itemName}`, box.name);
                showToast("Item adicionado com sucesso!", "success");
                saveData(); 
                form.itemName.value = ''; form.quantity.value = '1'; form.isExternal.checked = false; form.itemName.focus(); 
                const suggestions = document.getElementById('suggestions-list');
                if (suggestions) suggestions.classList.add('hidden');
            }
        }

        function handleUpdateItem(e) {
            e.preventDefault();
            const form = e.target;
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            const itemIndex = state.modal.data;
            const item = box.items[itemIndex];
            if (!box || !item) return;
            const newName = form.itemName.value.trim();
            const newQuantity = parseInt(form.quantity.value);
            const newUnit = form.unitType.value;
            const newIsExternal = form.isExternal.checked;
            if (!newName) { showToast("Nome inválido.", "error"); return; }
            if (newQuantity < 1) { showToast("Quantidade inválida.", "error"); return; }
            item.name = newName; item.quantity = newQuantity; item.unitType = newUnit; item.isExternal = newIsExternal;
            addHistoryLog('Alteração', `Item editado: ${newName} (${newQuantity}${newUnit})`, box.name);
            saveData(); closeModal(); showToast("Item atualizado com sucesso!", "success");
        }

        function handleDelivery(e) {
            e.preventDefault();
            const form = e.target;
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            let dest = form.destination.value;
            if (form.customName && form.customName.value) {
                dest = form.customName.value;
                state.destinations.push({ name: dest, street: form.customStreet.value, number: form.customNumber.value, neighborhood: form.customNeighborhood.value });
            }
            if (!dest) { showToast("Selecione um destino.", "error"); return; }
            if (!form.driver.value) { showToast("Selecione um motorista.", "error"); return; }
            if (box) {
                box.status = 'in_delivery'; box.destination = dest; box.driver = form.driver.value;
                const itemsStr = box.items.map(i => `${i.quantity}${i.unitType} ${i.name}`).join(', ');
                addHistoryLog('Saída', `Saiu para entrega em: ${dest} (Mot: ${box.driver})\nConteúdo: ${itemsStr}`, box.name);
                showToast("Saída registrada com sucesso!", "success"); closeModal(); saveData();
            }
        }

        function handleCompleteDelivery() {
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            if(box) { 
                box.status = 'delivered'; 
                addHistoryLog('Entrega', `Entregue em: ${box.destination}`, box.name); 
                saveData(); closeModal(); 
                showToast("Entrega confirmada com sucesso!", "success");
            }
        }

        function handleSeparateBox() {
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            if(box) {
                box.status = 'separated';
                addHistoryLog('Separação', 'Itens separados e prontos para envio', box.name);
                saveData(); closeModal();
                showToast("Caixa marcada como Separada!", "success");
            }
        }

        function handleResetBox() {
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            if(box) { 
                box.status = 'available'; box.items = []; box.destination = null; box.driver = null; 
                addHistoryLog('Status', 'Caixa esvaziada', box.name); 
                saveData(); closeModal(); 
                showToast("Caixa esvaziada e disponível!", "success");
            }
        }

        function handleAddBox(e) {
            e.preventDefault();
            const name = e.target.boxName.value.trim();
            if (!name) { showToast("Digite o nome da caixa.", "error"); return; }
            state.boxes.push({ id: Date.now(), name, status: 'available', items: [] });
            addHistoryLog('Criação', `Nova caixa: ${name}`, 'Sistema');
            saveData(); closeModal();
            showToast("Nova caixa criada!", "success");
        }
        
        function handleEditBox(e) {
            e.preventDefault();
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            const newName = e.target.boxName.value.trim();
            if (box && newName) { 
                box.name = newName; 
                saveData(); closeModal(); 
                showToast("Nome da caixa atualizado!", "success");
            }
        }

        function confirmDeleteBox() {
            const idx = state.boxes.findIndex(b => b.id === state.modal.boxId);
            if (idx > -1) { 
                state.boxes.splice(idx, 1); 
                saveData(); closeModal(); 
                showToast("Caixa removida com sucesso!", "success");
            }
        }
        
        function confirmDeleteItem() {
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            if (box) { 
                box.items.splice(state.modal.data, 1); 
                saveData(); closeModal(); 
                showToast("Item removido!", "success");
            }
        }

        function handleReportMissing(e) {
            e.preventDefault();
            const form = e.target;
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            const itemName = form.itemName.value.trim();
            const itemExistsInCatalog = state.catalog.some(c => c.toLowerCase() === itemName.toLowerCase());
            if (!itemExistsInCatalog) { showToast("Item não encontrado no catálogo.", "error"); return; }
            state.missingItems.unshift({ 
                id: Date.now(), boxId: box.id, boxName: box.name, destination: box.destination || "N/A", 
                itemName: itemName, quantity: form.quantity.value, 
                reason: form.reason.value, status: 'pending', date: new Date().toISOString() 
            });
            if (box.status === 'delivered') box.status = 'issue';
            addHistoryLog('Falta', `Falta: ${itemName}`, box.name);
            saveData(); showToast("Falta registrada com sucesso!", "success");
            form.itemName.value = ''; form.quantity.value = ''; form.reason.value = ''; form.itemName.focus(); 
            const suggestions = document.getElementById('suggestions-list');
            if (suggestions) suggestions.classList.add('hidden');
        }

        // --- 7. Handlers Adicionais ---
        
        function handleChangeDestination(e) {
            e.preventDefault();
            const form = e.target;
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            let dest = form.destination.value;
            if (form.customName && form.customName.value) {
                dest = form.customName.value;
                state.destinations.push({ name: dest, street: form.customStreet.value, number: form.customNumber.value, neighborhood: form.customNeighborhood.value });
            }
            if (box && dest) {
                box.destination = dest;
                addHistoryLog('Alteração', `Destino atualizado para: ${dest}`, box.name);
                saveData(); closeModal(); showToast("Destino atualizado!", "success");
            }
        }

        function handleChangeDriver(e) {
            e.preventDefault();
            const box = state.boxes.find(b => b.id === state.modal.boxId);
            if (box) {
                box.driver = e.target.newDriver.value || null;
                addHistoryLog('Alteração', `Motorista alterado`, box.name);
                saveData(); closeModal(); showToast("Motorista atualizado!", "success");
            }
        }

        function handleAddDestination(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.newName.value.trim();
            if(!name) return;
            state.destinations.push({ name, street: form.newStreet.value, number: form.newNumber.value, neighborhood: form.newNeighborhood.value });
            saveData(); showToast("Endereço cadastrado!", "success");
            form.reset();
        }

        function handleAddDriver(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.newDriverName.value.trim();
            if(!name) return;
            state.drivers.push({ name, phone: form.newDriverPhone.value });
            saveData(); showToast("Motorista cadastrado!", "success");
            form.reset();
        }

        function handleAddCatalogItem(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.newItemName.value.trim();
            if (!name) return;
            if (state.catalog.some(i => i.toLowerCase() === name.toLowerCase())) { showToast("Este item já existe no catálogo.", "error"); return; }
            state.catalog.push(name);
            state.catalog.sort((a, b) => a.localeCompare(b));
            saveData(); showToast("Item adicionado ao catálogo!", "success");
            form.reset();
            renderCatalogPanel();
        }

        function handleEditCatalogItem(e) {
            e.preventDefault();
            const idx = state.modal.data;
            const newName = e.target.newItemName.value.trim();
            const oldName = state.catalog[idx]; // Captura o nome antigo antes de mudar
            
            if (!newName) {
                showToast("O nome não pode estar vazio.", "error");
                return;
            }

            const exists = state.catalog.some((item, i) => i !== idx && item.toLowerCase() === newName.toLowerCase());
            if (exists) {
                showToast("Este item já existe no catálogo.", "error");
                return;
            }

            // 1. Atualiza no Catálogo
            state.catalog[idx] = newName;
            state.catalog.sort((a, b) => a.localeCompare(b)); 

            // 2. Atualiza em todas as Caixas (Correção Solicitada)
            let boxUpdates = 0;
            state.boxes.forEach(box => {
                box.items.forEach(item => {
                    if (item.name === oldName) {
                        item.name = newName;
                        boxUpdates++;
                    }
                });
            });

            // 3. Atualiza em Pendências de Falta (Opcional, mas recomendado para consistência)
            state.missingItems.forEach(missing => {
                if (missing.itemName === oldName && missing.status === 'pending') {
                    missing.itemName = newName;
                }
            });

            saveData();
            closeModal();
            
            if (boxUpdates > 0) {
                showToast(`Item atualizado no catálogo e em ${boxUpdates} itens nas caixas!`, "success");
            } else {
                showToast("Item do catálogo atualizado!", "success");
            }
            
            if (state.activeTab === 'catalog') { renderCatalogPanel(); }
        }

        function confirmDeleteCatalogItem() {
            state.catalog.splice(state.modal.data, 1);
            saveData(); closeModal(); showToast("Item removido do catálogo!", "success");
            if (state.activeTab === 'catalog') renderCatalogPanel();
        }

        function handleEditDestination(e) {
            e.preventDefault();
            const idx = state.modal.data;
            const form = e.target;
            state.destinations[idx] = { name: form.editName.value, street: form.editStreet.value, number: form.editNumber.value, neighborhood: form.editNeighborhood.value };
            saveData(); closeModal(); showToast("Endereço atualizado!", "success");
        }

        function handleEditDriver(e) {
            e.preventDefault();
            const idx = state.modal.data;
            state.drivers[idx] = { name: e.target.editDriverName.value, phone: e.target.editDriverPhone.value };
            saveData(); closeModal(); showToast("Motorista atualizado!", "success");
        }

        function confirmDeleteLocation() {
            state.destinations.splice(state.modal.data, 1);
            saveData(); closeModal(); showToast("Endereço removido!", "success");
        }

        function confirmDeleteDriver() {
            state.drivers.splice(state.modal.data, 1);
            saveData(); closeModal(); showToast("Motorista removido!", "success");
        }

        function handleEditMissing(e) {
            e.preventDefault();
            const idx = state.modal.data;
            const form = e.target;
            state.missingItems[idx].itemName = form.editItemName.value;
            state.missingItems[idx].quantity = form.editQuantity.value;
            state.missingItems[idx].reason = form.editReason.value;
            saveData(); closeModal(); showToast("Registro de falta atualizado!", "success");
        }

        function confirmDeleteMissing() {
            state.missingItems.splice(state.modal.data, 1);
            saveData(); closeModal(); showToast("Registro removido!", "success");
        }

        function resolveMissingItem(id) {
            const item = state.missingItems.find(i => i.id === id);
            if(item) { item.status = 'resolved'; saveData(); showToast("Item resolvido e arquivado!", "success"); }
        }
        
        function setMissingTab(tab) {
            state.missingTab = tab;
            state.missingDateFilter = '';
            renderApp();
        }

        function setMissingDateFilter(date) {
            state.missingDateFilter = date;
            renderApp();
        }

        function toggleDateAccordion(date) { 
            state.expandedDate = state.expandedDate === date ? null : date; 
            renderApp(); 
        }

        function toggleSidebar() { 
            state.sidebarCollapsed = !state.sidebarCollapsed; 
            saveData(true); 
            renderApp(); 
        }

        function handleHistoryFilter(key, value) { 
            state.historyFilter[key] = value; 
            if (state.activeTab === 'history') renderHistory();
        }
        
        function clearHistoryFilters() { 
            state.historyFilter = { search: '', date: '' }; 
            if (state.activeTab === 'history') renderHistory();
        }

        function setHistoryView(view) { 
            state.historyView = view; 
            renderApp(); 
        }

        function printSingleBoxMissing(boxId) {
             const items = state.missingItems.filter(m => m.boxId === boxId);
             if (!items.length) { showToast("Não há faltas para esta caixa.", "error"); return; }
             const boxName = items[0].boxName;
             const destination = items[0].destination;
             const rows = items.map(m => `<tr><td style="padding:8px;border-bottom:1px solid #e2e8f0;color:#334155;">${new Date(m.date).toLocaleDateString('pt-BR')}</td><td style="padding:8px;border-bottom:1px solid #e2e8f0;font-weight:bold;color:#c0392b;">${m.quantity}x ${escapeHtml(m.itemName)}</td><td style="padding:8px;border-bottom:1px solid #e2e8f0;font-style:italic;color:#64748b;">${escapeHtml(m.reason || '-')}</td><td style="padding:8px;border-bottom:1px solid #e2e8f0;font-size:11px;">${m.status === 'resolved' ? '<span style="color:green">Resolvido</span>' : '<span style="color:red">Pendente</span>'}</td></tr>`).join('');
             const contentHtml = `<div style="border:1px solid #cbd5e1;border-radius:6px;overflow:hidden;"><div style="background-color:#f1f5f9;padding:15px;border-bottom:1px solid #cbd5e1;"><h2 style="margin:0;font-size:18px;color:#0f172a;">${escapeHtml(boxName)}</h2><p style="margin:5px 0 0 0;font-size:14px;color:#475569;">Destino: <strong>${escapeHtml(destination)}</strong></p></div><table style="width:100%;border-collapse:collapse;font-size:13px;"><thead><tr style="background-color:#ffffff;text-align:left;border-bottom:1px solid #e2e8f0;"><th style="padding:10px;width:90px;color:#64748b;">Data</th><th style="padding:10px;color:#64748b;">Item Faltante</th><th style="padding:10px;color:#64748b;">Motivo/Obs</th><th style="padding:10px;width:80px;color:#64748b;">Status</th></tr></thead><tbody>${rows}</tbody></table></div>`;
             const html = `<html><head><title>Faltas - ${escapeHtml(boxName)}</title><style>body{font-family:sans-serif;padding:30px;color:#1e293b;}@media print{.no-print{display:none}}</style></head><body><h1>Relatório de Faltas - Caixa Individual</h1>${contentHtml}<script>window.onload=()=>{window.print()}<\/script></body></html>`;
             const win = window.open('', '_blank');
             if(win) { win.document.write(html); win.document.close(); } else { showToast("Pop-up bloqueado.", "error"); }
        }

        function printMissingItems() {
            if (!state.missingItems.length) { showToast("Não há faltas para imprimir.", "error"); return; }
            const grouped = {};
            state.missingItems.forEach(item => {
                const key = `${item.boxName}-${item.destination}`;
                if (!grouped[key]) { grouped[key] = { boxName: item.boxName, destination: item.destination, items: [] }; }
                grouped[key].items.push(item);
            });
            let contentHtml = '';
            Object.values(grouped).forEach(group => {
                const rows = group.items.map(m => `<tr><td style="padding:8px;border-bottom:1px solid #e2e8f0;color:#334155;">${new Date(m.date).toLocaleDateString('pt-BR')}</td><td style="padding:8px;border-bottom:1px solid #e2e8f0;font-weight:bold;color:#c0392b;">${m.quantity}x ${escapeHtml(m.itemName)}</td><td style="padding:8px;border-bottom:1px solid #e2e8f0;font-style:italic;color:#64748b;">${escapeHtml(m.reason || '-')}</td><td style="padding:8px;border-bottom:1px solid #e2e8f0;font-size:11px;">${m.status === 'resolved' ? '<span style="color:green">Resolvido</span>' : '<span style="color:red">Pendente</span>'}</td></tr>`).join('');
                contentHtml += `<div style="margin-bottom:25px;border:1px solid #cbd5e1;border-radius:6px;overflow:hidden;page-break-inside:avoid;page-break-after:always;"><div style="background-color:#f1f5f9;padding:10px 15px;border-bottom:1px solid #cbd5e1;"><div style="font-size:16px;font-weight:bold;color:#0f172a;">${escapeHtml(group.boxName)}</div><div style="font-size:12px;color:#475569;margin-top:2px;">Destino: <strong style="color:#1e40af;">${escapeHtml(group.destination)}</strong></div></div><table style="width:100%;border-collapse:collapse;font-size:12px;"><thead><tr style="background-color:#ffffff;text-align:left;border-bottom:1px solid #e2e8f0;"><th style="padding:8px;width:80px;color:#64748b;">Data</th><th style="padding:8px;color:#64748b;">Item Faltante</th><th style="padding:8px;color:#64748b;">Motivo/Obs</th><th style="padding:8px;width:60px;color:#64748b;">Status</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            });
            const html = `<html><head><title>Relatório de Faltas</title><style>body{font-family:sans-serif;padding:30px;color:#1e293b;max-width:900px;margin:0 auto;}h1{color:#1e3a8a;border-bottom:2px solid #3b82f6;padding-bottom:10px;margin-bottom:5px;font-size:22px;}.subtitle{font-size:12px;color:#64748b;margin-bottom:30px;}@media print{body{padding:0;}.no-print{display:none;}}</style></head><body><h1>Relatório de Faltas e Pendências</h1><div class="subtitle">Gerado em: ${new Date().toLocaleString('pt-BR')}</div>${contentHtml}<script>window.onload=function(){window.print();}<\/script></body></html>`;
            const win = window.open('', '_blank');
            if(win) { win.document.write(html); win.document.close(); } else { showToast("Pop-up bloqueado.", 'error'); }
        }

        function printBox(boxId) {
            const box = state.boxes.find(b => b.id === boxId);
            if (!box) return;
            const dest = state.destinations.find(d => d.name.trim().toLowerCase() === (box.destination || '').trim().toLowerCase());
            let addressStr = `<div style="font-size:16px;font-weight:600;color:#1e3a8a;">${escapeHtml(box.destination || 'N/A')}</div>`;
            if (dest && (dest.street || dest.neighborhood)) {
                const street = dest.street ? escapeHtml(dest.street) : '';
                const num = dest.number ? `, ${escapeHtml(dest.number)}` : '';
                const hood = dest.neighborhood ? ` - ${escapeHtml(dest.neighborhood)}` : '';
                addressStr += `<div style="font-size:12px;font-weight:normal;color:#555;margin-top:4px;">${street}${num}${hood}</div>`;
            }
            const internal = box.items.filter(i => !i.isExternal);
            const external = box.items.filter(i => i.isExternal);
            const renderList = (items) => items.map(i => `<li style="padding:8px 0;border-bottom:1px solid #e0f2fe;display:flex;align-items:center;font-size:14px;"><span style="display:inline-block;width:16px;height:16px;border:1px solid #1e40af;margin-right:12px;border-radius:2px;"></span><span style="font-weight:bold;margin-right:6px;background-color:#eff6ff;padding:2px 6px;border-radius:4px;border:1px solid #bfdbfe;">${i.quantity}${i.unitType==='fd'?' Fd':i.unitType==='cx'?' Cx':' Un'}</span> ${escapeHtml(i.name)}</li>`).join('');
            const driverObj = state.drivers.find(d => d.name === box.driver);
            const driverPhone = driverObj ? driverObj.phone : '';
            const driverDisplay = box.driver ? (driverPhone ? `${escapeHtml(box.driver)}<br><span style="font-size:11px;font-weight:normal;">${escapeHtml(driverPhone)}</span>` : escapeHtml(box.driver)) : '-';
            const html = `<html><head><title>Manifesto ${escapeHtml(box.name)}</title><style>body{font-family:sans-serif;padding:20px;color:#1e3a8a;}.header{border-bottom:2px solid #1e3a8a;padding-bottom:20px;margin-bottom:30px;display:flex;justify-content:space-between;align-items:flex-end;}.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;background:#eff6ff;padding:20px;border-radius:8px;border:1px solid #bfdbfe;}.label{font-size:11px;text-transform:uppercase;font-weight:bold;color:#60a5fa;margin-bottom:2px;}.value{font-size:16px;font-weight:600;color:#1e3a8a;}h2{font-size:18px;border-bottom:2px solid #bfdbfe;padding-bottom:5px;margin-top:25px;color:#1e40af;}ul{list-style:none;padding:0;}.sign-line{border-top:1px solid #1e3a8a;flex:1;padding-top:5px;text-align:center;margin-top:50px;font-size:12px;color:#1e3a8a;}@media print{.info-grid{background:none;border:1px solid #bfdbfe;}h2{border-bottom:2px solid #bfdbfe;}body{-webkit-print-color-adjust:exact;}}</style></head><body><div class="header"><div><h1 style="margin:0;color:#1e3a8a;font-size:28px;">${escapeHtml(box.destination || "Logística Central")}</h1><div style="color:#3b82f6;">Controle de Entrega</div></div><div style="text-align:right;"><div class="value" style="font-size:24px;">${escapeHtml(box.name)}</div></div></div><div class="info-grid"><div><div class="label">Destino</div>${addressStr}</div><div><div class="label">Data</div><div class="value">${new Date().toLocaleDateString('pt-BR')}</div></div><div><div class="label">Status</div><div class="value">${box.status==='in_delivery'?'Em Entrega':box.status==='delivered'?'Entregue':'Disponível'}</div></div><div><div class="label">Motorista</div><div class="value">${driverDisplay}</div></div></div>${internal.length > 0 ? `<h2>Conteúdo (${internal.reduce((a,i)=>a+(i.quantity||1),0)})</h2><ul>${renderList(internal)}</ul>` : ''}${external.length > 0 ? `<h2>Itens Fora da Caixa (${external.reduce((a,i)=>a+(i.quantity||1),0)})</h2><ul>${renderList(external)}</ul>` : ''}${internal.length===0 && external.length===0 ? '<p style="text-align:center;color:#93c5fd;margin-top:20px;">Vazio</p>' : ''}<div style="display:flex;gap:40px;margin-top:60px;"><div class="sign-line">Assinatura Expedição</div><div class="sign-line">Assinatura Recebimento</div></div><script>window.onload=function(){window.print();}<\/script></body></html>`;
            const win = window.open('', '_blank');
            if(win) { win.document.write(html); win.document.close(); } else { showToast("Pop-up bloqueado.", 'error'); }
        }

        function printHistoryManifest(logId) {
            const log = state.history.find(l => l.id === logId);
            if (!log) return;
            let destinationName = "Desconhecido";
            let driverName = "Desconhecido";
            let itemsText = "";
            const destMatch = log.details.match(/Saiu para entrega em: (.*?) \(Mot:/);
            if (destMatch) destinationName = destMatch[1];
            const driverMatch = log.details.match(/\(Mot: (.*?)\)/);
            if (driverMatch) driverName = driverMatch[1];
            if (log.details.includes("Conteúdo: ")) { itemsText = log.details.split("Conteúdo: ")[1]; }
            const destObj = state.destinations.find(d => d.name.trim().toLowerCase() === destinationName.trim().toLowerCase());
            const driverObj = state.drivers.find(d => d.name.trim().toLowerCase() === driverName.trim().toLowerCase());
            let addressStr = `<div style="font-size:16px;font-weight:600;color:#1e3a8a;">${escapeHtml(destinationName)}</div>`;
            if (destObj) {
                const street = destObj.street ? escapeHtml(destObj.street) : '';
                const num = destObj.number ? `, ${escapeHtml(destObj.number)}` : '';
                const hood = destObj.neighborhood ? ` - ${escapeHtml(destObj.neighborhood)}` : '';
                if(street || hood) { addressStr += `<div style="font-size:12px;font-weight:normal;color:#555;margin-top:4px;">${street}${num}${hood}</div>`; }
            }
            let driverDisplay = escapeHtml(driverName);
            if (driverObj && driverObj.phone) { driverDisplay += `<br><span style="font-size:11px;font-weight:normal;">${escapeHtml(driverObj.phone)}</span>`; }
            let itemsHtml = '<li style="padding:10px;text-align:center;color:#999;">Sem detalhes de itens no histórico</li>';
            if (itemsText) {
                itemsHtml = itemsText.split(', ').map(itemStr => {
                    const match = itemStr.match(/^(\d+)([a-z]+)\s+(.*)$/);
                    if (match) {
                        const qtd = match[1];
                        const unit = match[2] === 'fd' ? ' Fd' : (match[2] === 'cx' ? ' Cx' : ' Un');
                        const name = match[3];
                        return `<li style="padding:8px 0;border-bottom:1px solid #e0f2fe;display:flex;align-items:center;font-size:14px;"><span style="display:inline-block;width:16px;height:16px;border:1px solid #1e40af;margin-right:12px;border-radius:2px;"></span><span style="font-weight:bold;margin-right:6px;background-color:#eff6ff;padding:2px 6px;border-radius:4px;border:1px solid #bfdbfe;">${qtd}${unit}</span> ${escapeHtml(name)}</li>`;
                    } else { return `<li style="padding:8px 0;border-bottom:1px solid #e0f2fe;display:flex;align-items:center;font-size:14px;"><span style="display:inline-block;width:16px;height:16px;border:1px solid #1e40af;margin-right:12px;border-radius:2px;"></span>${escapeHtml(itemStr)}</li>`; }
                }).join('');
            }
            const html = `<html><head><title>Cópia de Manifesto</title><style>body { font-family: sans-serif; padding: 20px; color: #1e3a8a; } .header { border-bottom: 2px solid #1e3a8a; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; } .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; background: #eff6ff; padding: 20px; border-radius: 8px; border: 1px solid #bfdbfe; } .label { font-size: 11px; text-transform: uppercase; font-weight: bold; color: #60a5fa; margin-bottom: 2px; } .value { font-size: 16px; font-weight: 600; color: #1e3a8a; } h2 { font-size: 18px; border-bottom: 2px solid #bfdbfe; padding-bottom: 5px; margin-top: 25px; color: #1e40af; } ul { list-style: none; padding: 0; } .sign-line { border-top: 1px solid #1e3a8a; flex: 1; padding-top: 5px; text-align: center; margin-top: 50px; font-size: 12px; color: #1e3a8a; } .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 100px; color: rgba(30, 58, 138, 0.05); pointer-events: none; z-index: -1; border: 5px solid rgba(30, 58, 138, 0.05); padding: 20px; border-radius: 20px; text-transform: uppercase; } @media print { .info-grid { background: none; border: 1px solid #bfdbfe; } h2 { border-bottom: 2px solid #bfdbfe; } body { -webkit-print-color-adjust: exact; } }</style></head><body><div class="watermark">CÓPIA</div><div class="header"><div><h1 style="margin:0;color:#1e3a8a;font-size:28px;">${escapeHtml(destinationName)}</h1><div style="color:#3b82f6;">Controle de Entrega (Histórico)</div></div><div style="text-align:right;"><div class="value" style="font-size:24px;">${escapeHtml(log.boxName)}</div><div style="font-size:12px;color:#666;">ID Log: ${log.id}</div></div></div><div class="info-grid"><div><div class="label">Destino</div>${addressStr}</div><div><div class="label">Data Original</div><div class="value">${new Date(log.timestamp).toLocaleDateString('pt-BR')} ${new Date(log.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div><div><div class="label">Status no Registro</div><div class="value">Enviado</div></div><div><div class="label">Motorista</div><div class="value">${driverDisplay}</div></div></div><h2>Conteúdo Registrado</h2><ul>${itemsHtml}</ul><div style="display:flex;gap:40px;margin-top:60px;"><div class="sign-line">Responsável Expedição</div><div class="sign-line">Conferência Recebimento</div></div><script>window.onload=function(){window.print();} <\/script></body></html>`;
            const win = window.open('', '_blank');
            if(win) { win.document.write(html); win.document.close(); }
            else { showToast("Pop-up bloqueado.", 'error'); }
        }

        // --- 8. Renderização (Views & Components) ---

        function renderModal() {
            const container = document.getElementById('modal-container');
            const { type, boxId, data } = state.modal;
            
            if (!type) { container.innerHTML = ''; return; }

            const box = state.boxes.find(b => b.id === boxId);
            let content = '';
            
            if (type === 'add') {
                content = `
                    <h3 class="text-xl font-bold text-slate-800 mb-6">Adicionar Item</h3>
                    <form onsubmit="handleAddItem(event)" class="space-y-5">
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-slate-600">Nome do Item</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                                    <i data-lucide="search" class="h-5 w-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                                </div>
                                <input name="itemName" type="text" class="pl-11 block w-full rounded-xl border-slate-200 bg-slate-50 border focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-3 transition-all outline-none" placeholder="Buscar no catálogo..." autocomplete="off" oninput="handleInputSearch(this)" onfocus="handleInputSearch(this)" autofocus required>
                                <ul id="suggestions-list" class="absolute z-50 w-full bg-white border border-slate-100 rounded-xl shadow-xl mt-1 max-h-48 overflow-y-auto hidden divide-y divide-slate-50 custom-scrollbar"></ul>
                            </div>
                            <p class="text-[11px] text-slate-400 font-medium ml-1">Obrigatório selecionar um item do catálogo.</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-600 mb-2">Quantidade</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none"><i data-lucide="hash" class="h-4 w-4 text-slate-400"></i></div>
                                    <input type="number" name="quantity" value="1" min="1" class="pl-10 block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white border focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-3 outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-600 mb-2">Unidade</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none"><i data-lucide="scale" class="h-4 w-4 text-slate-400"></i></div>
                                    <select name="unitType" class="pl-10 block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white border focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-3 outline-none appearance-none">
                                        <option value="un">Unidade</option>
                                        <option value="fd">Fardo</option>
                                        <option value="cx">Caixa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <label class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl border border-slate-200 cursor-pointer hover:border-indigo-200 transition-colors">
                            <input type="checkbox" name="isExternal" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-slate-300">
                            <span class="text-sm font-medium text-slate-700">Item fora da caixa (Externo)</span>
                        </label>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> Adicionar Item
                        </button>
                    </form>`;
            } else if (type === 'editItem') {
                const itemToEdit = box.items[data];
                content = `<h3 class="text-xl font-bold text-slate-800 mb-6">Editar Item</h3><form onsubmit="handleUpdateItem(event)" class="space-y-5"><div class="space-y-2"><label class="block text-sm font-semibold text-slate-600">Nome do Item</label><div class="relative"><div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none"><i data-lucide="pencil" class="h-5 w-5 text-slate-400"></i></div><input name="itemName" type="text" value="${escapeHtml(itemToEdit.name)}" class="pl-11 block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white border focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-3 outline-none" required></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-slate-600 mb-2">Quantidade</label><input type="number" name="quantity" value="${itemToEdit.quantity}" min="1" class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white border focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-3 px-4 outline-none"></div><div><label class="block text-sm font-semibold text-slate-600 mb-2">Unidade</label><select name="unitType" class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white border focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-3 px-4 outline-none"><option value="un" ${itemToEdit.unitType==='un'?'selected':''}>Unidade</option><option value="fd" ${itemToEdit.unitType==='fd'?'selected':''}>Fardo</option><option value="cx" ${itemToEdit.unitType==='cx'?'selected':''}>Caixa</option></select></div></div><label class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl border border-slate-200 cursor-pointer"><input type="checkbox" name="isExternal" ${itemToEdit.isExternal?'checked':''} class="w-5 h-5 text-indigo-600 rounded border-slate-300"><span class="text-sm font-medium text-slate-700">Item Externo</span></label><button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 flex justify-center gap-2"><i data-lucide="save" class="w-5 h-5"></i> Salvar</button></form>`;
            } else if (type === 'deliver') {
                content = `<h3 class="text-xl font-bold text-slate-800 mb-6">Registrar Saída</h3><p class="text-sm text-slate-500 mb-4 -mt-4">Caixa: <strong>${box.name}</strong></p><form onsubmit="handleDelivery(event)" class="space-y-5"><div id="dest-input-group"><label class="block text-sm font-semibold text-slate-600 mb-2">Destino</label><select name="destination" class="w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white border focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-3 px-4 outline-none mb-3" onchange="document.getElementById('customDestGroup').classList.toggle('hidden', this.value !== '')"><option value="" disabled selected>Selecione...</option>${state.destinations.map(d => `<option value="${d.name}">${d.name}</option>`).join('')}<option value="">Outro (Digitar)</option></select><div id="customDestGroup" class="hidden space-y-3 p-4 bg-yellow-50 rounded-xl border border-yellow-100"><input name="customName" placeholder="Nome do local" class="w-full rounded-lg border-yellow-200 text-sm py-2 px-3 outline-none"><input name="customStreet" placeholder="Rua" class="w-full rounded-lg border-yellow-200 text-sm py-2 px-3 outline-none"><div class="flex gap-2"><input name="customNumber" placeholder="Nº" class="w-1/3 rounded-lg border-yellow-200 text-sm py-2 px-3 outline-none"><input name="customNeighborhood" placeholder="Bairro" class="w-2/3 rounded-lg border-yellow-200 text-sm py-2 px-3 outline-none"></div></div></div><div><label class="block text-sm font-semibold text-slate-600 mb-2">Motorista</label><select name="driver" class="w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white border focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-3 px-4 outline-none" required><option value="">Selecione...</option>${state.drivers.map(d => `<option value="${d.name}">${d.name}</option>`).join('')}</select></div><button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-emerald-200 active:scale-95">Confirmar Saída</button></form>`;
            } else if (type === 'complete') {
                content = `<div class="text-center"><div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-600"><i data-lucide="check" class="w-8 h-8"></i></div><h3 class="text-xl font-bold text-slate-800 mb-2">Confirmar Recebimento</h3><p class="text-slate-500 text-sm mb-6">Deseja marcar <strong>${box.name}</strong> como entregue/devolvida?</p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-semibold text-slate-600 hover:bg-slate-50">Cancelar</button><button onclick="handleCompleteDelivery()" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-200">Confirmar</button></div></div>`;
            } else if (type === 'separate') {
                // Alterado de Violet para Blue
                content = `<div class="text-center"><div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><i data-lucide="package-check" class="w-8 h-8"></i></div><h3 class="text-xl font-bold text-slate-800 mb-2">Marcar como Separado</h3><p class="text-slate-500 text-sm mb-6">Confirmar que os itens da <strong>${box.name}</strong> foram separados?</p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-semibold text-slate-600 hover:bg-slate-50">Cancelar</button><button onclick="handleSeparateBox()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200">Confirmar</button></div></div>`;
            } else if (type === 'reset') {
                content = `<div class="text-center"><div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600"><i data-lucide="refresh-ccw" class="w-8 h-8"></i></div><h3 class="text-xl font-bold text-slate-800 mb-2">Esvaziar Caixa</h3><p class="text-slate-500 text-sm mb-6">Isso removerá todos os itens e tornará a <strong>${box.name}</strong> disponível novamente.</p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-semibold text-slate-600 hover:bg-slate-50">Cancelar</button><button onclick="handleResetBox()" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200">Esvaziar</button></div></div>`;
            } else if (type === 'missing') {
                content = `
                    <div class="flex flex-col items-center mb-6">
                        <div class="w-14 h-14 bg-rose-50 text-rose-600 rounded-full flex items-center justify-center mb-3 ring-4 ring-rose-50/50">
                            <i data-lucide="alert-triangle" class="w-7 h-7"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800">Reportar Falta</h3>
                        <p class="text-sm text-slate-500">Caixa: <strong class="text-slate-700">${box.name}</strong></p>
                    </div>

                    <form onsubmit="handleReportMissing(event)" class="space-y-5">
                        <div class="space-y-1.5 relative">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Item do Catálogo</label>
                            <div class="relative group">
                                <div class="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-rose-500 transition-colors">
                                    <i data-lucide="search" class="w-5 h-5"></i>
                                </div>
                                <input 
                                    name="itemName" 
                                    type="text" 
                                    placeholder="Digite para buscar..." 
                                    class="w-full pl-11 pr-4 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-rose-500 focus:ring-4 focus:ring-rose-500/10 outline-none transition-all text-sm font-medium text-slate-700"
                                    autocomplete="off" 
                                    oninput="handleInputSearch(this)" 
                                    onfocus="handleInputSearch(this)" 
                                    required
                                >
                                <!-- Lista de Sugestões (Dropdown) -->
                                <ul id="suggestions-list" class="absolute left-0 right-0 top-full mt-1.5 bg-white border border-slate-100 rounded-xl shadow-xl max-h-56 overflow-y-auto hidden z-50 divide-y divide-slate-50"></ul>
                            </div>
                            <p class="text-[11px] text-slate-400 ml-1">Selecione um item existente na lista.</p>
                        </div>

                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-4 space-y-1.5">
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Qtd.</label>
                                <input name="quantity" type="number" min="1" placeholder="0" required class="w-full px-3 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-rose-500 focus:ring-2 focus:ring-rose-500/10 outline-none text-center font-bold text-slate-700">
                            </div>
                            <div class="col-span-8 space-y-1.5">
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Motivo</label>
                                <input name="reason" type="text" placeholder="Ex: Avaria, não veio..." class="w-full px-4 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-rose-500 focus:ring-2 focus:ring-rose-500/10 outline-none text-sm font-medium">
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-rose-200 active:scale-95 transition-all flex items-center justify-center gap-2 mt-2">
                            <i data-lucide="alert-octagon" class="w-5 h-5"></i> Registrar Pendência
                        </button>
                    </form>
                `;
            }

            // Fallback for simple forms
            if (!content) {
                if (type === 'addBox') content = `<h3 class="text-xl font-bold text-slate-800 mb-4">Nova Caixa</h3><form onsubmit="handleAddBox(event)"><input name="boxName" placeholder="Nome da Caixa" class="w-full rounded-xl border-slate-200 bg-slate-50 p-3 mb-4 outline-none focus:ring-2 focus:ring-indigo-100"><button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Criar</button></form>`;
                else if (type === 'editBox') content = `<h3 class="text-xl font-bold text-slate-800 mb-4">Renomear Caixa</h3><form onsubmit="handleEditBox(event)"><input name="boxName" value="${box.name}" class="w-full rounded-xl border-slate-200 bg-slate-50 p-3 mb-4 outline-none focus:ring-2 focus:ring-indigo-100"><button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Salvar</button></form>`;
                else if (type === 'deleteBox') content = `<div class="text-center"><h3 class="text-xl font-bold text-slate-800 mb-2">Excluir Caixa</h3><p class="text-slate-500 mb-6">Tem certeza? Isso apagará o histórico local desta caixa.</p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-semibold text-slate-600 hover:bg-slate-50">Cancelar</button><button onclick="confirmDeleteBox()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700">Excluir</button></div></div>`;
                else if (type === 'deleteItem') content = `<div class="text-center"><h3 class="text-xl font-bold text-slate-800 mb-2">Remover Item</h3><div class="flex gap-3 mt-6"><button onclick="closeModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-semibold text-slate-600 hover:bg-slate-50">Cancelar</button><button onclick="confirmDeleteItem()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700">Remover</button></div></div>`;
                else if (type === 'editCatalogItem') content = `<h3 class="font-bold mb-4 text-xl">Editar Item do Catálogo</h3><form onsubmit="handleEditCatalogItem(event)" class="space-y-3"><input name="newItemName" value="${escapeHtml(state.catalog[data])}" class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" required><button class="w-full bg-indigo-600 text-white p-3 rounded-xl mt-2 hover:bg-indigo-700 font-bold">Salvar</button></form>`;
                else if (type === 'deleteCatalogItem') content = `<div class="text-center"><h3 class="font-bold text-red-600 text-xl mb-2">Excluir do Catálogo</h3><p class="mb-6 text-slate-500">${state.catalog[data]}</p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 border p-3 rounded-xl font-bold">Cancelar</button><button onclick="confirmDeleteCatalogItem()" class="flex-1 bg-red-600 text-white p-3 rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700">Confirmar</button></div></div>`;
                else if (type === 'editLocation') content = `<h3 class="font-bold mb-4 text-xl">Editar Local</h3><form onsubmit="handleEditDestination(event)" class="space-y-3"><input name="editName" value="${state.destinations[data].name}" class="w-full border p-3 rounded-xl"><input name="editStreet" value="${state.destinations[data].street||''}" placeholder="Rua" class="w-full border p-3 rounded-xl"><div class="flex gap-2"><input name="editNumber" value="${state.destinations[data].number||''}" placeholder="Nº" class="w-1/3 border p-3 rounded-xl"><input name="editNeighborhood" value="${state.destinations[data].neighborhood||''}" placeholder="Bairro" class="w-2/3 border p-3 rounded-xl"></div><button class="w-full bg-indigo-600 text-white p-3 rounded-xl mt-2 font-bold">Salvar</button></form>`;
                else if (type === 'deleteLocation') content = `<div class="text-center"><h3 class="font-bold text-red-600 text-xl mb-2">Excluir Local</h3><p class="mb-6 text-slate-500">${state.destinations[data].name}</p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 border p-3 rounded-xl font-bold">Cancelar</button><button onclick="confirmDeleteLocation()" class="flex-1 bg-red-600 text-white p-3 rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700">Confirmar</button></div></div>`;
                else if (type === 'editDriver') content = `<h3 class="font-bold mb-4 text-xl">Editar Motorista</h3><form onsubmit="handleEditDriver(event)" class="space-y-3"><input name="editDriverName" value="${state.drivers[data].name}" class="w-full border p-3 rounded-xl"><input name="editDriverPhone" value="${state.drivers[data].phone||''}" placeholder="Telefone" class="w-full border p-3 rounded-xl"><button class="w-full bg-indigo-600 text-white p-3 rounded-xl mt-2 font-bold">Salvar</button></form>`;
                else if (type === 'deleteDriver') content = `<div class="text-center"><h3 class="font-bold text-red-600 text-xl mb-2">Excluir Motorista</h3><p class="mb-6 text-slate-500">${state.drivers[data].name}</p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 border p-3 rounded-xl font-bold">Cancelar</button><button onclick="confirmDeleteDriver()" class="flex-1 bg-red-600 text-white p-3 rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700">Confirmar</button></div></div>`;
                else if (type === 'changeDestination') content = `<h3 class="font-bold mb-4 text-xl">Alterar Destino</h3><form onsubmit="handleChangeDestination(event)"><div id="dest-input-group"><select name="destination" class="w-full border p-3 rounded-xl mb-3" onchange="document.getElementById('customDestGroup2').classList.toggle('hidden', this.value !== '')"><option value="" disabled selected>Selecione...</option>${state.destinations.map(d => `<option value="${d.name}">${d.name}</option>`).join('')}<option value="">Outro (Digitar)</option></select><div id="customDestGroup2" class="hidden space-y-3 mb-3"><input name="customName" placeholder="Nome do local" class="w-full border p-3 rounded-xl bg-yellow-50"><input name="customStreet" placeholder="Rua" class="w-full border p-3 rounded-xl text-sm"><div class="flex gap-2"><input name="customNumber" placeholder="Nº" class="w-1/3 border p-3 rounded-xl text-sm"><input name="customNeighborhood" placeholder="Bairro" class="w-2/3 border p-3 rounded-xl text-sm"></div></div></div><button class="w-full bg-indigo-600 text-white p-3 rounded-xl mt-2 font-bold">Salvar</button></form>`;
                else if (type === 'changeDriver') content = `<h3 class="font-bold mb-4 text-xl">Alterar Motorista</h3><form onsubmit="handleChangeDriver(event)"><select name="newDriver" class="w-full border p-3 rounded-xl mb-4"><option value="">Sem motorista</option>${state.drivers.map(d => `<option value="${d.name}">${d.name}</option>`).join('')}</select><button class="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold">Salvar</button></form>`;
                else if (type === 'editMissing') {
                    const mItem = state.missingItems[data];
                    content = `<h3 class="font-bold mb-4 text-xl">Editar Falta</h3><form onsubmit="handleEditMissing(event)" class="space-y-3"><input name="editItemName" value="${mItem.itemName}" class="w-full border p-3 rounded-xl"><input name="editQuantity" type="number" value="${mItem.quantity}" class="w-full border p-3 rounded-xl"><textarea name="editReason" class="w-full border p-3 rounded-xl">${mItem.reason}</textarea><button class="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold">Salvar</button></form>`;
                }
                else if (type === 'deleteMissing') {
                    const mItem = state.missingItems[data];
                    content = `<div class="text-center"><h3 class="font-bold text-red-600 text-xl mb-2">Excluir Registro</h3><p class="mb-6 text-slate-500">${mItem.itemName}</p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 border p-3 rounded-xl font-bold">Cancelar</button><button onclick="confirmDeleteMissing()" class="flex-1 bg-red-600 text-white p-3 rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700">Confirmar</button></div></div>`;
                }
                else if (type === 'confirmImport') content = `<h3 class="font-bold text-xl mb-2 text-orange-600">Restaurar Backup?</h3><p class="text-sm text-slate-600 mb-6">Isso substituirá todos os dados atuais. Tem certeza?</p><div class="flex gap-3"><button onclick="executeImport()" class="flex-1 bg-orange-600 text-white p-3 rounded-xl font-bold">Sim, Restaurar</button><button onclick="closeModal()" class="flex-1 border p-3 rounded-xl font-bold">Cancelar</button></div>`;
                
                if (!content) content = `<h3 class="font-bold text-lg mb-4">Ação Requerida</h3><button onclick="closeModal()" class="bg-indigo-500 text-white px-4 py-2 rounded">Fechar</button>`;
            }

            container.innerHTML = `
                <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div class="glass-panel bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md animate-zoom-in relative ring-1 ring-white/50">
                        <button onclick="closeModal()" class="absolute top-4 right-4 p-1 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                        ${content}
                    </div>
                </div>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- Render Dashboard with New Cards ---
        function renderDashboard() {
            const container = document.getElementById('app-content');
            const totalMissing = state.missingItems.filter(m => m.status === 'pending').length;
            const available = state.boxes.filter(b => b.status === 'available').length;
            const delivering = state.boxes.filter(b => b.status === 'in_delivery').length;
            
            let html = `
            <div class="space-y-8 pb-20">
                <!-- Stats Row -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-2xl shadow-card border border-slate-200 flex flex-col justify-center relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-full bg-gradient-to-l from-slate-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <span class="text-3xl font-bold text-slate-800 tracking-tight">${state.boxes.length}</span>
                        <span class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mt-1">Total de Caixas</span>
                        <div class="w-8 h-1 bg-slate-800 rounded-full mt-3"></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-card border border-slate-200 flex flex-col justify-center">
                        <!-- Alterado para Emerald (Verde) -->
                        <span class="text-3xl font-bold text-emerald-600 tracking-tight">${available}</span>
                        <span class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mt-1">Disponíveis</span>
                        <div class="w-8 h-1 bg-emerald-300 rounded-full mt-3"></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-card border border-slate-200 flex flex-col justify-center">
                        <span class="text-3xl font-bold text-amber-500 tracking-tight">${delivering}</span>
                        <span class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mt-1">Em Trânsito</span>
                        <div class="w-8 h-1 bg-amber-300 rounded-full mt-3"></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-card border border-slate-200 flex flex-col justify-center relative overflow-hidden">
                        ${totalMissing > 0 ? '<div class="absolute -right-2 -top-2 w-16 h-16 bg-rose-50 rounded-full animate-pulse opacity-50"></div>' : ''}
                        <span class="text-3xl font-bold ${totalMissing > 0 ? 'text-rose-600' : 'text-slate-400'} tracking-tight relative z-10">${totalMissing}</span>
                        <span class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mt-1 relative z-10">Pendências</span>
                        <div class="w-8 h-1 ${totalMissing > 0 ? 'bg-rose-500' : 'bg-slate-200'} rounded-full mt-3 relative z-10"></div>
                    </div>
                </div>

                <div class="flex justify-between items-center px-1">
                    <h2 class="text-lg font-bold text-slate-800">Visão Geral</h2>
                    <button onclick="openModal('addBox')" class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-xl font-medium shadow-lg shadow-slate-200 flex items-center gap-2 transition-all active:scale-95 text-sm border border-transparent">
                        <i data-lucide="plus" class="w-4 h-4"></i> <span>Nova Caixa</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-6">`;
            
            state.boxes.forEach((box, index) => {
                const hasIssue = state.missingItems.some(m => m.boxId === box.id && m.status === 'pending');
                const status = (hasIssue && box.status === 'delivered') ? 'issue' : box.status;
                
                // Status Logic
                let statusBadge = '';
                // Alterado: available = verde (emerald), separated = azul (blue)
                if(status === 'available') statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-emerald-50 text-emerald-600 border border-emerald-100"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Disponível</span>`;
                else if(status === 'in_delivery') statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-amber-50 text-amber-600 border border-amber-100"><span class="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></span> Em Trânsito</span>`;
                else if(status === 'delivered') statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-slate-100 text-slate-600 border border-slate-200"><span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span> Entregue</span>`;
                else if(status === 'issue') statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-rose-50 text-rose-600 border border-rose-100"><span class="w-1.5 h-1.5 rounded-full bg-rose-500"></span> Atenção</span>`;
                else if(status === 'separated') statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-blue-50 text-blue-600 border border-blue-100"><span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> Separado</span>`;

                const mappedItems = box.items.map((item, index) => ({...item, originalIndex: index}));
                const internalItems = mappedItems.filter(i => !i.isExternal);
                const externalItems = mappedItems.filter(i => i.isExternal);
                
                // Render List Function
                const renderList = (items, title, isExt) => items.length ? `
                    <div class="mb-3">
                        <p class="text-[9px] font-bold uppercase tracking-widest text-slate-400 mb-2 pl-1 border-b border-slate-100 pb-1">${title}</p>
                        <div class="space-y-0.5">
                        ${items.map((it) => `
                            <div class="flex justify-between items-center text-sm py-1.5 px-1 hover:bg-slate-50 rounded transition-colors group/item">
                                <div class="truncate flex items-center gap-2">
                                    <span class="font-bold text-slate-700 min-w-[1.2rem] text-right text-xs">${it.quantity}</span>
                                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wide border border-slate-200 px-1 rounded">${it.unitType}</span>
                                    <span class="text-slate-600 truncate font-medium text-xs ${isExt?'italic':''}">${escapeHtml(it.name)}</span>
                                </div>
                                <div class="flex gap-1 opacity-0 group-hover/item:opacity-100 transition-opacity">
                                    <button onclick="openModal('editItem', ${box.id}, ${it.originalIndex})" class="text-slate-400 hover:text-indigo-600 p-0.5"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                    <button onclick="openModal('deleteItem', ${box.id}, ${it.originalIndex})" class="text-slate-300 hover:text-rose-500 p-0.5"><i data-lucide="x" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                        `).join('')}
                        </div>
                    </div>` : '';

                // Destination Card Section
                const hasDest = !!box.destination;
                const destInfo = `
                    <div class="bg-slate-50 rounded-xl p-3 border border-slate-100 mb-4 group/dest relative overflow-hidden">
                        ${!hasDest ? 
                            `<div class="flex justify-between items-center text-slate-400 text-sm italic py-1">
                                <div class="flex items-center gap-2"><i data-lucide="map" class="w-4 h-4 opacity-50"></i> Sem destino</div>
                                <button onclick="openModal('changeDestination', ${box.id})" class="text-indigo-600 hover:bg-indigo-50 p-1.5 rounded-lg transition-colors" title="Adicionar Destino"><i data-lucide="plus" class="w-4 h-4"></i></button>
                             </div>` 
                            : 
                            `<div class="flex items-start gap-3">
                                <div class="bg-white p-2 rounded-lg border border-slate-200 shadow-sm text-slate-700 shrink-0 mt-0.5">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i>
                                </div>
                                <div class="min-w-0 flex-grow">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wide mb-0.5">Destino</p>
                                            <p class="font-bold text-slate-800 text-sm leading-tight truncate pr-1" title="${escapeHtml(box.destination)}">${escapeHtml(box.destination)}</p>
                                        </div>
                                        <button onclick="openModal('changeDestination', ${box.id})" class="text-slate-400 hover:text-indigo-600 p-1 rounded transition-colors opacity-0 group-hover/dest:opacity-100" title="Editar Destino"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                    </div>
                                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-slate-100">
                                        <div class="flex items-center gap-1.5 text-xs text-slate-500">
                                            <i data-lucide="user" class="w-3 h-3"></i>
                                            <span class="truncate max-w-[110px]">${escapeHtml(box.driver) || 'Sem motorista'}</span>
                                        </div>
                                        <button onclick="openModal('changeDriver', ${box.id})" class="text-slate-400 hover:text-indigo-600 p-1 rounded transition-colors opacity-0 group-hover/dest:opacity-100" title="Editar Motorista"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                    </div>
                                </div>
                            </div>`
                        }
                    </div>
                `;

                // Main Action Button
                // Botão "Separar" agora é Azul (Blue)
                let mainBtn = '';
                if (status === 'available') mainBtn = `<button onclick="openModal('separate',${box.id})" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-xl text-sm font-bold shadow-md shadow-blue-200 transition-all active:scale-95 flex items-center justify-center gap-2"><i data-lucide="package-check" class="w-4 h-4"></i> Separar</button>`;
                else if (status === 'separated') mainBtn = `<button onclick="openModal('deliver',${box.id})" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-xl text-sm font-bold shadow-md shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center gap-2"><i data-lucide="send" class="w-4 h-4"></i> Enviar</button>`;
                else if (status === 'in_delivery') mainBtn = `<button onclick="openModal('complete',${box.id})" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 rounded-xl text-sm font-bold shadow-md shadow-emerald-200 transition-all active:scale-95 flex items-center justify-center gap-2"><i data-lucide="check" class="w-4 h-4"></i> Receber</button>`;
                else mainBtn = `<button onclick="openModal('reset',${box.id})" class="flex-1 bg-white border border-slate-200 text-slate-600 hover:border-slate-300 hover:text-slate-800 py-2.5 rounded-xl text-sm font-bold transition-all active:scale-95 flex items-center justify-center gap-2">Resetar</button>`;

                html += `
                <div 
                    id="card-${index}"
                    draggable="false"
                    data-index="${index}"
                    ondragstart="handleDragStart(event, ${index})"
                    ondragend="handleDragEnd(event)"
                    ondragover="handleDragOver(event)"
                    ondragenter="handleDragEnter(event)"
                    ondragleave="handleDragLeave(event)"
                    ondrop="handleDrop(event, ${index})"
                    class="group/card-container bg-white rounded-xl shadow-card border border-slate-200 flex flex-col h-full relative overflow-hidden transition-none"
                >
                    <!-- Drag Handle Strip -->
                    <div 
                        class="h-1.5 w-full bg-slate-50 cursor-grab hover:bg-slate-100 transition-colors border-b border-slate-50 rounded-t-xl"
                        onmousedown="enableDrag(event, ${index})"
                        onmouseup="disableDrag(event, ${index})"
                        title="Arraste para reordenar"
                    ></div>

                    <!-- Header -->
                    <div class="px-5 pt-4 pb-2 flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800 leading-tight">${escapeHtml(box.name)}</h3>
                            <div class="mt-1.5">${statusBadge}</div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="printBox(${box.id})" class="p-2 text-slate-300 hover:text-indigo-600 hover:bg-slate-50 rounded-lg transition-colors"><i data-lucide="printer" class="w-4 h-4"></i></button>
                            
                            <!-- Menu Modificado -->
                            <div class="relative">
                                <button onclick="toggleMenu(event, ${box.id})" class="p-2 text-slate-300 hover:text-slate-600 hover:bg-slate-50 rounded-lg transition-colors"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>
                                <div id="menu-${box.id}" class="absolute right-0 top-full mt-1 w-32 bg-white rounded-xl shadow-xl border border-slate-100 p-1 hidden z-50 animate-fade-in">
                                    <button onclick="openModal('editBox', ${box.id})" class="w-full text-left px-3 py-2 text-xs font-medium text-slate-600 hover:bg-slate-50 rounded-lg flex items-center gap-2"><i data-lucide="pencil" class="w-3 h-3"></i> Editar</button>
                                    <button onclick="openModal('deleteBox', ${box.id})" class="w-full text-left px-3 py-2 text-xs font-medium text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2"><i data-lucide="trash" class="w-3 h-3"></i> Excluir</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="px-5 pb-4 flex-grow flex flex-col">
                        ${destInfo}
                        
                        <div class="flex-grow min-h-[100px]">
                            ${box.items.length ? 
                                `<div class="max-h-64 overflow-y-auto pr-1 scrollbar-thin space-y-1">
                                    ${renderList(internalItems, "Conteúdo", false)}
                                    ${renderList(externalItems, "Externo", true)}
                                 </div>` 
                                : 
                                `<div class="h-full flex flex-col items-center justify-center text-slate-300 border-2 border-dashed border-slate-100 rounded-xl min-h-[120px]">
                                    <i data-lucide="box" class="w-8 h-8 mb-2 opacity-50"></i>
                                    <span class="text-xs font-medium">Vazia</span>
                                 </div>`
                            }
                        </div>
                    </div>

                    <!-- Actions Footer -->
                    <div class="p-4 bg-white border-t border-slate-100 rounded-b-xl mt-auto grid grid-cols-[1fr_auto_auto] gap-2">
                        ${mainBtn}
                        <button onclick="openModal('add',${box.id})" class="px-3.5 py-2.5 bg-slate-50 text-slate-600 hover:bg-slate-100 rounded-xl font-bold transition-colors border border-slate-100" title="Adicionar Item">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                        <button onclick="openModal('missing',${box.id})" class="px-3.5 py-2.5 bg-rose-50 text-rose-600 hover:bg-rose-100 rounded-xl font-bold transition-colors border border-rose-50" title="Reportar Problema">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>`;
            });
            container.innerHTML = html + '</div></div>';
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- Render Login (UI Update) ---
        function renderLogin() {
            const container = document.getElementById('login-container');
            const appLayout = document.getElementById('app-layout');
            container.classList.remove('hidden');
            appLayout.classList.add('hidden');
            appLayout.classList.remove('opacity-100');
            container.innerHTML = `
                <div class="bg-white p-10 rounded-3xl shadow-2xl border border-slate-100 w-full max-w-sm animate-zoom-in text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-violet-600"></div>
                    <div class="bg-indigo-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600 shadow-inner">
                        <i data-lucide="lock" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Bem-vindo</h2>
                    <p class="text-slate-500 text-sm mb-8">Digite sua credencial para acessar o painel logístico.</p>
                    <form onsubmit="handleLogin(event)" class="space-y-4">
                        <input type="password" name="password" placeholder="Senha" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3.5 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 text-center tracking-widest text-lg transition-all" autofocus>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center justify-center gap-2">
                            <span>Acessar</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>
            `;
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- Catalog Panel Render ---
        function renderCatalogPanel() {
            const container = document.getElementById('app-content');
            container.innerHTML = `
                <div class="max-w-2xl mx-auto space-y-6 pb-10">
                    <div class="bg-white rounded-xl shadow-card border border-slate-200 p-6">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2 mb-6">
                            <i data-lucide="list" class="text-slate-500"></i> Cadastrar Item no Catálogo
                        </h2>
                        <form onsubmit="handleAddCatalogItem(event)" class="space-y-3">
                            <div class="flex gap-3 items-stretch">
                                <div class="relative flex-grow group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="package-plus" class="h-5 w-5 text-slate-400 group-focus-within:text-slate-600 transition-colors"></i>
                                    </div>
                                    <input name="newItemName" type="text" required placeholder="Digite o nome do novo item..." class="pl-10 block w-full rounded-xl border-slate-200 bg-slate-50 border focus:bg-white focus:border-slate-500 focus:ring-2 focus:ring-slate-100 text-sm p-3.5 transition-all outline-none" autocomplete="off">
                                </div>
                                <button type="submit" class="bg-slate-900 hover:bg-slate-800 text-white px-6 py-2 rounded-xl font-medium shadow-lg shadow-slate-200 transition-all active:scale-95 flex items-center gap-2 whitespace-nowrap">
                                    <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden sm:inline">Cadastrar</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-card border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 bg-slate-50/50 font-semibold text-slate-700 flex flex-col sm:flex-row justify-between items-center gap-3">
                            <div class="flex items-center gap-2 w-full sm:w-auto">
                                <span>Itens Disponíveis (${state.catalog.length})</span>
                                <span class="text-xs font-normal text-slate-500 bg-white px-2 py-1 rounded border border-slate-200">Ordenado A-Z</span>
                            </div>
                            
                            <!-- Search Input -->
                            <div class="relative w-full sm:w-64">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="search" class="h-4 w-4 text-slate-400"></i>
                                </div>
                                <input type="text" id="catalog-search" oninput="filterCatalog()" placeholder="Pesquisar..." class="pl-9 block w-full rounded-lg border-slate-200 bg-white border focus:border-slate-500 focus:ring-2 focus:ring-slate-100 text-xs p-2.5 transition-all outline-none">
                            </div>
                        </div>

                        <div id="catalog-list-container" class="divide-y divide-slate-50 max-h-[60vh] overflow-y-auto">
                            ${state.catalog.length ? state.catalog.map((item, i) => `
                                <div class="catalog-item p-4 flex justify-between items-center group hover:bg-slate-50 transition-colors" data-name="${escapeHtml(item)}">
                                    <div class="flex gap-3 items-center">
                                        <div class="bg-slate-100 p-2 rounded-lg text-slate-500">
                                            <i data-lucide="tag" class="w-4 h-4"></i>
                                        </div>
                                        <div class="font-medium text-slate-700 item-name-text">${escapeHtml(item)}</div>
                                    </div>
                                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="openModal('editCatalogItem', null, ${i})" class="text-slate-400 hover:text-blue-600 p-2 rounded hover:bg-slate-100 transition-colors" title="Editar">
                                            <i data-lucide="pencil" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="openModal('deleteCatalogItem', null, ${i})" class="text-slate-300 hover:text-red-500 p-2 rounded hover:bg-red-50 transition-colors" title="Remover">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('') : '<p class="p-8 text-center text-slate-400 italic">O catálogo está vazio.</p>'}
                            
                            <!-- No results message (hidden by default) -->
                            <div id="no-results-msg" class="hidden p-8 text-center text-slate-400 italic">Nenhum item encontrado.</div>
                        </div>
                    </div>
                </div>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function filterCatalog() {
            const input = document.getElementById('catalog-search');
            const filter = input.value.toLowerCase();
            const items = document.querySelectorAll('.catalog-item');
            let hasVisible = false;

            items.forEach(item => {
                const name = item.getAttribute('data-name').toLowerCase();
                if (name.includes(filter)) {
                    item.classList.remove('hidden');
                    item.classList.add('flex');
                    hasVisible = true;
                } else {
                    item.classList.add('hidden');
                    item.classList.remove('flex');
                }
            });

            const noResults = document.getElementById('no-results-msg');
            if(noResults) {
                if(!hasVisible && items.length > 0) noResults.classList.remove('hidden');
                else noResults.classList.add('hidden');
            }
        }

        function renderHistory() {
            const container = document.getElementById('app-content');
            const search = state.historyFilter.search.toLowerCase();
            const dateFilter = state.historyFilter.date;
            
            const filtered = state.history.filter(l => {
                const txt = (l.action + l.details + l.boxName + l.user).toLowerCase();
                const logDate = getLocalDateString(l.timestamp);
                return (!search || txt.includes(search)) && (!dateFilter || logDate === dateFilter);
            });
            
            const todayPT = getLocalDateString(new Date().toISOString());
            const renderTimelineItem = (l) => {
                let icon='circle', color='bg-slate-100 text-slate-500 border-slate-200';
                if(l.action === 'Saída') { icon='truck'; color='bg-amber-50 text-amber-600 border-amber-100'; }
                else if(l.action === 'Entrega') { icon='check'; color='bg-slate-100 text-slate-600 border-slate-200'; } // Changed to slate for delivery
                else if(l.action === 'Falta') { icon='alert-triangle'; color='bg-rose-50 text-rose-600 border-rose-100'; }
                else if(l.action === 'Adição') { icon='plus'; color='bg-blue-50 text-blue-600 border-blue-100'; }
                else if(l.action === 'Exclusão') { icon='trash-2'; color='bg-rose-50 text-rose-600 border-rose-100'; }
                else if(l.action === 'Alteração') { icon='pencil'; color='bg-indigo-50 text-indigo-600 border-indigo-100'; }
                else if(l.action === 'Separação') { icon='package-check'; color='bg-violet-50 text-violet-600 border-violet-100'; }
                
                let printBtn = l.action === 'Saída' ? `<button onclick="printHistoryManifest(${l.id})" class="ml-auto text-xs flex items-center gap-1 text-slate-400 hover:text-blue-600 bg-white border border-slate-200 hover:border-blue-300 px-2 py-1 rounded-md transition-colors"><i data-lucide="printer" class="w-3 h-3"></i> Imprimir</button>` : '';
                const time = new Date(l.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                
                return `<div class="timeline-item relative pl-14 py-2 group"><div class="timeline-line group-last:hidden"></div><div class="absolute left-0 top-2 w-12 h-12 flex items-center justify-center z-10"><div class="w-10 h-10 rounded-full border-2 ${color} flex items-center justify-center shadow-sm bg-white"><i data-lucide="${icon}" class="w-5 h-5"></i></div></div><div class="bg-white border border-slate-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-all hover:border-slate-200"><div class="flex justify-between items-start mb-1"><div class="flex flex-col"><span class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-0.5">${time} • ${escapeHtml(l.user)}</span><h4 class="text-base font-bold text-slate-800 flex items-center gap-2">${escapeHtml(l.action)} <span class="font-normal text-slate-500">em</span> <span class="text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded text-sm font-semibold">${escapeHtml(l.boxName)}</span></h4></div>${printBtn}</div><div class="text-sm text-slate-600 mt-2 p-3 bg-slate-50/50 rounded-lg border border-slate-50 whitespace-pre-wrap leading-relaxed">${escapeHtml(l.details)}</div></div></div>`;
            };

            let contentHtml = '';
            if (state.historyView === 'today') {
                const todaysLogs = filtered.filter(l => getLocalDateString(l.timestamp) === todayPT);
                contentHtml = `<div class="flex-grow overflow-hidden flex flex-col bg-white rounded-xl shadow-card border border-slate-200"><div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center"><span class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> Hoje (${new Date().toLocaleDateString()})</span><span class="text-xs font-medium bg-slate-200 text-slate-700 px-2 py-1 rounded-full">${todaysLogs.length} Registos</span></div><div class="overflow-y-auto flex-grow p-6 bg-[#f8fafc] scroll-smooth"><div class="max-w-3xl mx-auto space-y-1">${todaysLogs.length ? todaysLogs.map(renderTimelineItem).join('') : `<div class="flex flex-col items-center justify-center h-64 text-slate-400"><div class="bg-slate-100 p-4 rounded-full mb-3"><i data-lucide="clock" class="w-8 h-8 opacity-50"></i></div><p>Nenhuma atividade registada hoje.</p></div>`}</div></div></div>`;
            } else {
                const archiveLogs = filtered.filter(l => getLocalDateString(l.timestamp) !== todayPT);
                const grouped = {};
                archiveLogs.forEach(l => {
                    const d = new Date(l.timestamp).toLocaleDateString('pt-BR');
                    if(!grouped[d]) grouped[d] = [];
                    grouped[d].push(l);
                });
                const dates = Object.keys(grouped).sort((a,b) => {
                    const [da, ma, ya] = a.split('/'); const [db, mb, yb] = b.split('/');
                    return new Date(yb, mb-1, db) - new Date(ya, ma-1, da);
                });
                
                const listHtml = dates.map(date => {
                    const isExpanded = state.expandedDate === date;
                    const chevron = isExpanded ? 'chevron-up' : 'chevron-down';
                    let expandedContent = '';
                    if (isExpanded) {
                        expandedContent = `<div class="border-t border-slate-100 bg-slate-50/50 p-6"><div class="max-w-3xl mx-auto">${grouped[date].map(renderTimelineItem).join('')}</div></div>`;
                    }
                          
                    return `<div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm transition-all hover:shadow-md mb-3"><button onclick="toggleDateAccordion('${date}')" class="w-full px-5 py-4 flex justify-between items-center bg-white hover:bg-slate-50 transition-colors group"><div class="flex items-center gap-3"><div class="bg-slate-100 text-slate-600 p-2 rounded-lg group-hover:bg-slate-800 group-hover:text-white transition-colors"><i data-lucide="calendar-days" class="w-5 h-5"></i></div><span class="font-bold text-slate-700 text-lg">${date}</span></div><div class="flex items-center gap-3"><span class="text-xs font-bold bg-slate-100 text-slate-500 px-2.5 py-1 rounded-full">${grouped[date].length} eventos</span><i data-lucide="${chevron}" class="w-5 h-5 text-slate-400"></i></div></button>${expandedContent}</div>`;
                }).join('');

                const emptyState = !dates.length ? 
                    `<div class="flex flex-col items-center justify-center h-64 text-slate-400">
                        <i data-lucide="archive-restore" class="w-12 h-12 mb-3 opacity-20"></i>
                        <p>Nenhum registo anterior encontrado.</p>
                     </div>` : '';

                contentHtml = `
                <div class="flex-grow overflow-hidden flex flex-col bg-white rounded-xl shadow-card border border-slate-200">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="archive" class="w-4 h-4"></i> Arquivo Histórico
                    </div>
                    <div class="overflow-y-auto flex-grow p-4 space-y-4 bg-[#f8fafc]">
                        ${listHtml}
                        ${emptyState}
                    </div>
                </div>`;
            }

            container.innerHTML = `<div class="flex flex-col h-full overflow-hidden pb-4"><div class="flex flex-col md:flex-row gap-4 mb-6 shrink-0 justify-between items-center"><div class="bg-slate-200 p-1 rounded-xl flex gap-1 w-full md:w-auto"><button onclick="setHistoryView('today')" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-2.5 rounded-lg text-sm font-bold transition-all ${state.historyView==='today'?'bg-white text-slate-800 shadow-sm':'text-slate-500 hover:text-slate-700 hover:bg-slate-300/50'}"><i data-lucide="sun" class="w-4 h-4"></i> Hoje</button><button onclick="setHistoryView('archive')" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-2.5 rounded-lg text-sm font-bold transition-all ${state.historyView==='archive'?'bg-white text-slate-800 shadow-sm':'text-slate-500 hover:text-slate-700 hover:bg-slate-300/50'}"><i data-lucide="history" class="w-4 h-4"></i> Arquivo</button></div><div class="flex gap-2 w-full md:w-auto bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm"><div class="relative flex-grow md:w-64"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i><input type="text" placeholder="Filtrar eventos..." value="${escapeHtml(state.historyFilter.search)}" oninput="handleHistoryFilter('search', this.value)" class="w-full pl-9 pr-3 py-2 text-sm bg-transparent outline-none text-slate-700 placeholder:text-slate-400"></div><div class="w-px bg-slate-200 my-1"></div><input type="date" value="${state.historyFilter.date}" onchange="handleHistoryFilter('date', this.value)" class="bg-transparent text-sm text-slate-600 px-2 outline-none font-medium cursor-pointer hover:text-blue-600">${(state.historyFilter.search || state.historyFilter.date) ? `<button onclick="clearHistoryFilters()" class="text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg text-xs font-bold uppercase transition-colors border border-transparent hover:border-red-100 flex items-center gap-1"><i data-lucide="x" class="w-3 h-3"></i></button>` : ''}</div></div>${contentHtml}</div>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderLocationsPanel() {
            const container = document.getElementById('app-content');
            container.innerHTML = `<div class="max-w-2xl mx-auto space-y-6 pb-10"><div class="bg-white rounded-xl shadow-card border border-slate-200 p-6"><h2 class="text-xl font-bold text-slate-800 flex items-center gap-2 mb-6"><i data-lucide="map-pin" class="text-slate-500"></i> Cadastrar Endereço</h2><form onsubmit="handleAddDestination(event)" class="space-y-3"><input name="newName" type="text" required placeholder="Nome do Local" class="w-full border border-slate-200 bg-slate-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-slate-200 focus:bg-white transition-all"><div class="grid grid-cols-3 gap-3"><div class="col-span-2"><input name="newStreet" type="text" placeholder="Rua" class="w-full border border-slate-200 bg-slate-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-slate-200 focus:bg-white transition-all"></div><div><input name="newNumber" type="text" placeholder="Nº" class="w-full border border-slate-200 bg-slate-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-slate-200 focus:bg-white transition-all"></div></div><input name="newNeighborhood" type="text" placeholder="Bairro" class="w-full border border-slate-200 bg-slate-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-slate-200 focus:bg-white transition-all"><button type="submit" class="w-full bg-slate-900 text-white px-4 py-3 rounded-xl hover:bg-slate-800 flex items-center justify-center gap-2 font-bold shadow-lg shadow-slate-200 active:scale-95 transition-all"><i data-lucide="plus" class="w-4 h-4"></i> Cadastrar</button></form></div><div class="bg-white rounded-xl shadow-card border border-slate-200 overflow-hidden"><div class="p-4 border-b border-slate-100 bg-slate-50/50 font-semibold text-slate-700">Locais Cadastrados (${state.destinations.length})</div><div class="divide-y divide-slate-50">${state.destinations.length ? state.destinations.map((d, i) => `<div class="p-4 flex justify-between items-start group hover:bg-slate-50 transition-colors"><div class="flex gap-3"><div class="bg-slate-100 p-2 rounded-lg text-slate-600 mt-1"><i data-lucide="building-2" class="w-4 h-4"></i></div><div><div class="font-medium text-slate-700">${escapeHtml(d.name)}</div><div class="text-xs text-slate-400">${escapeHtml(d.street)||''} ${escapeHtml(d.number)||''} ${escapeHtml(d.neighborhood)||''}</div></div></div><div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openModal('editLocation',null,${i})" class="text-slate-400 hover:text-blue-600 p-2 hover:bg-slate-100 rounded-lg transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="openModal('deleteLocation',null,${i})" class="text-slate-300 hover:text-red-500 p-2 hover:bg-red-50 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`).join('') : '<p class="p-6 text-center text-slate-300">Nenhum local cadastrado.</p>'}</div></div></div>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderDriversPanel() {
            const container = document.getElementById('app-content');
            container.innerHTML = `<div class="max-w-2xl mx-auto space-y-6 pb-10"><div class="bg-white rounded-xl shadow-card border border-slate-200 p-6"><h2 class="text-xl font-bold text-slate-800 flex items-center gap-2 mb-6"><i data-lucide="users" class="text-slate-500"></i> Cadastrar Motorista</h2><form onsubmit="handleAddDriver(event)" class="space-y-3"><div class="flex flex-col gap-3"><input name="newDriverName" type="text" required placeholder="Nome do Motorista" class="w-full border border-slate-200 bg-slate-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-slate-200 focus:bg-white transition-all"><div class="flex gap-3"><input name="newDriverPhone" type="text" placeholder="Telefone" class="flex-1 border border-slate-200 bg-slate-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-slate-200 focus:bg-white transition-all"><button type="submit" class="bg-slate-900 text-white px-6 py-3 rounded-xl hover:bg-slate-800 flex items-center justify-center gap-2 font-bold shadow-lg shadow-slate-200 active:scale-95 transition-all"><i data-lucide="plus" class="w-4 h-4"></i> Cadastrar</button></div></div></form></div><div class="bg-white rounded-xl shadow-card border border-slate-200 overflow-hidden"><div class="p-4 border-b border-slate-100 bg-slate-50/50 font-semibold text-slate-700">Motoristas Cadastrados (${state.drivers.length})</div><div class="divide-y divide-slate-50">${state.drivers.length ? state.drivers.map((d, i) => `<div class="p-4 flex justify-between items-center group hover:bg-slate-50 transition-colors"><div class="flex gap-3 items-center"><div class="bg-slate-100 p-2 rounded-lg text-slate-600"><i data-lucide="user" class="w-4 h-4"></i></div><div><div class="font-medium text-slate-700">${escapeHtml(d.name)}</div><div class="text-xs text-slate-400">${escapeHtml(d.phone) || 'Sem telefone'}</div></div></div><div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openModal('editDriver',null,${i})" class="text-slate-400 hover:text-blue-600 p-2 hover:bg-slate-100 rounded-lg transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="openModal('deleteDriver',null,${i})" class="text-slate-300 hover:text-red-500 p-2 hover:bg-red-50 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`).join('') : '<p class="p-6 text-center text-slate-300">Nenhum motorista cadastrado.</p>'}</div></div></div>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderMissingPanel() {
            const container = document.getElementById('app-content');
            
            const total = state.missingItems.length;
            const pendingList = state.missingItems.filter(i => i.status === 'pending');
            const resolvedList = state.missingItems.filter(i => i.status === 'resolved');
            const pendingCount = pendingList.length;
            const resolvedCount = resolvedList.length;

            let activeList = state.missingTab === 'resolved' ? resolvedList : pendingList;
            const isPendingTab = state.missingTab !== 'resolved';

            if (!isPendingTab && state.missingDateFilter) {
                activeList = activeList.filter(item => getLocalDateString(item.date) === state.missingDateFilter);
            }

            const grouped = {};
            activeList.forEach((item, index) => {
                const realIndex = state.missingItems.findIndex(i => i === item);
                if (!grouped[item.boxId]) {
                    grouped[item.boxId] = {
                        boxName: item.boxName,
                        destination: item.destination,
                        items: []
                    };
                }
                grouped[item.boxId].items.push({ ...item, originalIndex: realIndex });
            });

            let contentHtml = '';
            
            if (activeList.length === 0) {
                const emptyMessage = !isPendingTab && state.missingDateFilter 
                    ? `Nenhum registo encontrado para a data ${state.missingDateFilter.split('-').reverse().join('/')}.`
                    : (isPendingTab ? 'Nenhuma pendência registrada.' : 'Nenhum item resolvido ainda.');

                contentHtml = `
                    <div class="flex flex-col items-center justify-center h-64 text-slate-400 animate-fade-in bg-white rounded-xl border border-slate-200 mt-6 shadow-card">
                        <div class="bg-slate-50 p-4 rounded-full mb-3 ring-1 ring-slate-100">
                            <i data-lucide="${isPendingTab ? 'check-circle' : 'archive'}" class="w-10 h-10 ${isPendingTab ? 'text-emerald-400' : 'text-slate-300'}"></i>
                        </div>
                        <h3 class="text-base font-bold text-slate-700">${isPendingTab ? 'Tudo em Ordem!' : 'Arquivo Vazio'}</h3>
                        <p class="text-sm">${emptyMessage}</p>
                        ${!isPendingTab && state.missingDateFilter ? `<button onclick="setMissingDateFilter('')" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-medium">Limpar Filtro</button>` : ''}
                    </div>`;
            } else {
                contentHtml = Object.values(grouped).map(group => {
                    const groupItemsHtml = group.items.map(m => {
                        const isResolved = m.status === 'resolved';
                        const statusColor = isResolved ? 'bg-emerald-50 text-emerald-700 border-l-4 border-emerald-400' : 'bg-rose-50 text-rose-700 border-l-4 border-rose-400';
                        const statusLabel = isResolved ? 'Resolvido' : 'Pendente';

                        return `
                            <div class="p-4 flex flex-col sm:flex-row gap-4 items-start sm:items-center hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0">
                                <div class="flex-grow pl-2 ${isResolved ? 'border-l-4 border-emerald-400' : 'border-l-4 border-rose-400'}">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded">${new Date(m.date).toLocaleDateString()}</span>
                                        <span class="font-bold text-slate-800">${m.quantity}x ${escapeHtml(m.itemName)}</span>
                                    </div>
                                    ${m.reason ? `<p class="text-sm text-slate-500 italic flex items-start gap-1"><i data-lucide="message-square" class="w-3 h-3 mt-1 shrink-0 opacity-50"></i> ${escapeHtml(m.reason)}</p>` : ''}
                                </div>
                                
                                <div class="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-end">
                                    <span class="px-2.5 py-1 rounded-full text-xs font-bold ${isResolved ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}">
                                        ${statusLabel}
                                    </span>

                                    <div class="flex items-center gap-1">
                                        ${!isResolved ? `
                                            <button onclick="resolveMissingItem(${m.id})" class="p-1.5 text-emerald-500 hover:text-emerald-700 hover:bg-emerald-50 rounded-lg transition-all active:scale-95" title="Resolver">
                                                <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                                            </button>
                                        ` : ''}
                                        <button onclick="openModal('editMissing', null, ${m.originalIndex})" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-slate-100 rounded-lg transition-colors" title="Editar">
                                            <i data-lucide="pencil" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="openModal('deleteMissing', null, ${m.originalIndex})" class="p-1.5 text-slate-300 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors" title="Excluir">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    return `
                        <div class="bg-white rounded-xl shadow-card border border-slate-200 overflow-hidden mb-6 animate-fade-in">
                            <div class="bg-slate-50/80 border-b border-slate-200 p-4 flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="bg-white p-2 rounded-lg border border-slate-200 shadow-sm text-slate-700">
                                        <i data-lucide="package" class="w-5 h-5"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-slate-800 text-lg leading-tight">${escapeHtml(group.boxName)}</h3>
                                        <p class="text-xs text-slate-500 flex items-center gap-1">
                                            <i data-lucide="map-pin" class="w-3 h-3"></i> ${escapeHtml(group.destination)}
                                        </p>
                                    </div>
                                </div>
                                <button onclick="printSingleBoxMissing(${group.items[0].boxId})" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors border border-transparent hover:border-blue-200" title="Imprimir esta caixa">
                                    <i data-lucide="printer" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="divide-y divide-slate-100">
                                ${groupItemsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            container.innerHTML = `
                <div class="max-w-4xl mx-auto pb-10 space-y-6 animate-fade-in">
                    <!-- Cards de Estatísticas e Filtros -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-card flex items-center gap-4 relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-24 h-full bg-gradient-to-l from-slate-50 to-transparent opacity-50"></div>
                            <div class="p-3 bg-slate-100 text-slate-600 rounded-xl"><i data-lucide="list" class="w-6 h-6"></i></div>
                            <div><div class="text-3xl font-bold text-slate-800 tracking-tight">${total}</div><div class="text-xs text-slate-500 font-bold uppercase tracking-wider">Total Registros</div></div>
                        </div>
                        <button onclick="setMissingTab('pending')" class="text-left bg-white p-5 rounded-2xl border ${isPendingTab ? 'border-rose-200 ring-1 ring-rose-100' : 'border-slate-200'} shadow-card flex items-center gap-4 relative overflow-hidden transition-all hover:shadow-lg group">
                            <div class="absolute right-0 top-0 w-24 h-full bg-gradient-to-l from-rose-50 to-transparent opacity-50"></div>
                            <div class="p-3 ${isPendingTab ? 'bg-rose-100 text-rose-600' : 'bg-slate-100 text-slate-400 group-hover:bg-rose-50 group-hover:text-rose-500'} rounded-xl transition-colors"><i data-lucide="alert-octagon" class="w-6 h-6"></i></div>
                            <div><div class="text-3xl font-bold ${isPendingTab ? 'text-rose-600' : 'text-slate-600'} tracking-tight">${pendingCount}</div><div class="text-xs ${isPendingTab ? 'text-rose-500' : 'text-slate-400'} font-bold uppercase tracking-wider">Pendentes</div></div>
                        </button>
                        <button onclick="setMissingTab('resolved')" class="text-left bg-white p-5 rounded-2xl border ${!isPendingTab ? 'border-emerald-200 ring-1 ring-emerald-100' : 'border-slate-200'} shadow-card flex items-center gap-4 relative overflow-hidden transition-all hover:shadow-lg group">
                            <div class="absolute right-0 top-0 w-24 h-full bg-gradient-to-l from-emerald-50 to-transparent opacity-50"></div>
                            <div class="p-3 ${!isPendingTab ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400 group-hover:bg-emerald-50 group-hover:text-emerald-500'} rounded-xl transition-colors"><i data-lucide="archive" class="w-6 h-6"></i></div>
                            <div><div class="text-3xl font-bold ${!isPendingTab ? 'text-emerald-600' : 'text-slate-600'} tracking-tight">${resolvedCount}</div><div class="text-xs ${!isPendingTab ? 'text-emerald-500' : 'text-slate-400'} font-bold uppercase tracking-wider">Resolvidos</div></div>
                        </button>
                    </div>

                    <!-- Toolbar -->
                    <div class="flex flex-col sm:flex-row justify-between items-center bg-white p-2 rounded-xl border border-slate-200 shadow-sm gap-4 sticky top-0 z-20">
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <div class="flex gap-1 bg-slate-100 p-1 rounded-lg w-full sm:w-auto">
                                <button onclick="setMissingTab('pending')" class="flex-1 sm:flex-none px-4 py-2 rounded-md text-sm font-bold transition-all ${isPendingTab ? 'bg-white text-rose-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">Pendências</button>
                                <button onclick="setMissingTab('resolved')" class="flex-1 sm:flex-none px-4 py-2 rounded-md text-sm font-bold transition-all ${!isPendingTab ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">Arquivo</button>
                            </div>

                            <!-- Filtro de Data (Apenas no Arquivo) -->
                            ${!isPendingTab ? `
                                <div class="relative flex items-center group">
                                    <div class="absolute left-3 pointer-events-none text-slate-400"><i data-lucide="calendar" class="w-4 h-4"></i></div>
                                    <input type="date" value="${state.missingDateFilter}" onchange="setMissingDateFilter(this.value)" class="pl-9 pr-3 py-2 rounded-lg border border-slate-200 text-sm text-slate-600 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all cursor-pointer hover:border-emerald-300" title="Filtrar por data">
                                    ${state.missingDateFilter ? `<button onclick="setMissingDateFilter('')" class="ml-2 text-slate-400 hover:text-red-500" title="Limpar filtro"><i data-lucide="x" class="w-4 h-4"></i></button>` : ''}
                                </div>
                            ` : ''}
                        </div>

                        <button onclick="printMissingItems()" class="w-full sm:w-auto flex items-center justify-center gap-2 text-sm font-bold text-slate-600 hover:text-blue-700 bg-white hover:bg-slate-50 px-4 py-2 rounded-lg transition-all border border-transparent hover:border-blue-200">
                            <i data-lucide="printer" class="w-4 h-4"></i> Imprimir Relatório
                        </button>
                    </div>

                    <!-- Lista de Itens Agrupada -->
                    <div class="space-y-6">
                        ${contentHtml}
                    </div>
                </div>
            `;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- Render Nav Function ---
        function renderNav() {
            const pending = state.missingItems.filter(m => m.status === 'pending').length;
            const navItems = [
                { id: 'dashboard', label: 'Caixas', icon: 'box' }, 
                { id: 'catalog', label: 'Catálogo', icon: 'list' },
                { id: 'locations', label: 'Endereços', icon: 'map-pin' }, 
                { id: 'drivers', label: 'Motoristas', icon: 'users' }, 
                { id: 'missing', label: 'Faltas', icon: 'alert-triangle', badge: pending }, 
                { id: 'history', label: 'Histórico', icon: 'clock' }, 
                { id: 'settings', label: 'Configurações', icon: 'settings' }
            ];
            
            const sidebarHtml = navItems.map(item => {
                const isActive = state.activeTab === item.id;
                const collapsed = state.sidebarCollapsed;
                const baseClass = `w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all group ${isActive ? 'bg-slate-900 text-white shadow-md shadow-slate-200' : 'text-slate-500 hover:bg-slate-100 hover:text-slate-900'} ${collapsed ? 'justify-center px-0' : ''}`;
                const iconClass = isActive ? 'text-white' : 'text-slate-400 group-hover:text-slate-600';
                return `<button onclick="switchTab('${item.id}')" class="${baseClass}" title="${collapsed ? item.label : ''}"><div class="relative"><i data-lucide="${item.icon}" class="w-5 h-5 ${iconClass}"></i>${collapsed && item.badge > 0 ? `<span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border border-white"></span>` : ''}</div>${!collapsed ? `<span class="flex-grow text-left truncate">${item.label}</span>${item.badge > 0 ? `<span class="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md">${item.badge}</span>` : ''}${isActive ? `<div class="w-1.5 h-1.5 rounded-full bg-blue-600 shrink-0"></div>` : ''}` : ''}</button>`;
            }).join('');
            
            document.getElementById('sidebar-nav').innerHTML = sidebarHtml;
            
            const userFooter = document.getElementById('sidebar-footer');
            if (userFooter) {
                if (state.sidebarCollapsed) { 
                    userFooter.innerHTML = `<button onclick="logout()" class="w-full flex items-center justify-center text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors" title="Sair"><i data-lucide="log-out" class="w-5 h-5"></i></button>`; 
                } else { 
                    userFooter.innerHTML = `<div class="flex items-center gap-3 mb-3 px-2"><div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 font-bold border border-slate-300 shrink-0"><i data-lucide="user" class="w-4 h-4"></i></div><div class="overflow-hidden"><p class="text-sm font-bold text-slate-700 truncate">${state.currentUser}</p><p class="text-xs text-slate-400 truncate">Operador Logístico</p></div></div><button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-sm text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors border border-transparent hover:border-red-100"><i data-lucide="log-out" class="w-4 h-4"></i> Sair do Sistema</button>`; 
                }
            }
            
            const mobileHtml = navItems.map(item => {
                const isActive = state.activeTab === item.id;
                const baseClass = `flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors flex-shrink-0 ${isActive ? 'bg-slate-900 text-white shadow-sm' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`;
                return `<button onclick="switchTab('${item.id}')" class="${baseClass}">${item.label}${item.badge > 0 ? `<span class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-1">${item.badge}</span>` : ''}</button>`;
            }).join('');
            
            document.getElementById('mobile-nav').innerHTML = mobileHtml;
        }

        function renderSettingsPanel() {
            const container = document.getElementById('app-content');
            container.innerHTML = `<div class="max-w-xl mx-auto mt-10"><div class="bg-white p-8 rounded-2xl shadow-card border border-slate-200 text-center"><h2 class="text-2xl font-bold text-slate-800 mb-6">Backup de Dados</h2><div class="grid grid-cols-2 gap-4"><button onclick="handleExportBackup()" class="bg-slate-50 text-slate-600 py-4 rounded-xl font-bold border border-slate-200 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-colors flex flex-col items-center justify-center gap-2"><i data-lucide="download" class="w-6 h-6"></i> Exportar</button><label class="bg-slate-50 text-slate-600 py-4 rounded-xl font-bold border border-slate-200 hover:bg-amber-50 hover:text-amber-600 hover:border-amber-200 transition-colors flex flex-col items-center justify-center gap-2 cursor-pointer"><i data-lucide="upload" class="w-6 h-6"></i> Importar<input type="file" class="hidden" onchange="handleImportBackup(event)"></label></div></div></div>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- Initialization & Core Functions ---

        function switchTab(tab) { state.activeTab = tab; saveData(); }
        function openModal(type, boxId, data = null) { state.modal = { type, boxId, data }; renderModal(); }
        function closeModal() { state.modal = { type: null, boxId: null, data: null }; document.getElementById('modal-container').innerHTML = ''; renderApp(); }

        function renderApp() {
            try {
                // Remove loading screen
                const loader = document.getElementById('loading-screen');
                if(loader) loader.classList.add('hidden');

                if (!state.isLoggedIn) { renderLogin(); return; }
                document.getElementById('login-container').classList.add('hidden');
                const appLayout = document.getElementById('app-layout');
                appLayout.classList.remove('hidden');
                setTimeout(() => appLayout.classList.add('opacity-100'), 50);

                const sidebar = document.getElementById('main-sidebar');
                const logoContent = document.getElementById('sidebar-logo-content');
                const navLabel = document.getElementById('nav-label'); // Added

                if (sidebar) {
                    if (state.sidebarCollapsed) { 
                        sidebar.classList.remove('w-64'); 
                        sidebar.classList.add('w-20'); 
                        if(logoContent) {
                            logoContent.classList.add('hidden'); 
                            logoContent.classList.remove('flex');
                        }
                        if(navLabel) navLabel.classList.add('hidden'); 
                    } 
                    else { 
                        sidebar.classList.remove('w-20'); 
                        sidebar.classList.add('w-64'); 
                        if(logoContent) {
                            logoContent.classList.remove('hidden');
                            logoContent.classList.add('flex');
                        }
                        if(navLabel) navLabel.classList.remove('hidden');
                    }
                }

                renderNav();
                if (state.activeTab === 'dashboard') renderDashboard();
                else if (state.activeTab === 'catalog') renderCatalogPanel();
                else if (state.activeTab === 'locations') renderLocationsPanel();
                else if (state.activeTab === 'drivers') renderDriversPanel();
                else if (state.activeTab === 'missing') renderMissingPanel();
                else if (state.activeTab === 'history') renderHistory();
                else if (state.activeTab === 'settings') renderSettingsPanel();
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (e) {
                console.error("Render Error:", e);
                document.body.innerHTML = `<div class="p-10 text-center"><h1 class="text-xl font-bold text-red-600">Erro na Aplicação</h1><p class="text-slate-600 mt-2">Um erro impediu o carregamento: ${e.message}</p><button onclick="localStorage.clear();location.reload()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded">Resetar Dados</button></div>`;
            }
        }

        // --- Init Listeners ---
        window.addEventListener('click', (e) => {
            const list = document.getElementById('suggestions-list');
            const input = document.querySelector('input[name="itemName"]');
            
            // Close suggestions
            if (list && input && !list.contains(e.target) && e.target !== input) {
                list.classList.add('hidden');
            }

            // Close all menus if clicking outside
            if (!e.target.closest('[onclick*="toggleMenu"]')) {
                document.querySelectorAll('[id^="menu-"]').forEach(el => el.classList.add('hidden'));
            }
        });

        window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && state.modal.type) closeModal(); });
        
        // Robust Loader
        window.addEventListener('load', () => { 
            if(typeof lucide !== 'undefined') {
                renderApp(); 
            } else { 
                const script = document.createElement('script');
                script.src = "https://unpkg.com/lucide@latest";
                script.onload = renderApp;
                document.head.appendChild(script);
                // Fallback interval
                const interval = setInterval(() => { 
                    if(typeof lucide !== 'undefined') { 
                        clearInterval(interval); 
                        renderApp(); 
                    } 
                }, 200); 
            } 
        });
    </script>
</body>
</html>
